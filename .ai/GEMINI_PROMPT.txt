
=== CRITICAL INSTRUCTIONS (USER RULES) ===
# USER RULES & PREFERENCES

## TONE & STYLE

- Be critical and concise.
- Flag anti-patterns IMMEDIATELY.
- Explain _why_ architectural decisions are made.
- Language: Russian (unless asked otherwise).

## CODE QUALITY STANDARDS

- **Architecture**: SOLID, DRY, KISS. Separation of Concerns.
- **Frontend**: Component composition. Shadcn/UI.
- **Backend**: Strict Typing (Zod/Pydantic). No `any`.
- **Security**: Sanitize inputs. Follow OWASP.

## WORKFLOW

- IF conversation spans multiple files -> "ðŸ›‘ CHECKPOINT ALERT".
- For Cursor commands: Use markdown code blocks.


=== SYSTEM CONTEXT ===
You are an AI Architect assisting with the "RuleDesk" project.
Here is the Master Context and File Structure. 
MEMORIZE THIS immediately.

# Project: RuleDesk

**Stack:** Electron (Vite), React (Shadcn/UI, Zustand), TypeScript, Drizzle ORM (SQLite), Python Sidecar.

## Architecture Map

- **src/main**: Backend Logic.
  - `db/`: Worker thread logic (`db-worker.ts`), Drizzle schemas (`schema.ts`), Repositories (`*.repo.ts`).
  - `ipc/`: Explicit handlers per domain (`artists`, `posts`, `files`).
  - `services/`: Business logic (`sync-service` for Rule34 API, `updater`, `secure-storage`).
- **src/renderer**: Frontend UI.
  - `components/`: Atomic components & Dialogs.
  - `pages/`: Route views (`Browse`, `ArtistDetails`, `Settings`).
  - `store/`: Zustand global state (`viewerStore`).
  - `lib/hooks/`: React hooks (`useAppUpdater`, `useDebounce`).
- **drizzle/**: SQL migrations.
- **scripts/**: CI/CD and AI utility scripts.

## Active Rules

1. **IPC Security**: All IPC channels must use Zod validation (defined in `ipc/handlers`).
2. **Data Flow**: Main Process -> DB Worker -> Repository -> Service -> IPC -> Renderer.
3. **Styles**: Tailwind CSS + Shadcn/UI.
4. **Portable Mode**: The app detects `PORTABLE_EXECUTABLE_DIR`. If present, `userData` is set relative to the executable. Auto-updates are disabled for Portable builds (User is redirected to GitHub).
5. **AI Context**: Always run `npm run ctx:gen` before a major task.

## Memory Bank (Recent Decisions)

- **2025-12-18 [Updater]**:
  - Portable users get a "Download from GitHub" button instead of auto-update.
  - `updater-service` sends `isPortable` flag to UI.
- **2025-12-18 [Paths]**:
  - Fixed `userData` path resolution to support both Installer (%APPDATA%) and Portable (local folder) modes correctly using `process.env.PORTABLE_EXECUTABLE_DIR`.
- **2025-12-18 [Types]**:
  - `renderer.d.ts` manually mirrors `bridge.ts` API surface to ensure type safety in components.

## Current Focus (Status: Active Dev)

- [x] Fix "Hanging" Updater in Dev mode.
- [x] Implement Adaptive Updater UI (Portable vs Installer).
- [ ] **Critical Refactor**: Check `src/main/ipc/handlers/files.ts` for path safety (ensure it respects the new `userData` logic and doesn't hardcode paths).
- [ ] Fix: Sync Service race conditions.


=== PROJECT STRUCTURE (Latest) ===
Project Structure (Generated: 2025-12-19T06:05:23.997Z)

Root:
â”œâ”€â”€ .ai
â”‚   â”œâ”€â”€ CONTEXT.md
â”‚   â””â”€â”€ RULES.md
â”œâ”€â”€ docs
â”‚   â”œâ”€â”€ api.md
â”‚   â”œâ”€â”€ architecture.md
â”‚   â”œâ”€â”€ contributing.md
â”‚   â”œâ”€â”€ database.md
â”‚   â”œâ”€â”€ development.md
â”‚   â”œâ”€â”€ roadmap.md
â”‚   â””â”€â”€ rule34-api-reference.md
â”œâ”€â”€ drizzle
â”‚   â”œâ”€â”€ meta
â”‚   â”‚   â”œâ”€â”€ _journal.json
â”‚   â”‚   â”œâ”€â”€ 0000_snapshot.json
â”‚   â”‚   â””â”€â”€ 0001_snapshot.json
â”‚   â”œâ”€â”€ 0000_flawless_sally_floyd.sql
â”‚   â””â”€â”€ 0001_lying_mauler.sql
â”œâ”€â”€ scripts
â”‚   â”œâ”€â”€ ai_reviewer.py
â”‚   â”œâ”€â”€ gen-gemini-prompt.ts
â”‚   â”œâ”€â”€ generate-tree.ts
â”‚   â””â”€â”€ system_prompt.md
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ main
â”‚   â”‚   â”œâ”€â”€ db
â”‚   â”‚   â”‚   â”œâ”€â”€ db-worker-client.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ db-worker.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ migrate.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ schema.ts
â”‚   â”‚   â”‚   â””â”€â”€ worker-types.ts
â”‚   â”‚   â”œâ”€â”€ ipc
â”‚   â”‚   â”‚   â”œâ”€â”€ handlers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ artists.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ files.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ posts.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ settings.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ viewer.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ channels.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ lib
â”‚   â”‚   â”‚   â””â”€â”€ logger.ts
â”‚   â”‚   â”œâ”€â”€ services
â”‚   â”‚   â”‚   â”œâ”€â”€ artists.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ posts.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ secure-storage.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ sync-service.ts
â”‚   â”‚   â”‚   â””â”€â”€ updater-service.ts
â”‚   â”‚   â”œâ”€â”€ bridge.ts
â”‚   â”‚   â”œâ”€â”€ main.d.ts
â”‚   â”‚   â””â”€â”€ main.ts
â”‚   â”œâ”€â”€ renderer
â”‚   â”‚   â”œâ”€â”€ components
â”‚   â”‚   â”‚   â”œâ”€â”€ dialogs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AddArtistModal.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DeleteArtistDialog.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Onboarding.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UpdateNotification.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ gallery
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ArtistCard.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ArtistGallery.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PostCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ inputs
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AsyncAutocomplete.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ layout
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AppLayout.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GlobalTopBar.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Sidebar.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ pages
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ArtistDetails.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Browse.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Favorites.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Onboarding.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Settings.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Tracked.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Updates.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ settings
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ BackupControls.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ui
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ alert.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ card.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dialog.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dropdown-menu.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ label.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ select.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ separator.tsx
â”‚   â”‚   â”‚   â””â”€â”€ viewer
â”‚   â”‚   â”‚       â””â”€â”€ ViewerDialog.tsx
â”‚   â”‚   â”œâ”€â”€ i18n
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ lib
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useDebounce.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ artist-utils.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ tag-utils.ts
â”‚   â”‚   â”‚   â””â”€â”€ utils.ts
â”‚   â”‚   â”œâ”€â”€ locales
â”‚   â”‚   â”‚   â””â”€â”€ en
â”‚   â”‚   â”‚       â””â”€â”€ translation.json
â”‚   â”‚   â”œâ”€â”€ schemas
â”‚   â”‚   â”‚   â””â”€â”€ form-schemas.ts
â”‚   â”‚   â”œâ”€â”€ store
â”‚   â”‚   â”‚   â””â”€â”€ viewerStore.ts
â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â”œâ”€â”€ index.css
â”‚   â”‚   â”œâ”€â”€ index.html
â”‚   â”‚   â””â”€â”€ main.tsx
â”‚   â””â”€â”€ renderer.d.ts
â”œâ”€â”€ components.json
â”œâ”€â”€ drizzle.config.ts
â”œâ”€â”€ electron.vite.config.ts
â”œâ”€â”€ eslint.config.js
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ README.md
â”œâ”€â”€ repomix.config.json
â”œâ”€â”€ settings.json
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ tsconfig.json


=== INSTRUCTION ===
Await my next command.
