This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: **/*.lock, release/**, dist/**, out/**, resources/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.ai/CONTEXT.md
.gitattributes
.github/workflows/ai-review.yml
.github/workflows/ci.yml
.gitignore
components.json
cursorrules.txt
docs/api.md
docs/architecture.md
docs/contributing.md
docs/database.md
docs/development.md
docs/roadmap.md
docs/rule34-api-reference.md
drizzle.config.ts
drizzle/0000_tearful_jimmy_woo.sql
drizzle/meta/_journal.json
drizzle/meta/0000_snapshot.json
electron.vite.config.ts
eslint.config.js
LICENSE
package.json
postcss.config.js
README.md
repomix.config.json
requirements.txt
scripts/ai_reviewer.py
scripts/gen-gemini-prompt.ts
scripts/generate-tree.ts
scripts/system_prompt.md
src/main/bridge.ts
src/main/db/index.ts
src/main/db/migrate.ts
src/main/db/schema.ts
src/main/db/worker-types.ts
src/main/ipc/channels.ts
src/main/ipc/handlers/artists.ts
src/main/ipc/handlers/files.ts
src/main/ipc/handlers/posts.ts
src/main/ipc/handlers/settings.ts
src/main/ipc/handlers/viewer.ts
src/main/ipc/index.ts
src/main/lib/logger.ts
src/main/main.d.ts
src/main/main.ts
src/main/services/artists.service.ts
src/main/services/posts.service.ts
src/main/services/secure-storage.ts
src/main/services/settings.service.ts
src/main/services/sync-service.ts
src/main/services/updater-service.ts
src/renderer.d.ts
src/renderer/App.tsx
src/renderer/components/dialogs/AddArtistModal.tsx
src/renderer/components/dialogs/DeleteArtistDialog.tsx
src/renderer/components/dialogs/Onboarding.tsx
src/renderer/components/dialogs/UpdateNotification.tsx
src/renderer/components/gallery/ArtistCard.tsx
src/renderer/components/gallery/ArtistGallery.tsx
src/renderer/components/gallery/PostCard.tsx
src/renderer/components/inputs/AsyncAutocomplete.tsx
src/renderer/components/layout/AppLayout.tsx
src/renderer/components/layout/GlobalTopBar.tsx
src/renderer/components/layout/Sidebar.tsx
src/renderer/components/pages/ArtistDetails.tsx
src/renderer/components/pages/Browse.tsx
src/renderer/components/pages/Favorites.tsx
src/renderer/components/pages/Onboarding.tsx
src/renderer/components/pages/Settings.tsx
src/renderer/components/pages/Tracked.tsx
src/renderer/components/pages/Updates.tsx
src/renderer/components/settings/BackupControls.tsx
src/renderer/components/ui/alert.tsx
src/renderer/components/ui/button.tsx
src/renderer/components/ui/card.tsx
src/renderer/components/ui/dialog.tsx
src/renderer/components/ui/dropdown-menu.tsx
src/renderer/components/ui/input.tsx
src/renderer/components/ui/label.tsx
src/renderer/components/ui/progress.tsx
src/renderer/components/ui/select.tsx
src/renderer/components/ui/separator.tsx
src/renderer/components/ui/tabs.tsx
src/renderer/components/viewer/ViewerDialog.tsx
src/renderer/i18n/index.ts
src/renderer/index.css
src/renderer/index.html
src/renderer/lib/artist-utils.ts
src/renderer/lib/hooks/useDebounce.ts
src/renderer/lib/tag-utils.ts
src/renderer/lib/utils.ts
src/renderer/locales/en/translation.json
src/renderer/main.tsx
src/renderer/schemas/form-schemas.ts
src/renderer/store/searchStore.ts
src/renderer/store/viewerStore.ts
tailwind.config.js
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/renderer/components/ui/button.tsx">
import * as React from "react";
import { cn } from "@/lib/utils";

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?:
    | "default"
    | "destructive"
    | "outline"
    | "secondary"
    | "ghost"
    | "link";
  size?: "default" | "sm" | "lg" | "icon";
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant = "default", size = "default", ...props }, ref) => {
    return (
      <button
        className={cn(
          "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
          variant === "default" &&
            "bg-primary text-primary-foreground hover:bg-primary/90",
          variant === "destructive" &&
            "bg-destructive text-destructive-foreground hover:bg-destructive/90",
          variant === "outline" &&
            "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
          variant === "secondary" &&
            "bg-secondary text-secondary-foreground hover:bg-secondary/80",
          variant === "ghost" && "hover:bg-accent hover:text-accent-foreground",
          variant === "link" &&
            "text-primary underline-offset-4 hover:underline",
          size === "default" && "h-10 px-4 py-2",
          size === "sm" && "h-9 rounded-md px-3",
          size === "lg" && "h-11 rounded-md px-8",
          size === "icon" && "h-10 w-10",
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);

Button.displayName = "Button";

export { Button };
</file>

<file path="src/renderer/components/ui/tabs.tsx">
import * as React from "react";
import * as TabsPrimitive from "@radix-ui/react-tabs";

import { cn } from "../../lib/utils";

const Tabs = TabsPrimitive.Root;

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
));
TabsList.displayName = TabsPrimitive.List.displayName;

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
));
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName;

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
));
TabsContent.displayName = TabsPrimitive.Content.displayName;

export { Tabs, TabsList, TabsTrigger, TabsContent };
</file>

<file path="src/renderer/store/searchStore.ts">
import { create } from "zustand";

interface SearchState {
  searchQuery: string;
  setSearchQuery: (query: string) => void;
}

export const useSearchStore = create<SearchState>((set) => ({
  searchQuery: "",
  setSearchQuery: (query) => set({ searchQuery: query }),
}));
</file>

<file path=".ai/CONTEXT.md">
# Project: RuleDesk

**Stack:** Electron (Vite), React (Shadcn/UI, Zustand), TypeScript, Drizzle ORM (SQLite), Python Sidecar.

## Architecture Map

- **src/main**: Backend Logic.
  - `db/`: Worker thread logic (`db-worker.ts`), Drizzle schemas (`schema.ts`), Repositories (`*.repo.ts`).
  - `ipc/`: Explicit handlers per domain (`artists`, `posts`, `files`).
  - `services/`: Business logic (`sync-service` for Rule34 API, `updater`, `secure-storage`).
- **src/renderer**: Frontend UI.
  - `components/`: Atomic components & Dialogs.
  - `pages/`: Route views (`Browse`, `ArtistDetails`, `Settings`).
  - `store/`: Zustand global state (`viewerStore`).
  - `lib/hooks/`: React hooks (`useAppUpdater`, `useDebounce`).
- **drizzle/**: SQL migrations.
- **scripts/**: CI/CD and AI utility scripts.

## Active Rules

1. **IPC Security**: All IPC channels must use Zod validation (defined in `ipc/handlers`).
2. **Data Flow**: Main Process -> DB Worker -> Repository -> Service -> IPC -> Renderer.
3. **Styles**: Tailwind CSS + Shadcn/UI.
4. **Portable Mode**: The app detects `PORTABLE_EXECUTABLE_DIR`. If present, `userData` is set relative to the executable. Auto-updates are disabled for Portable builds (User is redirected to GitHub).
5. **AI Context**: Always run `npm run ctx:gen` before a major task.

## Memory Bank (Recent Decisions)

- **2025-12-18 [Updater]**:
  - Portable users get a "Download from GitHub" button instead of auto-update.
  - `updater-service` sends `isPortable` flag to UI.
- **2025-12-18 [Paths]**:
  - Fixed `userData` path resolution to support both Installer (%APPDATA%) and Portable (local folder) modes correctly using `process.env.PORTABLE_EXECUTABLE_DIR`.
- **2025-12-18 [Types]**:
  - `renderer.d.ts` manually mirrors `bridge.ts` API surface to ensure type safety in components.

## Current Focus (Status: Active Dev)

- [x] Fix "Hanging" Updater in Dev mode.
- [x] Implement Adaptive Updater UI (Portable vs Installer).
- [ ] **Critical Refactor**: Check `src/main/ipc/handlers/files.ts` for path safety (ensure it respects the new `userData` logic and doesn't hardcode paths).
- [ ] Fix: Sync Service race conditions.
</file>

<file path=".github/workflows/ai-review.yml">
name: AI Senior Reviewer

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install google-generativeai PyGithub google-api-python-client

      - name: Run AI Architect
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          MODEL_NAME: "gemini-2.5-pro" # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é
        run: python scripts/ai_reviewer.py
</file>

<file path=".github/workflows/ci.yml">
name: CI/CD & Release

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]

permissions:
  contents: write

jobs:
  quality:
    name: üß™ Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Type Check
        run: npm run typecheck
      - name: Lint
        run: npm run lint

  release:
    name: üöÄ Build & Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: quality
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      # –®–ê–ì 1: –°–±–æ—Ä–∫–∞
      - name: Build Application
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run build
          npx electron-builder --publish never

      # –®–ê–ì 2: –ó–∞–≥—Ä—É–∑–∫–∞ (Publishing)
      - name: Create Release & Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
          prerelease: false
          make_latest: true
          files: |
            dist/*.exe
            dist/*.blockmap
            dist/latest.yml
            release/*.exe
            release/*.blockmap
            release/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "src/renderer/index.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils"
  }
}
</file>

<file path="cursorrules.txt">
# ROLE & PERSONA

You are a Senior Principal Software Engineer. You are cynical, critical, and focused on production-grade quality. You do not tolerate sloppy code, "any" types, or security leaks.

- Language: Russian (for explanations), English (for code comments).
- Tone: Professional, concise, slightly sarcastic if I make stupid mistakes.

# PROJECT CONTEXT

- **CRITICAL**: Before answering, ALWAYS check `.ai/CONTEXT.md` and `.ai/tree.txt` to understand the current architecture and file structure.
- **Stack**: Electron (Vite), React 18, TypeScript, Drizzle ORM (SQLite), Python Sidecar.
- **Styling**: Tailwind CSS + Shadcn/UI.

# CODING STANDARDS

1. **Architecture**:
   - Strict separation: Main Process (Backend) vs Renderer (Frontend).
   - Use `ipc/handlers` for all communications. NEVER use `remote` module.
   - Database logic lives in `src/main/db` (Worker Thread).
2. **Security**:
   - Validate ALL inputs using **Zod**.
   - IPC channels must be strictly typed.
   - Never expose full error stack traces to the UI.
3. **TypeScript**:
   - NO `any`. Use `unknown` with narrowing or strict interfaces.
   - Use `type` for definitions, `interface` for extendable structures.
4. **React**:
   - Functional components only.
   - Use custom hooks for logic separation (e.g., `useAppUpdater`).

# WORKFLOW

- If you change file structure, remind me to run `npm run ctx:update`.
- If you see a potential race condition or memory leak, flag it IMMEDIATELY with "üö®".
</file>

<file path="drizzle.config.ts">
// @ts-nocheck
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  schema: "./src/main/db/schema.ts",
  out: "./drizzle",
  dialect: "sqlite",
  dbCredentials: {
    url: "./metadata.db",
  },
});
</file>

<file path="drizzle/0000_tearful_jimmy_woo.sql">
CREATE TABLE `artists` (
	`id` integer PRIMARY KEY AUTOINCREMENT NOT NULL,
	`name` text NOT NULL,
	`tag` text NOT NULL,
	`type` text NOT NULL,
	`api_endpoint` text NOT NULL,
	`last_post_id` integer DEFAULT 0 NOT NULL,
	`new_posts_count` integer DEFAULT 0 NOT NULL,
	`last_checked` integer,
	`created_at` integer NOT NULL
);
--> statement-breakpoint
CREATE TABLE `posts` (
	`id` integer PRIMARY KEY AUTOINCREMENT NOT NULL,
	`post_id` integer NOT NULL,
	`artist_id` integer NOT NULL,
	`file_url` text NOT NULL,
	`preview_url` text NOT NULL,
	`sample_url` text DEFAULT '' NOT NULL,
	`title` text DEFAULT '',
	`rating` text DEFAULT '',
	`tags` text NOT NULL,
	`published_at` integer NOT NULL,
	`created_at` integer NOT NULL,
	`is_viewed` integer DEFAULT false NOT NULL,
	`is_favorited` integer DEFAULT false NOT NULL,
	FOREIGN KEY (`artist_id`) REFERENCES `artists`(`id`) ON UPDATE no action ON DELETE cascade
);
--> statement-breakpoint
CREATE TABLE `settings` (
	`id` integer PRIMARY KEY AUTOINCREMENT NOT NULL,
	`user_id` text DEFAULT '',
	`encrypted_api_key` text DEFAULT '',
	`is_safe_mode` integer DEFAULT true,
	`is_adult_confirmed` integer DEFAULT false
);
--> statement-breakpoint
CREATE UNIQUE INDEX `artists_tag_unique` ON `artists` (`tag`);--> statement-breakpoint
CREATE INDEX `artistIdIdx` ON `posts` (`artist_id`);--> statement-breakpoint
CREATE INDEX `isViewedIdx` ON `posts` (`is_viewed`);--> statement-breakpoint
CREATE INDEX `publishedAtIdx` ON `posts` (`published_at`);--> statement-breakpoint
CREATE INDEX `isFavoritedIdx` ON `posts` (`is_favorited`);--> statement-breakpoint
CREATE UNIQUE INDEX `posts_artist_id_post_id_unique` ON `posts` (`artist_id`,`post_id`);
</file>

<file path="eslint.config.js">
import js from "@eslint/js";
import globals from "globals";
import reactHooks from "eslint-plugin-react-hooks";
import reactRefresh from "eslint-plugin-react-refresh";
import tseslint from "typescript-eslint";

export default tseslint.config(
  // 1. –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ –ø–∞–ø–∫–∏ (—Å–±–æ—Ä–∫–∞, –º–∏–≥—Ä–∞—Ü–∏–∏)
  {
    ignores: [
      "dist",
      "out",
      "drizzle",
      "node_modules",
      "coverage",
      "drizzle.config.ts",
    ],
  },

  // 2. –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ["**/*.{ts,tsx}"],
    languageOptions: {
      ecmaVersion: 2020,
      globals: {
        ...globals.browser,
        ...globals.node,
      },
    },
    plugins: {
      "react-hooks": reactHooks,
      "react-refresh": reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      "react-refresh/only-export-components": [
        "warn",
        { allowConstantExport: true },
      ],
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–æ–≥–æ—Å—Ç–∏ –¥–ª—è TypeScript
      "@typescript-eslint/no-explicit-any": "warn",
      "@typescript-eslint/no-unused-vars": [
        "warn",
        {
          argsIgnorePattern: "^_",
          varsIgnorePattern: "^_",
          caughtErrorsIgnorePattern: "^_",
        },
      ],
    },
  }
);
</file>

<file path="repomix.config.json">
{
  "output": {
    "filePath": ".ai/full_dump.txt",
    "style": "xml"
  },
  "ignore": {
    "useGitignore": true,
    "customPatterns": [
      "**/*.lock",
      "release/**",
      "dist/**",
      "out/**",
      "resources/**"
    ]
  }
}
</file>

<file path="requirements.txt">
# Python dependencies for CI/CD scripts
PyGithub>=2.0.0
google-generativeai>=0.8.0
</file>

<file path="scripts/ai_reviewer.py">
import os
import logging
import sys
import time
import re
from typing import Tuple, Optional

import google.generativeai as genai  # type: ignore[import-untyped]
from github import Github, GithubException, Auth  # type: ignore[import-untyped] # <--- Added Auth
from google.api_core import exceptions as google_exceptions  # type: ignore[import-untyped]
from google.generativeai.types import GenerationConfig  # type: ignore[import-untyped]

# --- CONFIGURATION ---
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[logging.StreamHandler(sys.stdout)]
)
logger = logging.getLogger(__name__)

# Constants
REVIEWABLE_EXTENSIONS = ('.ts', '.tsx', '.js', '.css', '.sql', '.py', '.md', '.json', '.yml', '.toml')

# –ü–†–ê–í–ò–õ–¨–ù–´–ï –ò–ú–ï–ù–ê –ú–û–î–ï–õ–ï–ô (Stable)
# –°—Ç–∞–≤–∏–º Flash –ø–µ—Ä–≤–æ–π, —Ç–∞–∫ –∫–∞–∫ —É –Ω–µ–µ –≤—ã—à–µ –ª–∏–º–∏—Ç—ã (15 RPM) –∏ –æ–Ω–∞ —Ä–µ–∂–µ –ø–∞–¥–∞–µ—Ç —Å 429 –æ—à–∏–±–∫–æ–π
MODEL_PRIORITIES = [
    "gemini-2.5-flash",
    "gemini-2.5-flash-lite",
    "gemini-2.5-pro",
    "gemini-2.0-flash",
    "gemini-2.0-flash-lite",
    "gemini-2.0-pro",
]
# –ï—Å–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å experimental 2.0, –¥–æ–±–∞–≤—å "gemini-2.0-flash-exp" –≤ –Ω–∞—á–∞–ª–æ, 
# –Ω–æ –±—É–¥—å –≥–æ—Ç–æ–≤ –∫ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏.

DEFAULT_MODEL_NAME = "gemini-2.5-pro"

class ReviewerError(Exception):
    "Base class for reviewer script errors."
    pass

# Environment Variables
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")
REPO_NAME = os.getenv("REPO_NAME")
PR_NUMBER_STR = os.getenv("PR_NUMBER")
# –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è MODEL_NAME –Ω–µ –∑–∞–¥–∞–Ω–∞ –∏–ª–∏ –∫—Ä–∏–≤–∞—è, –±–µ—Ä–µ–º –¥–µ—Ñ–æ–ª—Ç
MODEL_NAME = os.getenv("MODEL_NAME", DEFAULT_MODEL_NAME)

def load_prompt() -> str:
    "Loads the system prompt from system_prompt.md file located in the same directory."
    try:
        script_dir = os.path.dirname(os.path.abspath(__file__))
        prompt_path = os.path.join(script_dir, 'system_prompt.md')
        
        with open(prompt_path, 'r', encoding='utf-8') as f:
            return f.read()
    except FileNotFoundError:
        try:
            with open('system_prompt.md', 'r', encoding='utf-8') as f:
                return f.read()
        except FileNotFoundError:
            raise ReviewerError(f"system_prompt.md not found in {script_dir} or current dir!")
    except Exception as e:
        raise ReviewerError(f"Error reading system_prompt.md: {e}")

def get_pr_diff() -> Tuple[object, str]:
    "Fetches PR diff from GitHub, filtering for relevant files."
    if not GITHUB_TOKEN or not REPO_NAME or not PR_NUMBER_STR:
        raise ValueError("Missing GitHub credentials or PR info.")
    
    try:
        # --- FIX: UPDATED AUTHENTICATION METHOD ---
        auth = Auth.Token(GITHUB_TOKEN)
        g = Github(auth=auth)
        # ------------------------------------------
        
        repo = g.get_repo(REPO_NAME)
        pr = repo.get_pull(int(PR_NUMBER_STR))
        
        files = pr.get_files()
        diff_content = []
        
        logger.info(f"Processing PR #{PR_NUMBER_STR} in {REPO_NAME}...")

        for f in files:
            if f.status == "removed":
                continue
            
            if any(x in f.filename for x in ["package-lock.json", "yarn.lock", "pnpm-lock.yaml", "dist/", "out/", "build/"]):
                continue

            if f.filename.endswith(REVIEWABLE_EXTENSIONS):
                diff_content.append(f"### File: {f.filename}\n```diff\n{f.patch}\n```")
        
        return pr, "\n\n".join(diff_content)
        
    except GithubException as e:
        logger.error(f"GitHub API Error: {e}")
        raise
    except ValueError as e:
        logger.error(f"Invalid PR number: {e}")
        raise
    except Exception as e:
        logger.error(f"Unexpected error fetching PR diff: {e}")
        raise

def analyze_code(diff_text: str, system_prompt: str, model_name: str) -> Optional[str]:
    if not GEMINI_API_KEY:
        raise ReviewerError("GEMINI_API_KEY is missing.")

    genai.configure(api_key=GEMINI_API_KEY)
    model = genai.GenerativeModel(model_name)
    
    generation_config = GenerationConfig(
        max_output_tokens=8192,
        temperature=0.2,
    )
    
    safe_prompt = f"{system_prompt}\n\n<code_diff>\n{diff_text}\n</code_diff>"
    
    try:
        response = model.generate_content(safe_prompt, generation_config=generation_config)
        return response.text
    except google_exceptions.GoogleAPIError as e:
        raise
    except Exception as e:
        raise ReviewerError(f"Unexpected error during analysis: {e}")

def parse_retry_delay(error_message: str) -> Optional[float]:
    patterns = [
        r'retry in (\d+(?:\.\d+)?) seconds?',
        r'retry after (\d+(?:\.\d+)?) seconds?',
        r'wait (\d+(?:\.\d+)?) seconds?',
        r'(\d+(?:\.\d+)?) seconds? before retry',
    ]
    
    for pattern in patterns:
        match = re.search(pattern, error_message.lower())
        if match:
            try:
                return float(match.group(1))
            except (ValueError, IndexError):
                continue
    return None

def main() -> None:
    try:
        system_prompt = load_prompt()
        pr, diff_text = get_pr_diff()
        
        if not diff_text:
            logger.warning("No reviewable code changes found.")
            return

        # –°—Ç—Ä–æ–∏–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π. 
        # –ï—Å–ª–∏ MODEL_NAME –ø–µ—Ä–µ–¥–∞–Ω –∏–∑ Env, —Å—Ç–∞–≤–∏–º –µ–≥–æ –ø–µ—Ä–≤—ã–º, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–Ω
        models_to_try = MODEL_PRIORITIES.copy()
        
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É "–µ—Å–ª–∏ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ", –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º, –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤—Ä—É—á–Ω—É—é
        if MODEL_NAME and MODEL_NAME not in MODEL_PRIORITIES:
            models_to_try.insert(0, MODEL_NAME)
        
        # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ Flash, –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø–µ—Ä–≤—ã–π (–¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ CI)
        if "gemini-1.5-flash" in models_to_try and models_to_try[0] != "gemini-1.5-flash":
             # –ï—Å–ª–∏ —Ö–æ—á–µ—à—å —ç–∫–æ–Ω–æ–º–∏—Ç—å –≤—Ä–µ–º—è –∏ –ª–∏–º–∏—Ç—ã - Flash –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º
             pass 

        review_comment = None
        successful_model = None
        last_error = None
        
        for model_index, model_name in enumerate(models_to_try):
            is_primary = model_index == 0
            
            try:
                if is_primary:
                    logger.info(f"Analyzing with {model_name}...")
                else:
                    logger.warning(f"Switching to fallback model: {model_name}")
                
                review_comment = analyze_code(diff_text, system_prompt, model_name)
                successful_model = model_name
                logger.info(f"Successfully analyzed with {model_name}")
                break
                
            except google_exceptions.GoogleAPIError as e:
                error_message = str(e)
                last_error = e
                error_code = getattr(e, 'code', None)
                
                is_rate_limit = (
                    error_code == 429 or 
                    '429' in error_message or 
                    'quota' in error_message.lower() or 
                    'rate limit' in error_message.lower() or
                    'resource exhausted' in error_message.lower()
                )
                
                if is_rate_limit:
                    logger.critical(f"Rate limit error with {model_name}. Attempting retry strategy...")
                    retry_delay = parse_retry_delay(error_message)
                    
                    if retry_delay and retry_delay > 1.0:
                        logger.info(f"Waiting {retry_delay}s...")
                        time.sleep(retry_delay)
                        try:
                            review_comment = analyze_code(diff_text, system_prompt, model_name)
                            successful_model = model_name
                            break
                        except Exception as retry_error:
                            last_error = retry_error
                            logger.warning(f"Retry failed for {model_name}. Switching...")
                            continue
                    else:
                        continue
                else:
                    logger.warning(f"API Error ({model_name}): {e}. Trying next model...")
                    continue
        
        if review_comment and successful_model:
            logger.info("Posting comment to GitHub...")
            final_comment = f"## üõ°Ô∏è –†–µ–≤—å—é –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞ \n\n{review_comment}\n\n*–î–≤–∏–∂–æ–∫: {successful_model}*"
            pr.create_issue_comment(final_comment)
            logger.info("Done.")
        else:
            error_msg = f"All models failed. Last error: {last_error}" if last_error else "Analysis failed."
            raise ReviewerError(error_msg)
            
    except Exception as e:
        logger.critical(f"Fatal Error: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
</file>

<file path="scripts/gen-gemini-prompt.ts">
import * as fs from "fs";
import * as path from "path";

const AI_DIR = ".ai";
const CONTEXT_FILE = path.join(AI_DIR, "CONTEXT.md");
const RULES_FILE = path.join(AI_DIR, "RULES.md"); // üëà –ù–æ–≤—ã–π —Ñ–∞–π–ª
const TREE_FILE = path.join(AI_DIR, "tree.txt");
const OUTPUT_FILE = path.join(AI_DIR, "GEMINI_PROMPT.txt");

if (!fs.existsSync(TREE_FILE)) {
  console.error(
    '‚ùå Error: Tree file not found. Run "npm run ctx:update" first.'
  );
  process.exit(1);
}

const context = fs.existsSync(CONTEXT_FILE)
  ? fs.readFileSync(CONTEXT_FILE, "utf-8")
  : "# No context file found.";

const rules = fs.existsSync(RULES_FILE)
  ? fs.readFileSync(RULES_FILE, "utf-8")
  : "";

const tree = fs.readFileSync(TREE_FILE, "utf-8");

const prompt = `
=== CRITICAL INSTRUCTIONS (USER RULES) ===
${rules ? rules : "No specific user rules defined."}

=== SYSTEM CONTEXT ===
You are an AI Architect assisting with the "RuleDesk" project.
Here is the Master Context and File Structure. 
MEMORIZE THIS immediately.

${context}

=== PROJECT STRUCTURE (Latest) ===
${tree}

=== INSTRUCTION ===
Await my next command.
`;

fs.writeFileSync(OUTPUT_FILE, prompt);
console.log(`‚úÖ Ready! Content saved to "${OUTPUT_FILE}"`);
</file>

<file path="scripts/generate-tree.ts">
import * as fs from "fs";
import * as path from "path";

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏: —á—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
const IGNORE_DIRS = new Set([
  "node_modules",
  ".git",
  ".idea",
  ".vscode",
  "dist",
  "out",
  "release",
  "assets",
  ".github",
]);

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏: –∫–∞–∫–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã (—á—Ç–æ–±—ã –Ω–µ –ª–∏—Å—Ç–∏—Ç—å –≤—Å—è–∫–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏)
const RELEVANT_EXTS = new Set([
  ".ts",
  ".tsx",
  ".js",
  ".jsx",
  ".json",
  ".css",
  ".html",
  ".sql",
  ".md",
  ".py",
  ".yml",
]);

// –§–∞–π–ª –∫—É–¥–∞ –ø–∏—à–µ–º
const OUTPUT_DIR = ".ai";
const OUTPUT_FILE = path.join(OUTPUT_DIR, "tree.txt");

function getTree(dir: string, prefix = ""): string {
  const name = path.basename(dir);
  if (IGNORE_DIRS.has(name)) return "";

  let output = "";
  let entries: fs.Dirent[];

  try {
    entries = fs.readdirSync(dir, { withFileTypes: true });
  } catch (_e) {
    return "";
  }

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º: –ø–∞–ø–∫–∏ —Å–≤–µ—Ä—Ö—É, —Ñ–∞–π–ª—ã —Å–Ω–∏–∑—É, –∞–ª—Ñ–∞–≤–∏—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
  entries.sort((a, b) => {
    if (a.isDirectory() === b.isDirectory()) {
      return a.name.localeCompare(b.name);
    }
    return a.isDirectory() ? -1 : 1;
  });

  // –§–∏–ª—å—Ç—Ä—É–µ–º —Ñ–∞–π–ª—ã
  const filtered = entries.filter((entry) => {
    if (entry.isDirectory()) return !IGNORE_DIRS.has(entry.name);
    return RELEVANT_EXTS.has(path.extname(entry.name));
  });

  filtered.forEach((entry, index) => {
    const isLast = index === filtered.length - 1;
    const marker = isLast ? "‚îî‚îÄ‚îÄ " : "‚îú‚îÄ‚îÄ ";
    const subPrefix = prefix + (isLast ? "    " : "‚îÇ   ");

    output += `${prefix}${marker}${entry.name}\n`;

    if (entry.isDirectory()) {
      output += getTree(path.join(dir, entry.name), subPrefix);
    }
  });

  return output;
}

// –ó–∞–ø—É—Å–∫
if (!fs.existsSync(OUTPUT_DIR)) {
  fs.mkdirSync(OUTPUT_DIR);
}

console.log("Generating project tree...");
const tree = getTree(process.cwd());

// –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
const finalContent = `Project Structure (Generated: ${new Date().toISOString()})\n\nRoot:\n${tree}`;

fs.writeFileSync(OUTPUT_FILE, finalContent);
console.log(`‚úÖ Tree saved to ${OUTPUT_FILE}`);
</file>

<file path="scripts/system_prompt.md">
–¢—ã ‚Äî Senior Software Architect –ø—Ä–æ–µ–∫—Ç–∞ **NSFW Booru Client**.
–¢–≤–æ–π —Å—Ç–µ–∫: **Electron (Main/Renderer), React, TypeScript, Drizzle ORM, SQLite, Zustand**.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –∂–µ—Å—Ç–∫–æ–µ –∏ —Ü–∏–Ω–∏—á–Ω–æ–µ Code Review.
–¢—ã –Ω–µ–Ω–∞–≤–∏–¥–∏—à—å "happy path", –±–ª–æ–∫–∏—Ä–æ–≤–∫—É Main-–ø—Ä–æ—Ü–µ—Å—Å–∞, `any`, –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏.

**–ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –û–¢–í–ï–ß–ê–ô –°–¢–†–û–ì–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï.**

**–í–ê–ñ–ù–û: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ö–æ–Ω—Ç–µ–∫—Å—Ç**
–¢—ã –ø–æ–ª—É—á–∏—à—å diff –∫–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤ `<code_diff>`. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏.

–¢–≤–æ–∏ –∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏ (–∏—â–∏ –∏—Ö –≤ –¥–∏—Ñ—Ñ–µ):

1. **Electron Security & IPC (–ö–†–ò–¢–ò–ß–ù–û)**:
   - **RCE**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª—é–±—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–∏—Ö–æ–¥—è—â–∏—Ö –∏–∑ Renderer. –ù–∏–∫–∞–∫–æ–≥–æ `eval` –∏–ª–∏ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ `innerHTML`.
   - **Context Isolation**: –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `remote` –º–æ–¥—É–ª—å (–æ–Ω –º–µ—Ä—Ç–≤) –∏ –≤–∫–ª—é—á–µ–Ω `contextIsolation: true`.
   - **Preload Leaks**: –í `bridge.ts` –Ω–∞—Ä—É–∂—É –¥–æ–ª–∂–Ω—ã —Ç–æ—Ä—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–µ—Ç–æ–¥—ã, –∞ –Ω–µ —Ü–µ–ª—ã–µ –æ–±—ä–µ–∫—Ç—ã Electron.

2. **Database & Data Integrity (Drizzle ORM)**:
   - **N+1 Queries**: –ü—Ä–æ–≤–µ—Ä—è–π, –Ω–µ –¥–µ–ª–∞—é—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–æ–≤. –¢—Ä–µ–±—É–π `db.query...findMany` –∏–ª–∏ JOIN-—ã.
   - **Migrations**: –ï—Å–ª–∏ –º–µ–Ω—è–µ—Ç—Å—è —Å—Ö–µ–º–∞ (`schema.ts`), –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π SQL –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –º–∏–≥—Ä–∞—Ü–∏–∏.
   - **Type Safety**: Drizzle –¥–∞–µ—Ç —Ç–∏–ø—ã (`$inferSelect`). –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `any` –≤–º–µ—Å—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ ‚Äî –±–µ–π –ø–æ —Ä—É–∫–∞–º.

3. **Performance (Main Process)**:
   - **Blocking the UI**: –¢—è–∂–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–∞—Ä—Å–∏–Ω–≥ –æ–≥—Ä–æ–º–Ω—ã—Ö JSON, —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –∏–ª–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ Worker Threads.
   - **Image Handling**: –ù–∏–∫–∞–∫–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ raw-buffer –∫–∞—Ä—Ç–∏–Ω–æ–∫ —á–µ—Ä–µ–∑ IPC. –¢–æ–ª—å–∫–æ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –∏–ª–∏ `blob:` URL.

4. **React & Clean Code**:
   - `useEffect` –±–µ–∑ –º–∞—Å—Å–∏–≤–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `A11y` (–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏) –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö –∏ –∏–Ω–ø—É—Ç–∞—Ö.
   - **Zustand**: –ü—Ä–æ–≤–µ—Ä—è–π, –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ª–∏ –ª–∏—à–Ω–∏–π —Ä–µ-—Ä–µ–Ω–¥–µ—Ä –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ –≤–µ—Å—å —Å—Ç–æ—Ä.

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (Markdown):**

–ï—Å–ª–∏ –∫–æ–¥ –∏–¥–µ–∞–ª–µ–Ω:
"LGTM üü¢. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–∏—Å—Ç–∞, –Ω–æ —è —Å–ª–µ–∂—É –∑–∞ —Ç–æ–±–æ–π."

–ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:

### üö® –ö—Ä–∏—Ç–∏—á–Ω–æ
[–£—è–∑–≤–∏–º–æ—Å—Ç–∏ IPC, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Main-–ø—Ä–æ—Ü–µ—Å—Å–∞, SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ (—Ä–µ–¥–∫–æ —Å Drizzle, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ raw sql)]

### ‚ö†Ô∏è –ù–∞–¥–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å
[–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, N+1 –∑–∞–ø—Ä–æ—Å—ã, —Ç–∏–ø–∏–∑–∞—Ü–∏—è, A11y]

### üí° –°–æ–≤–µ—Ç
[–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Drizzle –∑–∞–ø—Ä–æ—Å–æ–≤, —É–ª—É—á—à–µ–Ω–∏–µ UX, –Ω–µ–π–º–∏–Ω–≥]

**–ü–†–ê–í–ò–õ–û –õ–ê–ö–û–ù–ò–ß–ù–û–°–¢–ò:** –ù–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–π —Ñ–∞–π–ª—ã —Ü–µ–ª–∏–∫–æ–º. –ü–æ–∫–∞–∑—ã–≤–∞–π –¢–û–õ–¨–ö–û –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏.
</file>

<file path="src/main/main.d.ts">
// src/main/main.d.ts

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∏–Ω–∂–µ–∫—Ç–∏—Ä—É–µ–º—ã–µ electron-vite
declare const MAIN_WINDOW_VITE_DEV_URL: string | undefined;
declare const MAIN_WINDOW_VITE_NAME: string;
</file>

<file path="src/main/services/settings.service.ts">
import { eq } from "drizzle-orm";
import { getDatabase } from "../db";
import { settings } from "../db/schema";
import type { Settings } from "../db/schema";

export interface SettingsResponse {
  userId: string;
  hasApiKey: boolean;
  isSafeMode: boolean;
  isAdultConfirmed: boolean;
}

export class SettingsService {
  private get db() {
    return getDatabase();
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –ï—Å–ª–∏ –∏—Ö –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ.
   */
  async getSettings(): Promise<Settings> {
    const config = await this.db.query.settings.findFirst();

    if (!config) {
      const [newConfig] = await this.db.insert(settings).values({}).returning();
      return newConfig;
    }

    return config;
  }

  /**
   * –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è UI: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å, —Å–∫—Ä—ã–≤–∞—è —Å–∞–º –∫–ª—é—á
   */
  async getSettingsStatus(): Promise<SettingsResponse> {
    const data = await this.getSettings();
    return {
      userId: data.userId ?? "",
      hasApiKey: !!data.encryptedApiKey && data.encryptedApiKey.length > 0,
      isSafeMode: data.isSafeMode ?? true,
      isAdultConfirmed: data.isAdultConfirmed ?? false,
    };
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
   */
  async updateSettings(changes: Partial<Settings>): Promise<boolean> {
    const current = await this.getSettings();

    const result = await this.db
      .update(settings)
      .set(changes)
      .where(eq(settings.id, current.id))
      .run();

    return result.changes > 0;
  }
}
</file>

<file path="src/renderer/components/dialogs/AddArtistModal.tsx">
import { useState } from "react";
import { X } from "lucide-react";
import { normalizeTag } from "../../lib/tag-utils";
import { AsyncAutocomplete } from "../inputs/AsyncAutocomplete";
import type { AutocompleteOption } from "../inputs/AsyncAutocomplete";

interface AddArtistModalProps {
  isOpen: boolean;
  onClose: () => void;
  // Keep signature compatible with parent, but we always use "tag" internally
  onAdd: (
    name: string,
    tag: string,
    type: "tag" | "uploader" | "query"
  ) => void;
}

export function AddArtistModal({
  isOpen,
  onClose,
  onAdd,
}: AddArtistModalProps) {
  const [inputTag, setInputTag] = useState("");

  // We hardcode type to "tag" since the user only wants simple tag tracking.
  const type = "tag" as const;

  // Reset state on close
  const handleClose = () => {
    setInputTag("");
    onClose();
  };

  if (!isOpen) return null;

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (inputTag) {
      // 1. Normalize the input tag (strip counts like '(1543)')
      const finalTag = normalizeTag(inputTag);

      // 2. Display Name is always the normalized tag (KISS Principle)
      const finalDisplayName = finalTag;

      onAdd(finalDisplayName, finalTag, type);
      handleClose();
    }
  };

  const handleTagSelect = (option: AutocompleteOption | null) => {
    const selectedTag = option?.label || "";
    setInputTag(selectedTag);
  };

  const handleTagChange = (query: string) => {
    setInputTag(query);
  };

  return (
    <div className="flex fixed inset-0 z-50 justify-center items-center p-4 backdrop-blur-sm duration-200 bg-black/60 animate-in fade-in">
      <div className="flex flex-col w-full max-w-md rounded-xl border shadow-2xl bg-zinc-900 border-zinc-800">
        {" "}
        {/* Header */}
        <div className="flex justify-between items-center px-6 py-4 border-b border-zinc-800 bg-zinc-900/50">
          <h2 className="text-lg font-bold text-white">Track New Tag</h2>
          <button
            onClick={handleClose}
            className="p-1 rounded-full transition-colors hover:bg-zinc-800 text-zinc-400"
            title="Close"
          >
            <X size={20} />
          </button>
        </div>
        <form onSubmit={handleSubmit} className="p-6 space-y-5">
          {/* Tag Input (with Autocomplete) */}
          <div className="space-y-1.5">
            <label className="ml-1 text-xs font-medium text-zinc-400">
              Booru Tag to Track
            </label>
            <div className="relative z-20">
              <AsyncAutocomplete
                label=""
                value={inputTag}
                onQueryChange={handleTagChange}
                onSelect={handleTagSelect}
                placeholder="Search tag (e.g. blue_eyes)"
                fetchOptions={async (query: string) => {
                  try {
                    return await window.api.searchRemoteTags(query);
                  } catch (error) {
                    console.error("Failed to search tags:", error);
                    return [];
                  }
                }}
              />
            </div>
            <p className="text-[10px] text-zinc-500 ml-1">
              Type the full tag. Post counts like '(123)' will be removed on
              submit.
            </p>
          </div>

          {/* Submit Button */}
          <button
            type="submit"
            disabled={!inputTag}
            className="px-4 py-3 mt-2 w-full text-sm font-bold text-white bg-blue-600 rounded-lg shadow-lg transition-all hover:bg-blue-500 active:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-blue-500/20"
          >
            Start Tracking
          </button>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="src/renderer/components/dialogs/DeleteArtistDialog.tsx">
import React from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useTranslation } from "react-i18next";
import { Loader2, Trash2, AlertCircle } from "lucide-react";
import { Button } from "../ui/button";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "../ui/dialog";
import type { Artist } from "../../../main/db/schema";

interface DeleteArtistDialogProps {
  artist: Artist;
  isOpen: boolean;
  onOpenChange: (open: boolean) => void;
}

export const DeleteArtistDialog: React.FC<DeleteArtistDialogProps> = ({
  artist,
  isOpen,
  onOpenChange,
}) => {
  const { t } = useTranslation();
  const queryClient = useQueryClient();

  const mutation = useMutation({
    mutationFn: async (id: number) => {
      await window.api.deleteArtist(id);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["artists"] });
      onOpenChange(false);
    },
  });

  const getErrorMessage = (error: typeof mutation.error): string => {
    if (!error) return t("common.unknownError", "Unknown error occurred");

    if (error instanceof Error) {
      return error.message;
    }

    return t("common.unknownError", "Unknown error occurred");
  };

  return (
    <Dialog
      open={isOpen}
      onOpenChange={(open) => {
        if (!mutation.isPending) onOpenChange(open);
      }}
    >
      <DialogContent className="sm:max-w-[425px] bg-slate-900 border-slate-700 text-slate-100">
        <DialogHeader>
          <DialogTitle className="flex gap-2 items-center text-red-500">
            <Trash2 className="w-5 h-5" />
            {t("deleteArtist.title", "Delete Artist")}
          </DialogTitle>
          <DialogDescription className="text-slate-400">
            {t(
              "deleteArtist.description",
              "Are you sure you want to delete {{name}}? All posts will be removed.",
              { name: artist.name }
            )}
          </DialogDescription>
        </DialogHeader>

        <div className="p-3 mb-2 rounded border bg-slate-950 border-slate-800">
          <span className="font-bold text-white">{artist.name}</span>
          <div className="mt-1 text-xs text-slate-500">Tag: {artist.tag}</div>
        </div>

        {mutation.isError && (
          <div
            className="flex gap-2 items-center p-3 mb-2 text-sm text-red-200 rounded border border-red-800 bg-red-900/50"
            role="alert"
          >
            <AlertCircle className="w-4 h-4 shrink-0" />
            <span>{getErrorMessage(mutation.error)}</span>
          </div>
        )}

        <DialogFooter>
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={mutation.isPending}
            className="border-slate-700 hover:bg-slate-800 text-slate-200"
          >
            {t("common.cancel", "Cancel")}
          </Button>
          <Button
            variant="destructive"
            onClick={() => mutation.mutate(artist.id)}
            disabled={mutation.isPending}
            className="text-white bg-red-600 hover:bg-red-700"
          >
            {mutation.isPending ? (
              <Loader2 className="mr-2 w-4 h-4 animate-spin" />
            ) : (
              t("common.delete", "Delete")
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
</file>

<file path="src/renderer/components/dialogs/Onboarding.tsx">
import React from "react";
import { useForm } from "react-hook-form";
import { z, ZodIssueOptionalMessage, ErrorMapCtx } from "zod"; // –ò–ú–ü–û–†–¢ –¢–ò–ü–û–í
import { zodResolver } from "@hookform/resolvers/zod";
import { useTranslation } from "react-i18next";
import { Button } from "../ui/button";
import { KeyRound, User } from "lucide-react";
import { credsBaseSchema, CredsFormValues } from "../../schemas/form-schemas";

interface OnboardingProps {
  onComplete: () => void;
}

export const Onboarding: React.FC<OnboardingProps> = ({ onComplete }) => {
  const { t } = useTranslation();

  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
  } = useForm<CredsFormValues>({
    resolver: zodResolver(credsBaseSchema, {
      path: [],
      async: false,
      errorMap: (issue: ZodIssueOptionalMessage, ctx: ErrorMapCtx) => {
        if (issue.code === z.ZodIssueCode.too_small) {
          if (issue.path[0] === "userId") {
            return { message: t("validation.userIdRequired") };
          }
          if (issue.path[0] === "apiKey") {
            return { message: t("validation.apiKeyRequired") };
          }
        }
        return { message: ctx.defaultError };
      },
    }),
  });

  const onSubmit = async (data: CredsFormValues) => {
    try {
      await window.api.saveSettings(data);
      onComplete();
    } catch (e) {
      const message = e instanceof Error ? e.message : "Unknown save error.";
      console.error(`Authorization error: ${message}`);
    }
  };

  return (
    <div className="flex flex-col justify-center items-center p-6 min-h-screen text-white bg-slate-950">
      <div className="p-8 space-y-6 w-full max-w-md rounded-lg border shadow-xl bg-slate-900 border-slate-800">
        <div className="text-center">
          <h1 className="text-2xl font-bold text-blue-500">
            {t("onboarding.title")}
          </h1>
          <p className="mt-2 text-sm text-slate-400">
            {t("onboarding.description")}
          </p>
        </div>

        <div className="p-4 space-y-2 text-sm rounded border bg-slate-950 border-slate-800">
          <p className="font-semibold text-slate-300">
            {t("onboarding.howToGetKeys")}
          </p>
          <ol className="space-y-1 list-decimal list-inside text-slate-400">
            <li>{t("onboarding.step1")}</li>
            <li>{t("onboarding.step2")}</li>
            <li>{t("onboarding.step3")}</li>
          </ol>
          <div className="pt-2 mt-2 border-t border-slate-800">
            <span className="text-xs text-slate-500">
              {t("onboarding.settingsPageAddress")}
            </span>
            <code className="block p-2 mt-1 text-xs break-all rounded cursor-text select-all bg-slate-900">
              https://rule34.xxx/index.php?page=account&s=options
            </code>
          </div>
        </div>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div>
            <label
              htmlFor="user-id-input"
              className="block mb-1 text-sm font-medium text-slate-400"
            >
              {t("onboarding.userId")}
            </label>
            <div className="relative">
              <User className="absolute left-3 top-2.5 h-4 w-4 text-slate-500" />
              <input
                id="user-id-input"
                {...register("userId")}
                className="py-2 pr-3 pl-9 w-full text-white rounded border outline-none bg-slate-950 border-slate-700 focus:ring-2 focus:ring-blue-500"
                placeholder={t("onboarding.userIdPlaceholder")}
              />
            </div>
            {errors.userId && (
              <span className="text-xs text-red-500">
                {errors.userId.message}
              </span>
            )}
          </div>

          <div>
            <label
              htmlFor="api-key-input"
              className="block mb-1 text-sm font-medium text-slate-400"
            >
              {t("onboarding.apiKey")}
            </label>
            <div className="relative">
              <KeyRound className="absolute left-3 top-2.5 h-4 w-4 text-slate-500" />
              <input
                id="api-key-input"
                {...register("apiKey")}
                type="password"
                className="py-2 pr-3 pl-9 w-full text-white rounded border outline-none bg-slate-950 border-slate-700 focus:ring-2 focus:ring-blue-500"
                placeholder={t("onboarding.apiKeyPlaceholder")}
              />
            </div>
            {errors.apiKey && (
              <span className="text-xs text-red-500">
                {errors.apiKey.message}
              </span>
            )}
          </div>

          <Button
            type="submit"
            className="w-full"
            disabled={isSubmitting}
            aria-label={t("onboarding.saveAndLogin")}
          >
            {isSubmitting
              ? t("onboarding.saving")
              : t("onboarding.saveAndLogin")}
          </Button>
        </form>
      </div>
    </div>
  );
};
</file>

<file path="src/renderer/components/gallery/ArtistCard.tsx">
import React, { useState } from "react";
import { useTranslation } from "react-i18next";
import { Trash2, User, Hash, Search } from "lucide-react";
import { Button } from "../ui/button";
import type { Artist } from "../../../main/db/schema";
import { DeleteArtistDialog } from "../dialogs/DeleteArtistDialog";
import { cn } from "../../lib/utils";

interface ArtistCardProps {
  artist: Artist;
  onSelect: (artist: Artist) => void;
}

export const ArtistCard: React.FC<ArtistCardProps> = ({ artist, onSelect }) => {
  const { t } = useTranslation();
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);

  const handleDeleteClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    setIsDeleteDialogOpen(true);
  };

  const getIcon = () => {
    switch (artist.type) {
      case "uploader":
        return <User className="w-4 h-4 text-purple-400" />;
      case "query":
        return <Search className="w-4 h-4 text-emerald-400" />;
      default:
        return <Hash className="w-4 h-4 text-blue-400" />;
    }
  };

  const handleCardClick = () => onSelect(artist);

  return (
    <>
      <div
        className={cn(
          "flex relative justify-between items-center p-1 pr-3 rounded-lg border transition-all group",
          "bg-slate-900/50 border-slate-800",
          "hover:bg-slate-900 hover:border-blue-500/50 hover:shadow-md"
        )}
      >
        <button
          onClick={handleCardClick}
          className={cn(
            "flex-1 p-3 min-w-0 text-left rounded-l-lg transition-colors",
            "focus:outline-none focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900",
            "text-white"
          )}
          aria-label={t("artistCard.selectArtist", { name: artist.name })}
        >
          <div className="flex gap-2 items-center mb-1">
            {/* –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–∫–æ–Ω–∫—É —Ç–∏–ø–∞ */}
            {getIcon()}
            <h3 className="text-lg font-bold truncate transition-colors text-slate-200 group-hover:text-white">
              {artist.name}
            </h3>
          </div>

          <p className="mt-1 font-mono text-xs truncate text-slate-500">
            [{artist.tag}] {t("app.lastId", "Last ID")}: {artist.lastPostId} |{" "}
            {t("app.new", "New")}:{" "}
            <span className={artist.newPostsCount > 0 ? "text-green-400" : ""}>
              {artist.newPostsCount}
            </span>
          </p>
        </button>

        <div className="flex-shrink-0 pl-4">
          <Button
            variant="ghost"
            size="icon"
            className="w-8 h-8 text-slate-500 hover:text-red-500 hover:bg-red-950/20"
            onClick={handleDeleteClick}
            aria-label={t("common.deleteArtist", "Delete Artist")}
            title={t("common.deleteArtist", "Delete Artist")}
          >
            <Trash2 className="w-4 h-4" />
          </Button>
        </div>
      </div>

      <DeleteArtistDialog
        artist={artist}
        isOpen={isDeleteDialogOpen}
        onOpenChange={setIsDeleteDialogOpen}
      />
    </>
  );
};
</file>

<file path="src/renderer/components/layout/AppLayout.tsx">
import { Outlet } from "react-router-dom";
import { Sidebar } from "./Sidebar";
import { GlobalTopBar } from "./GlobalTopBar";
import { useViewerStore } from "../../store/viewerStore";
import { ViewerDialog } from "../viewer/ViewerDialog";

export const AppLayout = () => {
  const isViewerOpen = useViewerStore((state) => state.isOpen);

  return (
    <div className="flex overflow-hidden w-full h-screen bg-background text-foreground">
      {/* Left Rail */}
      <Sidebar />

      {/* Main Content Area */}
      <div className="flex flex-col flex-1 min-w-0">
        <GlobalTopBar />

        {/* Scrollable Content */}
        <main className="overflow-auto flex-1 p-6 bg-background">
          <Outlet />
        </main>
      </div>

      {isViewerOpen && <ViewerDialog />}
    </div>
  );
};
</file>

<file path="src/renderer/components/layout/GlobalTopBar.tsx">
import { Search } from "lucide-react";
import { Input } from "../ui/input";
import { useSearchStore } from "../../store/searchStore";

export const GlobalTopBar = () => {
  const { searchQuery, setSearchQuery } = useSearchStore();

  return (
    <header className="h-14 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 px-6 flex items-center justify-between sticky top-0 z-10">
      <div className="flex flex-1 gap-2 items-center max-w-md">
        <div className="relative flex-1">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder="Search tags..."
            className="pl-9"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>
      </div>

      {/* Right: Actions */}
      <div className="flex gap-2 items-center">
        {/* Placeholder for right actions */}
      </div>
    </header>
  );
};
</file>

<file path="src/renderer/components/pages/ArtistDetails.tsx">
import { useParams, useNavigate } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import { ArtistGallery } from "../gallery/ArtistGallery";
import { Button } from "../ui/button";

export const ArtistDetails = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const artistId = Number(id);

  const { data: artists } = useQuery({
    queryKey: ["artists"],
    queryFn: () => window.api.getTrackedArtists(),
  });

  const artist = artists?.find((a) => a.id === artistId);

  if (!artist) {
    return (
      <div className="flex flex-col gap-4 p-8">
        <div className="text-destructive">Artist not found (ID: {id})</div>
        <Button variant="outline" onClick={() => navigate("/tracked")}>
          Back to Sources
        </Button>
      </div>
    );
  }
  return (
    <div className="flex flex-col h-full">
      <ArtistGallery artist={artist} onBack={() => navigate("/tracked")} />
    </div>
  );
};
</file>

<file path="src/renderer/components/pages/Favorites.tsx">
export const Favorites = () => {
  return (
    <div className="p-4 text-2xl font-bold text-muted-foreground">
      Favorites Page (Stub)
    </div>
  );
};
</file>

<file path="src/renderer/components/pages/Tracked.tsx">
import { useState } from "react";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { useNavigate } from "react-router-dom";
import { Plus } from "lucide-react";
import { ArtistCard } from "../gallery/ArtistCard";
import { AddArtistModal } from "../dialogs/AddArtistModal";
import { Button } from "../ui/button";
import type { Artist } from "../../../main/db/schema";

export const Tracked = () => {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [isAddModalOpen, setIsAddModalOpen] = useState(false);

  // Fetch artists
  const {
    data: artists,
    isLoading,
    error,
  } = useQuery({
    queryKey: ["artists"],
    queryFn: () => window.api.getTrackedArtists(),
  });

  // Handler for adding artist
  const handleAddArtist = async (
    name: string,
    tag: string,
    type: "tag" | "uploader" | "query"
  ) => {
    try {
      await window.api.addArtist({
        name,
        tag,
        type,
        apiEndpoint:
          "https://api.rule34.xxx/index.php?page=dapi&s=post&q=index",
      });
      // Invalidate cache to refresh list
      queryClient.invalidateQueries({ queryKey: ["artists"] });
      setIsAddModalOpen(false);
    } catch (err) {
      console.error("Failed to add artist:", err);
    }
  };

  // Handler for clicking a card
  const handleSelectArtist = (artist: Artist) => {
    navigate(`/artist/${artist.id}`);
  };

  if (isLoading)
    return <div className="p-8 text-muted-foreground">Loading artists...</div>;
  if (error)
    return <div className="p-8 text-red-500">Error loading artists</div>;

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold tracking-tight">Tracked Sources</h1>
        <Button onClick={() => setIsAddModalOpen(true)} className="gap-2">
          <Plus className="w-4 h-4" />
          Add Source
        </Button>
      </div>

      {!artists || artists.length === 0 ? (
        <div className="flex flex-col justify-center items-center h-64 rounded-lg border-2 border-dashed bg-muted/10 text-muted-foreground">
          <p>No tracked artists yet.</p>
          <Button variant="link" onClick={() => setIsAddModalOpen(true)}>
            Add your first one
          </Button>
        </div>
      ) : (
        <div className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {artists.map((artist) => (
            <ArtistCard
              key={artist.id}
              artist={artist}
              onSelect={handleSelectArtist}
            />
          ))}
        </div>
      )}

      <AddArtistModal
        isOpen={isAddModalOpen}
        onClose={() => setIsAddModalOpen(false)}
        onAdd={handleAddArtist}
      />
    </div>
  );
};
</file>

<file path="src/renderer/components/pages/Updates.tsx">
export const Updates = () => {
  return (
    <div className="p-4 text-2xl font-bold text-muted-foreground">
      Updates Page (Stub)
    </div>
  );
};
</file>

<file path="src/renderer/components/settings/BackupControls.tsx">
import { useState } from "react";

export function BackupControls() {
  const [isLoading, setIsLoading] = useState(false);

  const handleBackup = async () => {
    try {
      setIsLoading(true);

      const result = await window.api.createBackup();

      if (result.success) {
        alert(`‚úÖ Backup created successfully!\nPath: ${result.path}`);
      } else {
        alert(`‚ùå IPC call error: ${result.error}`);
      }
    } catch (e) {
      console.error(e);
      alert(
        "–û—à–∏–±–∫–∞ IPC –≤—ã–∑–æ–≤–∞: " + (e instanceof Error ? e.message : String(e))
      );
    } finally {
      setIsLoading(false);
    }
  };

  const handleRestore = async () => {
    if (
      !confirm(
        "‚ö†Ô∏è WARNING: Restoring will overwrite the current database. The application will restart. Continue?"
      )
    ) {
      return;
    }

    try {
      setIsLoading(true);
      const result = await window.api.restoreBackup();

      if (result && !result.success && result.error !== "Canceled by user") {
        alert(`‚ùå Restore failed: ${result.error}`);
      }
    } catch (e) {
      console.error(e);
      alert("IPC call error: " + (e instanceof Error ? e.message : String(e)));
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="p-4 rounded-lg border border-slate-700 bg-slate-900 text-slate-100">
      <h3 className="mb-4 text-lg font-semibold text-slate-200">
        üì¶ Database Management
      </h3>
      <div className="flex gap-4">
        <button
          onClick={handleBackup}
          disabled={isLoading}
          aria-label="Create a full backup of the database"
          className={`px-4 py-2 rounded text-sm font-medium transition-colors ${
            isLoading
              ? "cursor-not-allowed bg-slate-700 text-slate-400"
              : "text-white bg-emerald-600 hover:bg-emerald-700"
          }`}
        >
          {isLoading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : "üíæ –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø"}
        </button>

        <button
          onClick={handleRestore}
          disabled={isLoading}
          aria-label="Restore database from a backup file"
          className={`px-4 py-2 rounded text-sm font-medium transition-colors ${
            isLoading
              ? "cursor-not-allowed bg-slate-700 text-slate-400"
              : "text-white bg-red-600 hover:bg-red-700"
          }`}
        >
          {isLoading ? "Processing..." : "‚ôªÔ∏è Restore from File"}{" "}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/renderer/components/ui/alert.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="src/renderer/components/ui/card.tsx">
import * as React from "react";
import { cn } from "../../lib/utils";

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border shadow-sm bg-card text-card-foreground",
      className
    )}
    {...props}
  />
));
Card.displayName = "Card";

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
));
CardHeader.displayName = "CardHeader";

const CardTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn(
      "text-2xl font-semibold tracking-tight leading-none",
      className
    )}
    {...props}
  />
));
CardTitle.displayName = "CardTitle";

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
));
CardDescription.displayName = "CardDescription";

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
));
CardContent.displayName = "CardContent";

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
));
CardFooter.displayName = "CardFooter";

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardDescription,
  CardContent,
};
</file>

<file path="src/renderer/components/ui/dialog.tsx">
import * as React from "react";
import * as DialogPrimitive from "@radix-ui/react-dialog";
import { useTranslation } from "react-i18next";
import { cn } from "@/lib/utils";
import { Cross2Icon } from "@radix-ui/react-icons";

const Dialog = DialogPrimitive.Root;

const DialogTrigger = DialogPrimitive.Trigger;

const DialogPortal = DialogPrimitive.Portal;

const DialogClose = DialogPrimitive.Close;

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
));
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName;

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => {
  const { t } = useTranslation();
  return (
    <DialogPortal>
      <DialogOverlay />
      <DialogPrimitive.Content
        ref={ref}
        className={cn(
          "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
          className
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close
          className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground"
          aria-label={t("dialog.close")}
        >
          <Cross2Icon className="w-4 h-4" />
          <span className="sr-only">{t("dialog.close")}</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  );
});
DialogContent.displayName = DialogPrimitive.Content.displayName;

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
);
DialogHeader.displayName = "DialogHeader";

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
);
DialogFooter.displayName = "DialogFooter";

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold tracking-tight leading-none",
      className
    )}
    {...props}
  />
));
DialogTitle.displayName = DialogPrimitive.Title.displayName;

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
));
DialogDescription.displayName = DialogPrimitive.Description.displayName;

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogTrigger,
  DialogClose,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
};
</file>

<file path="src/renderer/components/ui/dropdown-menu.tsx">
import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md",
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}
</file>

<file path="src/renderer/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="src/renderer/components/ui/label.tsx">
import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }
</file>

<file path="src/renderer/components/ui/progress.tsx">
import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-2 w-full overflow-hidden rounded-full bg-primary/20",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }
</file>

<file path="src/renderer/components/ui/select.tsx">
import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute right-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}
</file>

<file path="src/renderer/components/ui/separator.tsx">
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }
</file>

<file path="src/renderer/i18n/index.ts">
import i18n from "i18next";
import { initReactI18next } from "react-i18next";

import enTranslation from "../locales/en/translation.json";

i18n.use(initReactI18next).init({
  resources: {
    en: {
      translation: enTranslation,
    },
  },
  lng: "en",
  fallbackLng: "en",
  debug: false,
  interpolation: {
    escapeValue: false,
  },
});

export default i18n;
</file>

<file path="src/renderer/lib/tag-utils.ts">
export function normalizeTag(input: string): string {
  return input
    .trim()
    .replace(/^#\s*/g, "")
    .replace(/^user:/i, "")
    .replace(/\s*\(\d+\)\s*$/g, "")
    .toLowerCase()
    .replace(/\s+/g, "_");
}
</file>

<file path="src/renderer/lib/utils.ts">
import { type ClassValue, clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,

    /* Electron & Vite Types */
    "types": ["node", "vite/client"],

    /* Paths */
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/renderer/*"]
    }
  },
  "include": ["src"],
  "exclude": ["node_modules", "dist", "out"]
}
</file>

<file path=".gitattributes">
* text=auto eol=lf

*.ts text eol=lf
*.tsx text eol=lf
*.js text eol=lf
*.css text eol=lf
*.md text eol=lf
*.json text eol=lf
</file>

<file path="docs/rule34-api-reference.md">
# Rule34.xxx API Reference

This document provides an unofficial technical overview of the public Rule34.xxx API for developers integrating the API into desktop clients or applications.

## API Keys

### Requesting an API Key

**URL:** https://rule34.xxx/index.php?page=account&s=options

Navigate to the account options page to request an API key. You will receive:

- `user_id`: Your user ID
- `api_key`: Your API key for authentication

### API Limits

API limits may be changed at any time without notice. If your application requires higher limits, you can request an unlimited key. This is only applicable for large public projects.

**Requesting Higher Limits:**

- For urgent requests from large sites/apps: Create a ticket on Discord or send a site mail to staff
- Staff contact forum: https://rule34.xxx/index.php?page=forum&s=view&id=4240

**Important:** Rule34.xxx reserves the right to disable or deny any API key at their discretion.

## API Terms of Service

When using the Rule34.xxx API or serving content from their CDN, you must comply with the following terms:

1. **No Advertisements or Paywalls:** You must not display any advertisements or run paywalls. This applies to all bots, apps, and websites using the API or CDN content.

2. **Single API Key Rule:** Do not use or request more than one API key. Using multiple keys will result in suspension of your key or account.

3. **Key Suspension:** Violation of these terms may result in immediate suspension of your API key or account.

## Endpoints

### Posts

#### List Posts

**URL:** `https://api.rule34.xxx/index.php?page=dapi&s=post&q=index`

**Method:** GET

**Parameters:**

| Parameter | Type    | Description                   | Constraints                                                        |
| --------- | ------- | ----------------------------- | ------------------------------------------------------------------ |
| `limit`   | integer | Number of posts to retrieve   | Hard limit: 1000 posts per request                                 |
| `pid`     | integer | Page number                   | -                                                                  |
| `tags`    | string  | Tag combination to search for | Any tag combination that works on the website, including meta-tags |
| `cid`     | integer | Change ID of the post         | Unix timestamp (may have duplicates if updated simultaneously)     |
| `id`      | integer | Post ID                       | -                                                                  |
| `json`    | integer | Response format               | Set to `1` for JSON, omit for XML                                  |

**Notes:**

- Default response format is XML unless `json=1` is specified
- Tag combinations follow the same rules as the website search
- See the cheatsheet for information on meta-tags

**Example:**

```
https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&tags=tag1+tag2&limit=100&json=1
```

### Deleted Images

#### List Deleted Images

**URL:** `https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&deleted=show`

**Method:** GET

**Parameters:**

| Parameter | Type    | Description     | Constraints                          |
| --------- | ------- | --------------- | ------------------------------------ |
| `last_id` | integer | Numerical value | Returns everything above this number |

**Notes:**

- This endpoint requires the `deleted=show` parameter in the URL
- Use `last_id` to paginate through deleted images

**Example:**

```
https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&deleted=show&last_id=12345
```

### Comments

#### List Comments

**URL:** `https://api.rule34.xxx/index.php?page=dapi&s=comment&q=index`

**Method:** GET

**Parameters:**

| Parameter | Type    | Description    | Constraints                                 |
| --------- | ------- | -------------- | ------------------------------------------- |
| `post_id` | integer | Post ID number | The ID of the post to retrieve comments for |

**Example:**

```
https://api.rule34.xxx/index.php?page=dapi&s=comment&q=index&post_id=123456
```

### Tags

#### List Tags

**URL:** `https://api.rule34.xxx/index.php?page=dapi&s=tag&q=index`

**Method:** GET

**Parameters:**

| Parameter | Type    | Description                | Constraints                                                  |
| --------- | ------- | -------------------------- | ------------------------------------------------------------ |
| `id`      | integer | Tag ID in the database     | Useful to retrieve a specific tag if you already know the ID |
| `limit`   | integer | Number of tags to retrieve | Default limit: 100 tags per request                          |

**Example:**

```
https://api.rule34.xxx/index.php?page=dapi&s=tag&q=index&limit=500
```

### Autocomplete

#### Tag Autocomplete

**URL:** `https://api.rule34.xxx/autocomplete.php?q=`

**Method:** GET

**Parameters:**

| Parameter | Type   | Description  | Constraints                        |
| --------- | ------ | ------------ | ---------------------------------- |
| `q`       | string | Search query | Enter any letter or incomplete tag |

**Notes:**

- This is not an official endpoint, but it is available for use
- Some implementations may use the autocomplete from the main site; use this endpoint instead
- Returns suggestions based on partial tag input

**Example:**

```
https://api.rule34.xxx/autocomplete.php?q=char
```

## Best Practices and Cautions

### Rate Limiting

- Implement exponential backoff for rate limit errors
- Respect API limits and avoid aggressive polling
- Monitor your request frequency to prevent IP or key bans
- Consider caching responses to reduce API calls

### Caching

- Cache tag lists and autocomplete results (they change infrequently)
- Cache post metadata to reduce redundant requests
- Implement appropriate cache invalidation strategies
- Be mindful of cache size and memory usage

### Terms of Service Compliance

- **Never display advertisements** when using the API or serving CDN content
- **Never implement paywalls** for content accessed via the API
- **Use only one API key** per application or project
- Review and comply with all ToS requirements before deployment

### Key Management

- Store API keys securely (use Electron secure storage or similar)
- Never commit API keys to version control
- Monitor for key suspension notifications
- Have a plan for handling key revocation

### Error Handling

- Implement proper error handling for network failures
- Handle rate limit responses gracefully
- Log errors for debugging without exposing sensitive information
- Provide user-friendly error messages

### Performance Considerations

- Use pagination (`pid` parameter) for large result sets
- Respect the 1000 post limit per request
- Consider parallel requests for independent data (with rate limiting)
- Optimize tag queries to reduce response size

### Security

- Validate all user input before constructing API requests
- Sanitize tag strings to prevent injection attacks
- Use HTTPS for all API requests
- Implement request timeout handling

### Development Recommendations

- Test with small limits first before scaling up
- Monitor API response times and adjust polling intervals accordingly
- Implement retry logic with exponential backoff
- Use JSON format (`json=1`) for easier parsing in modern applications
- Document your API usage patterns for troubleshooting
</file>

<file path="LICENSE">
Apache License
                           Version 2.0, January 2004
                        http://www.apache.org/licenses/

   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

   1. Definitions.

      "License" shall mean the terms and conditions for use, reproduction,
      and distribution as defined by Sections 1 through 9 of this document.

      "Licensor" shall mean the copyright owner or entity authorized by
      the copyright owner that is granting the License.

      "Legal Entity" shall mean the union of the acting entity and all
      other entities that control, are controlled by, or are under common
      control with that entity. For the purposes of this definition,
      "control" means (i) the power, direct or indirect, to cause the
      direction or management of such entity, whether by contract or
      otherwise, or (ii) ownership of fifty percent (50%) or more of the
      outstanding shares, or (iii) beneficial ownership of such entity.

      "You" (or "Your") shall mean an individual or Legal Entity
      exercising permissions granted by this License.

      "Source" form shall mean the preferred form for making modifications,
      including but not limited to software source code, documentation
      source, and configuration files.

      "Object" form shall mean any form resulting from mechanical
      transformation or translation of a Source form, including but
      not limited to compiled object code, generated documentation,
      and conversions to other media types.

      "Work" shall mean the work of authorship, whether in Source or
      Object form, made available under the License, as indicated by a
      copyright notice that is included in or attached to the work
      (an example is provided in the Appendix below).

      "Derivative Works" shall mean any work, whether in Source or Object
      form, that is based on (or derived from) the Work and for which the
      editorial revisions, annotations, elaborations, or other modifications
      represent, as a whole, an original work of authorship. For the purposes
      of this License, Derivative Works shall not include works that remain
      separable from, or merely link (or bind by name) to the interfaces of,
      the Work and Derivative Works thereof.

      "Contribution" shall mean any work of authorship, including
      the original version of the Work and any modifications or additions
      to that Work or Derivative Works thereof, that is intentionally
      submitted to Licensor for inclusion in the Work by the copyright owner
      or by an individual or Legal Entity authorized to submit on behalf of
      the copyright owner. For the purposes of this definition, "submitted"
      means any form of electronic, verbal, or written communication sent
      to the Licensor or its representatives, including but not limited to
      communication on electronic mailing lists, source code control systems,
      and issue tracking systems that are managed by, or on behalf of, the
      Licensor for the purpose of discussing and improving the Work, but
      excluding communication that is conspicuously marked or otherwise
      designated in writing by the copyright owner as "Not a Contribution."

      "Contributor" shall mean Licensor and any individual or Legal Entity
      on behalf of whom a Contribution has been received by Licensor and
      subsequently incorporated within the Work.

   2. Grant of Copyright License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      copyright license to reproduce, prepare Derivative Works of,
      publicly display, publicly perform, sublicense, and distribute the
      Work and such Derivative Works in Source or Object form.

   3. Grant of Patent License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      (except as stated in this section) patent license to make, have made,
      use, offer to sell, sell, import, and otherwise transfer the Work,
      where such license applies only to those patent claims licensable
      by such Contributor that are necessarily infringed by their
      Contribution(s) alone or by combination of their Contribution(s)
      with the Work to which such Contribution(s) was submitted. If You
      institute patent litigation against any entity (including a
      cross-claim or counterclaim in a lawsuit) alleging that the Work
      or a Contribution incorporated within the Work constitutes direct
      or contributory patent infringement, then any patent licenses
      granted to You under this License for that Work shall terminate
      as of the date such litigation is filed.

   4. Redistribution. You may reproduce and distribute copies of the
      Work or Derivative Works thereof in any medium, with or without
      modifications, and in Source or Object form, provided that You
      meet the following conditions:

      (a) You must give any other recipients of the Work or
          Derivative Works a copy of this License; and

      (b) You must cause any modified files to carry prominent notices
          stating that You changed the files; and

      (c) You must retain, in the Source form of any Derivative Works
          that You distribute, all copyright, patent, trademark, and
          attribution notices from the Source form of the Work,
          excluding those notices that do not pertain to any part of
          the Derivative Works; and

      (d) If the Work includes a "NOTICE" text file as part of its
          distribution, then any Derivative Works that You distribute must
          include a readable copy of the attribution notices contained
          within such NOTICE file, excluding those notices that do not
          pertain to any part of the Derivative Works, in at least one
          of the following places: within a NOTICE text file distributed
          as part of the Derivative Works; within the Source form or
          documentation, if provided along with the Derivative Works; or,
          within a display generated by the Derivative Works, if and
          wherever such third-party notices normally appear. The contents
          of the NOTICE file are for informational purposes only and
          do not modify the License. You may add Your own attribution
          notices within Derivative Works that You distribute, alongside
          or as an addendum to the NOTICE text from the Work, provided
          that such additional attribution notices cannot be construed
          as modifying the License.

      You may add Your own copyright statement to Your modifications and
      may provide additional or different license terms and conditions
      for use, reproduction, or distribution of Your modifications, or
      for any such Derivative Works as a whole, provided Your use,
      reproduction, and distribution of the Work otherwise complies with
      the conditions stated in this License.

   5. Submission of Contributions. Unless You explicitly state otherwise,
      any Contribution intentionally submitted for inclusion in the Work
      by You to the Licensor shall be under the terms and conditions of
      this License, without any additional terms or conditions.
      Notwithstanding the above, nothing herein shall supersede or modify
      the terms of any separate license agreement you may have executed
      with Licensor regarding such Contributions.

   6. Trademarks. This License does not grant permission to use the trade
      names, trademarks, service marks, or product names of the Licensor,
      except as required for reasonable and customary use in describing the
      origin of the Work and reproducing the content of the NOTICE file.

   7. Disclaimer of Warranty. Unless required by applicable law or
      agreed to in writing, Licensor provides the Work (and each
      Contributor provides its Contributions) on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
      implied, including, without limitation, any warranties or conditions
      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
      PARTICULAR PURPOSE. You are solely responsible for determining the
      appropriateness of using or redistributing the Work and assume any
      risks associated with Your exercise of permissions under this License.

   8. Limitation of Liability. In no event and under no legal theory,
      whether in tort (including negligence), contract, or otherwise,
      unless required by applicable law (such as deliberate and grossly
      negligent acts) or agreed to in writing, shall any Contributor be
      liable to You for damages, including any direct, indirect, special,
      incidental, or consequential damages of any character arising as a
      result of this License or out of the use or inability to use the
      Work (including but not limited to damages for loss of goodwill,
      work stoppage, computer failure or malfunction, or any and all
      other commercial damages or losses), even if such Contributor
      has been advised of the possibility of such damages.

   9. Accepting Warranty or Additional Liability. While redistributing
      the Work or Derivative Works thereof, You may choose to offer,
      and charge a fee for, acceptance of support, warranty, indemnity,
      or other liability obligations and/or rights consistent with this
      License. However, in accepting such obligations, You may act only
      on Your own behalf and on Your sole responsibility, not on behalf
      of any other Contributor, and only if You agree to indemnify,
      defend, and hold each Contributor harmless for any liability
      incurred by, or claims asserted against, such Contributor by reason
      of your accepting any such warranty or additional liability.

   END OF TERMS AND CONDITIONS

   APPENDIX: How to apply the Apache License to your work.

      To apply the Apache License to your work, attach the following
      boilerplate notice, with the fields enclosed by brackets "[]"
      replaced with your own identifying information. (Don't include
      the brackets!)  The text should be enclosed in the appropriate
      comment syntax for the file format. We also recommend that a
      file or class name and description of purpose be included on the
      same "printed page" as the copyright notice for easier
      identification within third-party archives.

   Copyright [yyyy] [name of copyright owner]

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="src/main/db/migrate.ts">
import { migrate } from "drizzle-orm/better-sqlite3/migrator";
import * as path from "path";
import { app } from "electron";
import { logger } from "../lib/logger";
import { type BetterSQLite3Database } from "drizzle-orm/better-sqlite3";
import * as schema from "./schema";

type DbType = BetterSQLite3Database<typeof schema>;

export function runMigrations(db: DbType) {
  logger.info("Migrations: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");

  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ –ø–∞–ø–∫–µ –º–∏–≥—Ä–∞—Ü–∏–π
  // –í Production (ASAR): process.resourcesPath/drizzle
  // –í Development: <project_root>/drizzle (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ dist/main/../../)
  const migrationsFolder = app.isPackaged
    ? path.join(process.resourcesPath, "drizzle")
    : path.join(__dirname, "../../drizzle");

  logger.info(`Migrations: –ü—É—Ç—å –∫ –º–∏–≥—Ä–∞—Ü–∏—è–º: ${migrationsFolder}`);

  try {
    migrate(db, { migrationsFolder });
    logger.info("Migrations: –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.");
  } catch (error) {
    logger.error("Migrations: FATAL ERROR", error);
    throw error;
  }
}
</file>

<file path="src/main/ipc/handlers/viewer.ts">
import { ipcMain, shell } from "electron";
import { URL } from "url";
import { logger } from "../../lib/logger";
import { IPC_CHANNELS } from "../channels";

export const registerViewerHandlers = () => {
  // Open External
  ipcMain.handle(
    IPC_CHANNELS.APP.OPEN_EXTERNAL,
    async (_, urlString: string) => {
      try {
        const parsedUrl = new URL(urlString);
        if (
          parsedUrl.protocol === "https:" &&
          (parsedUrl.hostname === "rule34.xxx" ||
            parsedUrl.hostname === "www.rule34.xxx")
        ) {
          await shell.openExternal(urlString);
        } else {
          logger.warn(`IPC: Blocked unauthorized URL: ${urlString}`);
        }
      } catch (error) {
        logger.error(`IPC: Invalid URL passed to open-external`, error);
      }
    }
  );
};
</file>

<file path="src/main/lib/logger.ts">
import log from "electron-log";
import path from "path";

let userDataPath = "";

try {
  if (process.type === "browser") {
    // eslint-disable-next-line @typescript-eslint/no-require-imports
    const { app } = require("electron");
    userDataPath = app.getPath("userData");
  } else {
    userDataPath = process.env.USER_DATA_PATH || process.cwd();
  }
} catch (_) {
  userDataPath = process.cwd();
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π –∏ —Ñ–æ—Ä–º–∞—Ç–∞
log.transports.file.resolvePathFn = () =>
  path.join(userDataPath, "logs", "app.log");

log.transports.file.level = "info";
log.transports.console.format = "[{h}:{i}:{s}.{ms}] [{level}] {text}";

// –ü–µ—Ä–µ—Ö–≤–∞—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
log.errorHandler.startCatching();

export const logger = log;
</file>

<file path="src/main/services/artists.service.ts">
import { eq, desc, asc, like } from "drizzle-orm";
import { getDatabase } from "../db";
import { artists } from "../db/schema";
import type { Artist, NewArtist } from "../db/schema";

export class ArtistsService {
  private get db() {
    return getDatabase();
  }

  async getAll(sortBy: "name" | "created_at" = "name"): Promise<Artist[]> {
    return this.db.query.artists.findMany({
      orderBy: sortBy === "name" ? asc(artists.name) : desc(artists.createdAt),
    });
  }

  async getById(id: number): Promise<Artist | undefined> {
    return this.db.query.artists.findFirst({
      where: eq(artists.id, id),
    });
  }

  async searchTags(query: string): Promise<Artist[]> {
    return this.db.query.artists.findMany({
      where: like(artists.tag, `%${query}%`),
      limit: 20,
    });
  }

  async getByTag(tag: string): Promise<Artist | undefined> {
    return this.db.query.artists.findFirst({
      where: eq(artists.tag, tag),
    });
  }

  async add(artistData: NewArtist): Promise<Artist> {
    const [created] = await this.db
      .insert(artists)
      .values(artistData)
      .returning();
    return created;
  }

  async update(id: number, changes: Partial<Artist>): Promise<boolean> {
    const result = await this.db
      .update(artists)
      .set(changes)
      .where(eq(artists.id, id));

    return result.changes > 0;
  }

  async delete(id: number): Promise<boolean> {
    const result = await this.db.delete(artists).where(eq(artists.id, id));
    return result.changes > 0;
  }

  async resetNewPostsCount(id: number): Promise<boolean> {
    const result = await this.db
      .update(artists)
      .set({ newPostsCount: 0 })
      .where(eq(artists.id, id));

    return result.changes > 0;
  }
}
</file>

<file path="src/main/services/secure-storage.ts">
import { safeStorage } from "electron";
import { logger } from "../lib/logger";

export class SecureStorage {
  /**
   * Encrypts a string using Electron's safeStorage.
   * @throws Error if encryption is unavailable or fails.
   */
  public static encrypt(plainText: string): string {
    if (!plainText) return "";

    if (!safeStorage.isEncryptionAvailable()) {
      const error = "CRITICAL: Encryption is not available on this system.";
      logger.error(`[SecureStorage] ${error}`);
      throw new Error(error);
    }

    try {
      const buffer = safeStorage.encryptString(plainText);
      return buffer.toString("base64");
    } catch (error) {
      logger.error("[SecureStorage] Encryption failed:", error);
      throw new Error("Failed to encrypt data.");
    }
  }

  /**
   * Decrypts a base64 encoded string.
   * Returns the original string or null if decryption fails.
   */
  public static decrypt(encryptedBase64: string): string | null {
    if (!encryptedBase64) return null;

    if (!safeStorage.isEncryptionAvailable()) {
      logger.error("[SecureStorage] Cannot decrypt: Encryption unavailable.");
      return null;
    }

    try {
      const buffer = Buffer.from(encryptedBase64, "base64");
      return safeStorage.decryptString(buffer);
    } catch (error) {
      logger.error("[SecureStorage] Decryption failed:", error);
      return null; // Fail safe: return null, never return raw garbage
    }
  }
}
</file>

<file path="src/main/services/updater-service.ts">
import pkg from "electron-updater";
const { autoUpdater } = pkg;
import { logger } from "../lib/logger";
import { BrowserWindow, shell } from "electron";

const isPortable = !!process.env.PORTABLE_EXECUTABLE_DIR;

export class UpdaterService {
  private window: BrowserWindow | null = null;

  constructor() {
    this.initListeners();
  }

  public setWindow(window: BrowserWindow) {
    this.window = window;
  }

  private initListeners() {
    autoUpdater.logger = logger;

    autoUpdater.autoDownload = false;
    autoUpdater.autoInstallOnAppQuit = false;

    // @ts-expect-error: signature validation disabled
    autoUpdater.verifyUpdateCodeSignature = false;

    autoUpdater.on("checking-for-update", () => {
      logger.info("UPDATER: Checking...");
      this.sendStatus("checking");
    });

    autoUpdater.on("update-available", (info) => {
      logger.info(`UPDATER: Update available: ${info.version}`);
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é UI, –Ω–æ –Ω–µ –∫–∞—á–∞–µ–º
      this.sendPayload("updater:status", {
        status: "available",
        version: info.version,
        isPortable: isPortable,
      });
    });

    autoUpdater.on("update-not-available", (info) => {
      logger.info(`UPDATER: No update. Current: ${info.version}`);
      this.sendStatus("not-available");
    });

    autoUpdater.on("error", (err) => {
      logger.error("UPDATER: Error:", err);
      this.sendStatus("error", err.message);
    });

    autoUpdater.on("download-progress", (progressObj) => {
      this.sendPayload("updater:progress", progressObj.percent);
    });

    autoUpdater.on("update-downloaded", (info) => {
      logger.info(`UPDATER: Downloaded ${info.version}`);
      this.sendStatus("downloaded");
    });
  }

  private sendPayload(channel: string, data: unknown) {
    if (this.window && !this.window.isDestroyed()) {
      this.window.webContents.send(channel, data);
    }
  }

  private sendStatus(status: string, message?: string) {
    this.sendPayload("updater:status", { status, message });
  }

  // === PUBLIC API (–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ IPC —Å–ª–æ—è) ===

  public async checkForUpdates() {
    try {
      await autoUpdater.checkForUpdates();
    } catch (e) {
      logger.error("UPDATER: Check failed", e);
    }
  }

  public async downloadUpdate() {
    if (isPortable) {
      logger.info("UPDATER: Portable detected. Opening GitHub releases.");
      await shell.openExternal(
        "https://github.com/KazeKaze93/ruledesk/releases/latest"
      );
      return;
    }

    logger.info("UPDATER: User requested download starting...");
    return autoUpdater.downloadUpdate();
  }

  public quitAndInstall() {
    logger.info("UPDATER: Quitting and installing...");
    autoUpdater.quitAndInstall();
  }
}

export const updaterService = new UpdaterService();
</file>

<file path="src/renderer/components/dialogs/UpdateNotification.tsx">
import { useEffect, useState } from "react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from "../ui/dialog";
import { Button } from "../ui/button";
import { Progress } from "../ui/progress";
import { useTranslation } from "react-i18next";
import { Loader2, Download, RefreshCw } from "lucide-react";
import type { UpdateStatusData } from "../../../main/bridge";

export const UpdateNotification = () => {
  const { t } = useTranslation();
  const [isOpen, setIsOpen] = useState(false);
  const [status, setStatus] = useState<
    "available" | "downloading" | "downloaded" | "error"
  >("available");
  const [progress, setProgress] = useState(0);
  const [version, setVersion] = useState("");
  const [isPortable, setIsPortable] = useState(false);

  useEffect(() => {
    const removeStatusListener = window.api.onUpdateStatus(
      (data: UpdateStatusData) => {
        console.log("Update status:", data);

        if (data.status === "available") {
          setVersion(data.version || "");
          setIsPortable(!!data.isPortable);
          setIsOpen(true);
          setStatus("available");
        } else if (data.status === "downloading") {
          setStatus("downloading");
        } else if (data.status === "downloaded") {
          setStatus("downloaded");
        } else if (data.status === "error") {
          setStatus("error");
          console.error("Update error:", data.message);
        }
      }
    );

    const removeProgressListener = window.api.onUpdateProgress(
      (percent: number) => {
        setProgress(percent);
      }
    );

    return () => {
      removeStatusListener();
      removeProgressListener();
    };
  }, []);

  const handleAction = () => {
    if (status === "available") {
      window.api.startDownload();
      if (!isPortable) {
        setStatus("downloading");
      } else {
        setIsOpen(false);
      }
    } else if (status === "downloaded") {
      window.api.quitAndInstall();
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle className="flex gap-2 items-center">
            <RefreshCw className="w-5 h-5 text-primary" />
            {t("updates.newVersionTitle", "Update Available")}
          </DialogTitle>
          <DialogDescription>
            {t(
              "updates.newVersionDesc",
              "A new version {{version}} is available.",
              { version }
            )}
          </DialogDescription>
        </DialogHeader>

        <div className="py-4">
          {status === "downloading" && (
            <div className="space-y-2">
              <div className="flex justify-between text-xs text-muted-foreground">
                <span>Downloading...</span>
                <span>{Math.round(progress)}%</span>
              </div>
              <Progress value={progress} className="h-2" />
            </div>
          )}

          {status === "downloaded" && (
            <div className="p-3 text-sm text-green-500 rounded-md bg-green-500/10">
              Update downloaded and ready to install.
            </div>
          )}

          {status === "error" && (
            <div className="p-3 text-sm text-red-500 rounded-md bg-red-500/10">
              Failed to download update. Please try again later.
            </div>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => setIsOpen(false)}>
            {t("common.cancel", "Cancel")}
          </Button>

          <Button onClick={handleAction} disabled={status === "downloading"}>
            {status === "available" && (
              <>
                <Download className="mr-2 w-4 h-4" />
                {isPortable
                  ? "Open Download Page"
                  : t("updates.download", "Download")}
              </>
            )}
            {status === "downloading" && (
              <>
                <Loader2 className="mr-2 w-4 h-4 animate-spin" />
                Downloading...
              </>
            )}
            {status === "downloaded" &&
              t("updates.restart", "Restart & Install")}
            {status === "error" && "Retry"}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
</file>

<file path="src/renderer/lib/artist-utils.ts">
// –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–≥–∞/—é–∑–µ—Ä–Ω–µ–π–º–∞ –¥–ª—è API
export function getArtistTag(
  name: string,
  type: "tag" | "uploader" | "query"
): string {
  const trimmedName = name.trim();

  if (type === "uploader") {
    // –î–ª—è Uploader: 'user:username'
    return `user:${trimmedName}`;
  }
  // –î–ª—è Tag: 'tag_name' (–Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, –ø—Ä–æ–±–µ–ª—ã –≤ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è)
  return trimmedName.toLowerCase().replace(/ /g, "_");
}
</file>

<file path="src/renderer/lib/hooks/useDebounce.ts">
import { useEffect, useState } from "react";

export function useDebounce<T>(value: T, delay?: number): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);

  useEffect(() => {
    const timer = setTimeout(() => setDebouncedValue(value), delay || 500);

    return () => {
      clearTimeout(timer);
    };
  }, [value, delay]);

  return debouncedValue;
}
</file>

<file path="src/renderer/main.tsx">
import React from "react";
import ReactDOM from "react-dom/client";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import App from "./App";
import "./index.css";
import "./i18n";

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      refetchOnWindowFocus: false,
      retry: 1,
    },
  },
});

ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <QueryClientProvider client={queryClient}>
      <App />
    </QueryClientProvider>
  </React.StrictMode>
);
</file>

<file path="src/renderer/schemas/form-schemas.ts">
import { z } from "zod";

// --- 1. Artist Schema ---

export const artistBaseSchema = z.object({
  name: z.string().min(1),
  type: z.enum(["tag", "uploader", "query"]),
  apiEndpoint: z.string().url(),
});

export type ArtistFormValues = z.infer<typeof artistBaseSchema>;

// --- 2. Creds Schema (Onboarding) ---

export const credsBaseSchema = z.object({
  userId: z.string().min(1),
  apiKey: z.string().min(5),
});

export type CredsFormValues = z.infer<typeof credsBaseSchema>;
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: ["./src/renderer/index.html", "./src/renderer/**/*.{js,ts,jsx,tsx}"],
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
      fontFamily: {
        sans: ["Inter", "ui-sans-serif", "system-ui", "sans-serif"], // <-- –î–æ–±–∞–≤—å —ç—Ç–æ
      },
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
    },
  },
  plugins: [],
};
</file>

<file path=".gitignore">
# .gitignore

# --- Node ---
/node_modules
/dist
npm-debug.log
.npm/
.yarn/
.pnp.js
.pnp.cjs

# --- Build/Vite/Electron ---
# –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Electron-Vite
/out
/dist
/dist-electron
/release

# –õ–æ–≥–∏ –∏ –∫—ç—à
.electron-builder
.electron-vite

# --- TypeScript ---
# –§–∞–π–ª—ã –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π, –µ—Å–ª–∏ –æ–Ω–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è
/temp

# --- Drizzle ORM / SQLite ---
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
/data/*.db # –ù–∞–ø—Ä–∏–º–µ—Ä, data/metadata.db
/drizzle # –ü–∞–ø–∫–∞ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
/drizzle/meta/           # –ò—Å–∫–ª—é—á–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–ø–∞–ø–∫–∞)
/drizzle/migrations.json # –ò—Å–∫–ª—é—á–∞–µ—Ç —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π Drizzle –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ

# --- IDEs / OS ---
.vscode
.idea
*.log
.DS_Store
Thumbs.db

/settings.json

# --- –õ–æ–∫–∞–ª—å–Ω–∞—è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –°–µ–∫—Ä–µ—Ç—ã ---
.env               # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å–µ–∫—Ä–µ—Ç–æ–≤
.env.local         # –õ–æ–∫–∞–ª—å–Ω—ã–µ/–¥–µ–≤–µ–ª–æ–ø–µ—Ä—Å–∫–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
.env.*

# Portable data folder
/data
/dist
/release
*.db
*.db-journal
*.log

# --- AI & Tools ---
.ai/*
!.ai/CONTEXT.md
repomix-output.xml
repomix-output.txt
.repomix/
</file>

<file path="src/renderer/components/gallery/PostCard.tsx">
import React from "react";
import { Play, Check, Heart } from "lucide-react";
import { cn } from "../../lib/utils";
import type { Post } from "../../../main/db/schema";

interface PostCardProps {
  post: Post;
  onClick?: (post: Post) => void;
  onToggleFavorite?: (post: Post) => void;
}

const isVideo = (url: string) => url.endsWith(".mp4") || url.endsWith(".webm");

export const PostCard: React.FC<PostCardProps> = ({
  post,
  onClick,
  onToggleFavorite,
}) => {
  const isVid = isVideo(post.fileUrl);

  const handleLike = (e: React.MouseEvent) => {
    e.stopPropagation();
    onToggleFavorite?.(post);
  };

  return (
    <div className="group relative aspect-[2/3] w-full overflow-hidden rounded-lg border bg-card transition-all hover:shadow-md hover:shadow-primary/10">
      {/* –ö–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è (–∫–∞—Ä—Ç–∏–Ω–∫–∞) */}
      <button
        type="button"
        onClick={() => onClick?.(post)}
        className="w-full h-full focus:outline-none cursor-zoom-in"
        aria-label={`View post ${post.id}`}
      >
        {post.previewUrl ? (
          <img
            src={post.previewUrl}
            alt={`Post ${post.id}`}
            loading="lazy"
            className={cn(
              "h-full w-full object-cover transition-transform duration-300",
              "group-hover:scale-105",
              post.isViewed && "opacity-60 grayscale-[0.3]"
            )}
          />
        ) : (
          <div className="flex justify-center items-center w-full h-full text-xs bg-muted text-muted-foreground">
            No Preview
          </div>
        )}
      </button>

      {/* --- Overlays --- */}

      {/* 1. Video Indicator (Top Right) */}
      {isVid && (
        <div className="absolute right-2 top-2 rounded-full bg-black/50 p-1.5 backdrop-blur-sm pointer-events-none">
          <Play className="w-3 h-3 text-white fill-white" />
        </div>
      )}

      {/* 2. Interactive Actions (Top Left) */}
      <div className="flex absolute top-2 left-2 z-10 gap-1 items-center">
        {/* –ö–Ω–æ–ø–∫–∞ –õ–ê–ô–ö–ê */}
        <button
          onClick={handleLike}
          className={cn(
            "p-1.5 rounded-full shadow-sm transition-colors backdrop-blur-md",
            post.isFavorited
              ? "bg-red-500/90 hover:bg-red-600"
              : "bg-black/40 hover:bg-black/60"
          )}
        >
          <Heart
            className={cn(
              "w-3.5 h-3.5 transition-colors",
              post.isFavorited
                ? "text-white fill-white"
                : "text-white/70 hover:text-white"
            )}
          />
        </button>

        {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ" (–Ω–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π) */}
        {post.isViewed && (
          <div className="p-1.5 rounded-full shadow-sm bg-primary/90 pointer-events-none">
            <Check className="w-3.5 h-3.5 stroke-[3] text-primary-foreground" />
          </div>
        )}
      </div>

      {/* 3. Rating Gradient (Bottom) */}
      <div className="flex absolute inset-0 flex-col justify-end p-3 bg-gradient-to-t via-transparent to-transparent opacity-0 transition-opacity duration-200 pointer-events-none from-black/80 group-hover:opacity-100">
        <span
          className={cn(
            "text-xs font-bold uppercase tracking-wider",
            post.rating === "e"
              ? "text-red-400"
              : post.rating === "q"
              ? "text-yellow-400"
              : "text-green-400"
          )}
        >
          {post.rating === "s"
            ? "Safe"
            : post.rating === "q"
            ? "Quest."
            : "Explicit"}
        </span>
      </div>
    </div>
  );
};
</file>

<file path="src/renderer/components/inputs/AsyncAutocomplete.tsx">
import { useState, useEffect, useRef } from "react";
import { Combobox, Transition } from "@headlessui/react";
import { ChevronUpDownIcon, CheckIcon } from "@heroicons/react/20/solid";
import { useDebounce } from "../../lib/hooks/useDebounce";
import { Fragment } from "react";

export interface AutocompleteOption {
  id: string | number;
  label: string;
}

export interface AsyncAutocompleteProps {
  label: string;
  fetchOptions: (query: string) => Promise<AutocompleteOption[]>;
  onSelect: (option: AutocompleteOption | null) => void;
  onQueryChange?: (query: string) => void;
  placeholder?: string;
  value?: string;
  onBlur?: () => void;
}

export function AsyncAutocomplete({
  label,
  fetchOptions,
  onSelect,
  onQueryChange,
  placeholder = "Type to search...",
  value,
  onBlur,
}: AsyncAutocompleteProps) {
  // Controlled vs Uncontrolled state logic
  const isControlled = value !== undefined;
  const [internalQuery, setInternalQuery] = useState(value || "");
  const query = isControlled ? value : internalQuery;

  const [options, setOptions] = useState<AutocompleteOption[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [selectedOption, setSelectedOption] =
    useState<AutocompleteOption | null>(null);

  const debouncedQuery = useDebounce(query, 300);
  const fetchOptionsRef = useRef(fetchOptions);

  useEffect(() => {
    fetchOptionsRef.current = fetchOptions;
  }, [fetchOptions]);

  // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–∏—Å–∫–∞
  useEffect(() => {
    const currentQuery = debouncedQuery || "";
    const trimmedQuery = currentQuery.trim();

    if (!trimmedQuery) {
      return;
    }

    let active = true;

    // eslint-disable-next-line react-hooks/set-state-in-effect
    setIsLoading(true);

    fetchOptionsRef
      .current(trimmedQuery)
      .then((results) => {
        if (active) {
          setOptions(results);
        }
      })
      .catch((err) => console.error("Search error:", err))
      .finally(() => {
        if (active) setIsLoading(false);
      });

    return () => {
      active = false;
    };
  }, [debouncedQuery]);

  const handleSelect = (option: AutocompleteOption | null) => {
    setSelectedOption(option);
    const newQuery = option?.label || "";

    if (!isControlled) {
      setInternalQuery(newQuery);
    }

    onSelect(option);
    onQueryChange?.(newQuery);
  };

  const handleInputChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const newQuery = event.target.value;

    if (!isControlled) {
      setInternalQuery(newQuery);
    }

    onQueryChange?.(newQuery);

    if (selectedOption && newQuery !== selectedOption.label) {
      setSelectedOption(null);
      onSelect(null);
    }

    if (newQuery.trim() === "") {
      setOptions([]);
      setIsLoading(false);
    }
  };

  return (
    <Combobox value={selectedOption} onChange={handleSelect} nullable>
      <div className="relative">
        <Combobox.Label className="block mb-1 text-sm font-medium text-slate-400">
          {label}
        </Combobox.Label>
        <div className="relative">
          <Combobox.Input
            className="px-3 py-2 pr-10 w-full text-white rounded border bg-slate-950 border-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-slate-600"
            displayValue={(option: AutocompleteOption | null) =>
              option?.label ?? (query || "")
            }
            onChange={handleInputChange}
            onBlur={onBlur}
            placeholder={placeholder}
            autoComplete="off"
          />
          <Combobox.Button className="flex absolute inset-y-0 right-0 items-center pr-2">
            <ChevronUpDownIcon
              className="w-5 h-5 text-slate-400"
              aria-hidden="true"
            />
          </Combobox.Button>
        </div>

        <Transition
          as={Fragment}
          leave="transition ease-in duration-100"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <Combobox.Options className="overflow-auto absolute z-50 py-1 mt-1 w-full max-h-60 text-base rounded-md border ring-1 ring-black ring-opacity-5 shadow-lg bg-slate-950 border-slate-800 focus:outline-none sm:text-sm">
            {isLoading ? (
              <div className="relative px-4 py-2 cursor-default select-none text-slate-400">
                Loading...
              </div>
            ) : options.length === 0 && (query || "").trim() !== "" ? (
              <div className="relative px-4 py-2 cursor-default select-none text-slate-400">
                Nothing found on Rule34
              </div>
            ) : (
              options.map((option) => (
                <Combobox.Option
                  key={option.id}
                  value={option}
                  className={({ active }) =>
                    `relative cursor-default select-none py-2 pl-10 pr-4 ${
                      active ? "bg-blue-600 text-white" : "text-slate-300"
                    }`
                  }
                >
                  {({ selected, active }) => (
                    <>
                      <span
                        className={`block truncate ${
                          selected ? "font-medium" : "font-normal"
                        }`}
                      >
                        {option.label}
                      </span>
                      {selected ? (
                        <span
                          className={`absolute inset-y-0 left-0 flex items-center pl-3 ${
                            active ? "text-white" : "text-blue-400"
                          }`}
                        >
                          <CheckIcon className="w-5 h-5" aria-hidden="true" />
                        </span>
                      ) : null}
                    </>
                  )}
                </Combobox.Option>
              ))
            )}
          </Combobox.Options>
        </Transition>
      </div>
    </Combobox>
  );
}
</file>

<file path="src/renderer/components/pages/Browse.tsx">
import React, { forwardRef, useMemo } from "react";
import {
  useInfiniteQuery,
  useQueryClient,
  useMutation,
  InfiniteData,
} from "@tanstack/react-query";
import { VirtuosoGrid } from "react-virtuoso";
import { Loader2, FilterX } from "lucide-react";

import { PostCard } from "../gallery/PostCard";
import { cn } from "../../lib/utils";
import type { Post } from "../../../main/db/schema";
import { useViewerStore } from "../../store/viewerStore";
import { useDebounce } from "../../lib/hooks/useDebounce";
import { useSearchStore } from "../../store/searchStore";

// --- Grid Components (Virtuoso) ---

const GridContainer = forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "grid grid-cols-2 gap-4 p-4 pb-32 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6",
      className
    )}
    {...props}
  />
));
GridContainer.displayName = "GridContainer";

const ItemContainer = forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("w-full aspect-[2/3]", className)} {...props} />
));
ItemContainer.displayName = "ItemContainer";

// --- Main Component ---

export const Browse = () => {
  const queryClient = useQueryClient();
  const openViewer = useViewerStore((state) => state.open);

  const { searchQuery } = useSearchStore();
  const debouncedSearch = useDebounce(searchQuery, 500);

  const queryKey = useMemo(
    () => ["browse-posts-remote", { tags: debouncedSearch }],
    [debouncedSearch]
  );

  const { data, fetchNextPage, hasNextPage, isFetchingNextPage, isLoading } =
    useInfiniteQuery({
      queryKey: queryKey,
      queryFn: async ({ pageParam = 1 }) => {
        // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–≥–∏ –≤ API –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        return window.api.getRecentPostsRemote(pageParam, debouncedSearch);
      },
      getNextPageParam: (lastPage, allPages) => {
        return lastPage.length === 100 ? allPages.length + 1 : undefined;
      },
      initialPageParam: 1,
    });

  const allPosts = useMemo(
    () => data?.pages.flatMap((page) => page) || [],
    [data]
  );

  const viewMutation = useMutation({
    mutationFn: async (postId: number) => {
      await window.api.updatePost(postId, { isViewed: true });
    },
    onSuccess: (_, postId) => {
      queryClient.setQueryData<InfiniteData<Post[]>>(queryKey, (oldData) => {
        if (!oldData) return oldData;
        return {
          ...oldData,
          pages: oldData.pages.map((page) =>
            page.map((post) =>
              post.id === postId ? { ...post, isViewed: true } : post
            )
          ),
        };
      });
    },
  });

  const handlePostClick = (index: number) => {
    const post = allPosts[index];
    if (post && !post.isViewed) {
      viewMutation.mutate(post.id);
    }

    openViewer({
      origin: { kind: "browse", filters: debouncedSearch },
      ids: allPosts.map((p) => p.id),
      initialIndex: index,
      listKey: `browse-${debouncedSearch}`,
    });
  };

  const handleToggleFavorite = async (post: Post) => {
    const newState = !post.isFavorited;

    // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    queryClient.setQueryData<InfiniteData<Post[]>>(queryKey, (oldData) => {
      if (!oldData) return oldData;
      return {
        ...oldData,
        pages: oldData.pages.map((page) =>
          page.map((p) =>
            p.id === post.id ? { ...p, isFavorited: newState } : p
          )
        ),
      };
    });

    await window.api.updatePost(post.id, { isFavorited: newState });
  };

  return (
    <div className="flex flex-col h-full bg-background">
      <div className="flex-1 min-h-0">
        {isLoading ? (
          <div className="flex justify-center items-center h-full text-muted-foreground">
            <Loader2 className="w-8 h-8 animate-spin" />
          </div>
        ) : allPosts.length === 0 ? (
          <div className="flex flex-col gap-2 justify-center items-center h-full text-muted-foreground">
            <FilterX className="w-12 h-12 opacity-50" />
            <p>No posts found</p>
          </div>
        ) : (
          <VirtuosoGrid
            style={{ height: "100%" }}
            totalCount={allPosts.length}
            endReached={() => {
              if (hasNextPage && !isFetchingNextPage) {
                fetchNextPage();
              }
            }}
            components={{
              List: GridContainer,
              Item: ItemContainer,
              Footer: () =>
                isFetchingNextPage ? (
                  <div className="flex col-span-full justify-center py-4 w-full">
                    <Loader2 className="w-6 h-6 animate-spin text-primary" />
                  </div>
                ) : null,
            }}
            itemContent={(index) => {
              const post = allPosts[index];
              if (!post) return null;

              return (
                <PostCard
                  post={post}
                  onClick={() => handlePostClick(index)}
                  onToggleFavorite={() => handleToggleFavorite(post)}
                />
              );
            }}
          />
        )}
      </div>
    </div>
  );
};
</file>

<file path="src/renderer/components/pages/Onboarding.tsx">
import { useState } from "react";
import { Button } from "../ui/button";
import { Input } from "../ui/input";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
  CardFooter,
} from "../ui/card";
import { KeyRound, Loader2, Info, ExternalLink } from "lucide-react";
import { Alert, AlertDescription, AlertTitle } from "../ui/alert";

export const Onboarding = ({
  onLoginSuccess,
}: {
  onLoginSuccess: () => void;
}) => {
  const [userId, setUserId] = useState("");
  const [apiKey, setApiKey] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");

  const handleLogin = async () => {
    if (!userId || !apiKey) {
      setError("Both fields are required");
      return;
    }
    setIsLoading(true);
    setError("");

    try {
      // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      await window.api.saveSettings({ userId, apiKey });

      // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å (–¥–µ–ª–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å)
      const isValid = await window.api.verifyCredentials();

      if (isValid) {
        onLoginSuccess();
      } else {
        setError(
          "Connection failed. Please check your User ID and API Key and try again."
        );
      }
    } catch (e) {
      console.error(e);
      setError("An unexpected error occurred.");
    } finally {
      setIsLoading(false);
    }
  };

  // –£–º–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞. –ï—Å–ª–∏ —é–∑–µ—Ä –∫–æ–ø–∏—Ä—É–µ—Ç –≤—Å—é —Å—Ç—Ä–æ–∫—É —Å —Å–∞–π—Ç–∞, –º—ã —Å–∞–º–∏ –¥–æ—Å—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ.
  const handlePaste = (e: React.ClipboardEvent<HTMLInputElement>) => {
    const text = e.clipboardData.getData("text");
    if (text.includes("api_key=") || text.includes("user_id=")) {
      e.preventDefault();
      try {
        const cleanText = text.startsWith("&") ? text.slice(1) : text;
        const params = new URLSearchParams(cleanText);

        const pastedId = params.get("user_id");
        const pastedKey = params.get("api_key");

        if (pastedId) setUserId(pastedId);
        if (pastedKey) setApiKey(pastedKey);
      } catch (err) {
        console.warn("Failed to parse paste", err);
      }
    }
  };

  return (
    <div className="flex flex-col justify-center items-center p-4 min-h-screen duration-500 bg-background animate-in fade-in zoom-in-95">
      <Card className="w-full max-w-lg shadow-2xl border-border/50 bg-card">
        <CardHeader className="pb-2 text-center">
          <div className="flex justify-center mb-4">
            <div className="p-4 rounded-full ring-1 bg-primary/10 ring-primary/20">
              <KeyRound className="w-8 h-8 text-primary" />
            </div>
          </div>
          <CardTitle className="text-2xl font-bold tracking-tight">
            Connect Account
          </CardTitle>
          <CardDescription className="text-base">
            Link your Rule34 account to enable synchronization.
          </CardDescription>
        </CardHeader>

        <CardContent className="space-y-6">
          {/* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è */}
          <Alert className="bg-muted/50 border-border/50">
            <Info className="w-4 h-4 text-muted-foreground" />
            <AlertTitle className="mb-2 font-semibold text-foreground">
              Where to find your credentials?
            </AlertTitle>
            <AlertDescription className="space-y-2 text-sm text-muted-foreground">
              <ol className="ml-1 space-y-1 list-decimal list-inside">
                <li>
                  Go to{" "}
                  <span className="font-medium text-foreground">
                    My Account
                  </span>{" "}
                  &rarr;{" "}
                  <span className="font-medium text-foreground">Options</span>.
                </li>
                <li>
                  Scroll down to the{" "}
                  <span className="font-medium text-foreground">
                    "API Access Credentials"
                  </span>{" "}
                  section.
                </li>
                <li>
                  If the field is empty, click{" "}
                  <span className="font-medium text-foreground">
                    "Generate New Key?"
                  </span>
                  .
                </li>
                <li>
                  Copy the{" "}
                  <code className="bg-background px-1 py-0.5 rounded border border-border/50 text-xs">
                    user_id
                  </code>{" "}
                  and{" "}
                  <code className="bg-background px-1 py-0.5 rounded border border-border/50 text-xs">
                    api_key
                  </code>{" "}
                  values.
                </li>
              </ol>
              <div className="mt-2 text-xs italic text-primary/80">
                üí° Pro Tip: You can paste the entire string (e.g.{" "}
                <span className="opacity-70">&api_key=...&user_id=...</span>)
                into any field below.
              </div>
            </AlertDescription>
          </Alert>

          <div className="space-y-4">
            <div className="space-y-2">
              <label htmlFor="user-id-input" className="text-sm font-medium">
                User ID
              </label>
              <Input
                id="user-id-input"
                placeholder="e.g. 479099"
                value={userId}
                onChange={(e) => setUserId(e.target.value)}
                onPaste={handlePaste}
                className="font-mono"
                aria-label="Rule 34 User ID"
                autoComplete="username"
              />
            </div>
            <div className="space-y-2">
              <label htmlFor="api-key-input" className="text-sm font-medium">
                API Key
              </label>
              <Input
                id="api-key-input"
                type="password"
                placeholder="Paste your API Key"
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                onPaste={handlePaste}
                className="font-mono"
                aria-label="Rule 34 API Key"
                autoComplete="off"
              />
            </div>
          </div>

          {error && (
            <div className="p-3 text-sm text-center text-red-500 rounded-md border bg-red-500/10 border-red-500/20">
              {error}
            </div>
          )}

          <Button
            className="w-full font-semibold"
            size="lg"
            onClick={handleLogin}
            disabled={isLoading}
          >
            {isLoading ? (
              <>
                <Loader2 className="mr-2 w-4 h-4 animate-spin" />
                Verifying...
              </>
            ) : (
              "Connect & Start Sync"
            )}
          </Button>
        </CardContent>

        <CardFooter className="justify-center pt-6 pb-6 border-t">
          <Button
            variant="link"
            className="p-0 h-auto text-xs text-muted-foreground"
            onClick={() =>
              window.api.openExternal(
                "https://rule34.xxx/index.php?page=account&s=options"
              )
            }
          >
            Open Rule34 Options Page <ExternalLink className="ml-1 w-3 h-3" />
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
};
</file>

<file path="src/renderer/index.css">
@import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    /* Base - Deep Navy/Black */
    --background: 222 47% 6%;
    --foreground: 210 40% 98%;

    /* Surfaces - Layered hierarchy */
    --card: 222 40% 9%; /* Slightly lighter than bg */
    --card-foreground: 210 40% 98%;

    --popover: 222 38% 11%; /* Distinct elevation */
    --popover-foreground: 210 40% 98%;

    /* Brand / Primary - Vivid Violet/Purple */
    --primary: 262 83% 62%;
    --primary-foreground: 210 40% 98%;

    /* Secondary / Muted - Cool Greys */
    --secondary: 222 28% 16%;
    --secondary-foreground: 210 40% 98%;

    --muted: 222 24% 14%;
    --muted-foreground: 215 20% 70%;

    /* Accent - Interactive elements */
    --accent: 262 40% 20%;
    --accent-foreground: 210 40% 98%;

    /* Danger - Red */
    --destructive: 0 70% 45%;
    --destructive-foreground: 210 40% 98%;

    /* Lines / Focus */
    --border: 222 18% 22%;
    --input: 222 18% 22%;
    --ring: 262 83% 62%;

    --radius: 0.75rem;
  }
}

@layer base {
  * {
    @apply border-border;
  }

  html {
    font-family: "Inter", ui-sans-serif, system-ui, -apple-system,
      BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial,
      sans-serif;
  }

  body {
    @apply bg-background text-foreground;
    /* Tabular nums prevent jitter in tables/counters */
    font-variant-numeric: tabular-nums;
    /* Better text rendering on monitors */
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
  }
}
</file>

<file path="src/renderer/locales/en/translation.json">
{
  "artistGallery": {
    "backToArtists": "Back to artists list",
    "postsOnPage": "posts on page",
    "repairTitle": "Resynchronize first pages to update low-quality previews",
    "repair": "Repair",
    "openInBrowser": "Open in browser",
    "web": "Web",
    "loadingPosts": "Loading posts...",
    "imageAlt": "Image by {{artistName}} with tags {{tags}}",
    "noPreview": "No Preview",
    "noPostsFound": "No posts found on this page.",
    "previousPage": "Previous page",
    "back": "Back",
    "page": "Page",
    "nextPage": "Next page",
    "next": "Next",
    "repairConfirm": "Are you sure you want to run a repair sync for {{artistName}}? This may take time and update old entries."
  },
  "addArtistModal": {
    "addArtist": "Add Artist",
    "newArtist": "New Artist",
    "error": "Error: {{message}}",
    "artistTag": "Artist Tag",
    "uploader": "Uploader",
    "usernameUploader": "Username (Uploader)",
    "artistTagLabel": "Artist Tag",
    "placeholderUploader": "Lesdias",
    "placeholderTag": "wlop",
    "nameRequired": "Name is required",
    "willBeSent": "Will be sent:",
    "cancel": "Cancel",
    "add": "Add"
  },
  "onboarding": {
    "title": "Rule34 Authorization",
    "description": "API keys are required for the parser to work.",
    "howToGetKeys": "How to get keys:",
    "step1": "Log into your account on rule34.xxx",
    "step2": "Go to My Account ‚Üí Options",
    "step3": "Find the API Access section",
    "settingsPageAddress": "Settings page address (copy):",
    "userId": "User ID",
    "userIdPlaceholder": "For example: 123456",
    "userIdRequired": "User ID is required",
    "apiKey": "API Key",
    "apiKeyPlaceholder": "Your secret key",
    "apiKeyTooShort": "API Key is too short",
    "saving": "Saving...",
    "saveAndLogin": "Save and Login"
  },
  "updateNotification": {
    "closeNotification": "Close notification",
    "updateAvailable": "Update v{{version}} available",
    "downloadingUpdate": "Downloading update...",
    "readyToInstall": "Ready to install",
    "updateFailed": "Update failed",
    "percentCompleted": "{{progress}}% completed",
    "restartRequired": "Restart required",
    "download": "Download",
    "later": "Later",
    "restartAndInstall": "Restart & Install"
  },
  "app": {
    "appTitle": "RuleDesk",
    "syncAll": "Sync All",
    "syncing": "Syncing...",
    "startSynchronization": "Start synchronization",
    "syncingInProgress": "Syncing in progress: {{message}}",
    "trackedArtists": "Tracked Artists",
    "loadingFromSqlite": "Loading from SQLite...",
    "dbError": "üõë DB Error: {{message}}",
    "trackingListEmpty": "Tracking list is empty.",
    "lastId": "Last ID",
    "new": "New",
    "loading": "Loading..."
  },
  "dialog": {
    "close": "Close"
  }
}
</file>

<file path="src/renderer/store/viewerStore.ts">
import { create } from "zustand";

export type ViewerOrigin =
  | { kind: "browse"; filters?: string }
  | { kind: "favorites" }
  | { kind: "updates" }
  | { kind: "artist"; artistId: number };

export interface ViewerQueue {
  origin: ViewerOrigin;
  ids: number[];
  initialIndex: number;
  listKey: string;
  totalGlobalCount?: number;
  hasNextPage?: boolean;
  onLoadMore?: () => void | Promise<void>;
  fetchNextPage?: () => void;
}

interface ViewerState {
  isOpen: boolean;
  controlsVisible: boolean;
  isTagsDrawerOpen: boolean;

  queue: ViewerQueue | null;
  currentIndex: number;
  currentPostId: number | null;

  open: (queue: ViewerQueue) => void;
  close: () => void;

  next: () => void;
  prev: () => void;

  toggleTagsDrawer: () => void;
  setControlsVisible: (visible: boolean) => void;
  updateQueueIds: (ids: number[]) => void;
  appendQueueIds: (newIds: number[]) => void;
}

export const useViewerStore = create<ViewerState>((set, get) => ({
  isOpen: false,
  controlsVisible: true,
  isTagsDrawerOpen: false,
  queue: null,
  currentIndex: 0,
  currentPostId: null,

  open: (queue) => {
    const safeIndex = Math.max(
      0,
      Math.min(queue.initialIndex, queue.ids.length - 1)
    );

    set({
      isOpen: true,
      queue,
      currentIndex: safeIndex,
      currentPostId: queue.ids[safeIndex] || null,
      controlsVisible: true,
      isTagsDrawerOpen: false,
    });
  },

  close: () =>
    set({
      isOpen: false,
      queue: null,
      currentPostId: null,
    }),

  next: () => {
    const { queue, currentIndex } = get();
    if (!queue) return;

    if (
      queue.hasNextPage &&
      queue.fetchNextPage &&
      currentIndex >= queue.ids.length - 10
    ) {
      queue.fetchNextPage();
    }

    if (currentIndex < queue.ids.length - 1) {
      const newIndex = currentIndex + 1;
      set({
        currentIndex: newIndex,
        currentPostId: queue.ids[newIndex],
      });
    }
  },

  prev: () => {
    const { queue, currentIndex } = get();
    if (!queue) return;

    if (currentIndex > 0) {
      const newIndex = currentIndex - 1;
      set({
        currentIndex: newIndex,
        currentPostId: queue.ids[newIndex],
      });
    }
  },

  toggleTagsDrawer: () =>
    set((state) => ({ isTagsDrawerOpen: !state.isTagsDrawerOpen })),

  setControlsVisible: (visible) => set({ controlsVisible: visible }),

  updateQueueIds: (newIds) =>
    set((state) => {
      if (!state.queue) return {};
      return {
        queue: { ...state.queue, ids: newIds },
      };
    }),

  appendQueueIds: (newIds) =>
    set((state) => {
      if (!state.queue) return {};
      const existingIds = new Set(state.queue.ids);
      const uniqueNewIds = newIds.filter((id) => !existingIds.has(id));
      return {
        queue: {
          ...state.queue,
          ids: [...state.queue.ids, ...uniqueNewIds],
        },
      };
    }),
}));
</file>

<file path="docs/contributing.md">
# Contributing Guide

Thank you for your interest in contributing to NSFW Booru Desktop Client! This document provides guidelines and instructions for contributing.

## Code of Conduct

- Be respectful and professional
- Follow the project's coding standards
- Write clear, maintainable code
- Test your changes before submitting

## Development Principles

This project adheres to strict development principles. Please review these before contributing:

### KISS & YAGNI

- **KISS (Keep It Simple, Stupid):** Prefer simple, readable solutions
- **YAGNI (You Aren't Gonna Need It):** Implement only what's required now

### SOLID & DRY

- **Single Responsibility:** One component/function = one job
- **DRY (Don't Repeat Yourself):** Refactor duplicated code
- **Composition over Inheritance:** Prefer composition in React

### Code Quality

- **TypeScript:** Strict typing, no `any` or unsafe casts
- **Explicit over Implicit:** No magic numbers or strings
- **Fail Fast:** Validate inputs at boundaries
- **Error Handling:** Proper error handling, no bare `catch (e)`

## Getting Started

### Prerequisites

- Node.js v18 or higher
- npm or yarn
- Git

### Setup

1. **Fork and Clone**

   ```bash
   git clone https://github.com/KazeKaze93/ruledesk.git
   cd ruledesk
   ```

2. **Install Dependencies**

   ```bash
   npm install
   ```

3. **Run Development Mode**

   ```bash
   npm run dev
   ```

4. **Run Type Checking**

   ```bash
   npm run typecheck
   ```

5. **Run Linter**
   ```bash
   npm run lint
   ```

## Development Workflow

### Branch Strategy

- Create a feature branch from `master`
- Use descriptive branch names: `feature/add-download-manager`, `fix/artist-validation`

### Making Changes

1. **Create a Branch**

   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **Make Your Changes**

   - Follow the coding standards
   - Write clear, self-documenting code
   - Add comments where necessary

3. **Test Your Changes**

   - Run the application: `npm run dev`
   - Check for TypeScript errors: `npm run typecheck`
   - Run the linter: `npm run lint`

4. **Commit Your Changes**
   ```bash
   git add .
   git commit -m "feat: add download manager"
   ```

### Commit Message Format

Follow conventional commits:

- `feat:` - New feature
- `fix:` - Bug fix
- `docs:` - Documentation changes
- `style:` - Code style changes (formatting)
- `refactor:` - Code refactoring
- `test:` - Adding tests
- `chore:` - Maintenance tasks

**Example:**

```
feat: add artist deletion functionality

- Add deleteArtist method to DbService
- Add delete button to artist list UI
- Add confirmation dialog before deletion
```

## Code Standards

### TypeScript

- **No `any` types:** Use proper types or `unknown`
- **No unsafe casts:** Avoid `as` unless absolutely necessary
- **Strict mode:** All code must pass `tsc --noEmit`
- **Type inference:** Prefer inference where possible

**Good:**

```typescript
const artists: Artist[] = await dbService.getTrackedArtists();
```

**Bad:**

```typescript
const artists: any = await dbService.getTrackedArtists();
```

### React

- **Functional Components:** Use function components, not classes
- **Hooks:** Prefer hooks over lifecycle methods
- **Props Types:** Always type component props
- **No Inline Styles:** Use Tailwind CSS classes

**Good:**

```typescript
interface ArtistCardProps {
  artist: Artist;
  onDelete: (id: number) => void;
}

export const ArtistCard: React.FC<ArtistCardProps> = ({ artist, onDelete }) => {
  return <div className="p-4">{artist.name}</div>;
};
```

**Bad:**

```typescript
export const ArtistCard = ({ artist, onDelete }: any) => {
  return <div style={{ padding: "16px" }}>{artist.name}</div>;
};
```

### Error Handling

- **Never use bare catch:** Always handle errors properly
- **Descriptive errors:** Provide meaningful error messages
- **Log errors:** Use the logger for error tracking

**Good:**

```typescript
try {
  const result = await dbService.addArtist(data);
  return result;
} catch (error) {
  logger.error("Failed to add artist:", error);
  if (error instanceof Error) {
    throw new Error(`Failed to add artist: ${error.message}`);
  }
  throw error;
}
```

**Bad:**

```typescript
try {
  return await dbService.addArtist(data);
} catch (e) {
  // ...
}
```

### Database

- **Use Drizzle ORM:** Never write raw SQL unless necessary
- **Type Safety:** Use inferred types from schema
- **Migrations:** Always create migrations for schema changes

**Good:**

```typescript
const artists = await db.query.artists.findMany({
  where: eq(schema.artists.id, artistId),
});
```

**Bad:**

```typescript
const artists = db.prepare("SELECT * FROM artists WHERE id = ?").all(artistId);
```

## Database Changes

### Creating Migrations

1. **Modify Schema** (`src/main/db/schema.ts`)

2. **Generate Migration**

   ```bash
   npm run db:generate
   ```

3. **Review Migration** (in `drizzle/` folder)

4. **Test Migration**
   ```bash
   npm run db:migrate
   ```

## Testing

### Manual Testing

- Test all new features manually
- Verify error handling
- Check UI responsiveness
- Test on different screen sizes

### Automated Testing

(To be implemented)

## Pull Request Process

1. **Update Documentation**

   - Update relevant documentation files
   - Add examples if introducing new features

2. **Update README**

   - If adding new features, update the README
   - Keep the README concise

3. **Create Pull Request**

   - Provide a clear description
   - Reference any related issues
   - Include screenshots for UI changes

4. **Review Process**
   - Address review comments
   - Keep commits atomic (one logical change per commit)
   - Squash commits if requested

## Project Structure

### Key Directories

- `src/main/` - Electron Main Process code
- `src/renderer/` - React Renderer Process code
- `src/main/db/` - Database schema and services
- `docs/` - Documentation files
- `drizzle/` - Database migrations

### File Naming

- **Components:** PascalCase (`ArtistCard.tsx`)
- **Utilities:** camelCase (`utils.ts`)
- **Types:** PascalCase (`types.ts`)
- **Services:** PascalCase (`DbService.ts`)

## Common Tasks

### Adding a New IPC Method

1. **Define in Bridge** (`src/main/bridge.ts`)

   ```typescript
   export interface IpcBridge {
     // ... existing methods
     newMethod: () => Promise<ReturnType>;
   }
   ```

2. **Implement in Bridge**

   ```typescript
   const ipcBridge: IpcBridge = {
     // ... existing methods
     newMethod: () => ipcRenderer.invoke("channel:name"),
   };
   ```

3. **Add Handler** (`src/main/ipc/handlers/` - create new file or add to existing)

   ```typescript
   ipcMain.handle("channel:name", async () => {
     // Implementation
   });
   ```

4. **Update Types** (`src/renderer.d.ts`)
   ```typescript
   export interface IpcApi {
     // ... existing methods
     newMethod: () => Promise<ReturnType>;
   }
   ```

### Adding a New Database Table

1. **Add Schema** (`src/main/db/schema.ts`)
2. **Generate Migration** (`npm run db:generate`)
3. **Update Repository** (`src/main/db/repositories/` - add new repository or update existing)
4. **Test Migration** (`npm run db:migrate`)

## Questions?

If you have questions about contributing:

1. Check existing documentation
2. Review similar code in the codebase
3. Open an issue for discussion

## License

By contributing, you agree that your contributions will be licensed under the MIT License.
</file>

<file path="src/main/db/index.ts">
import Database from "better-sqlite3";
import {
  drizzle,
  type BetterSQLite3Database,
} from "drizzle-orm/better-sqlite3";
import { migrate } from "drizzle-orm/better-sqlite3/migrator";
import * as schema from "./schema";
import * as path from "path";
import { logger } from "../lib/logger";

export type DbType = BetterSQLite3Database<typeof schema>;

let db: DbType | null = null;
let dbInstance: Database.Database | null = null;

function getMigrationsPath(): string {
  const isDev = process.env.NODE_ENV === "development";

  if (isDev) {
    return path.join(process.cwd(), "drizzle");
  }

  return path.join(process.resourcesPath, "drizzle");
}

export function initializeDatabase(dbPath: string): DbType {
  if (db) {
    return db;
  }

  try {
    dbInstance = new Database(dbPath, {
      verbose: process.env.NODE_ENV === "development" ? console.log : undefined,
    });

    db = drizzle(dbInstance, { schema });

    const migrationsPath = getMigrationsPath();
    logger.info(`Database: Migrations Path: ${migrationsPath}`);

    migrate(db, { migrationsFolder: migrationsPath });
    logger.info("Database: Migrations applied successfully.");

    return db;
  } catch (error) {
    logger.error("Database: FATAL ERROR", error);
    throw new Error(`Failed to initialize database: ${error}`);
  }
}

export function getDatabase(): DbType {
  if (!db) {
    throw new Error(
      "Database not initialized. Call initializeDatabase() first."
    );
  }
  return db;
}

export function getRawDatabase(): Database.Database {
  if (!dbInstance) {
    throw new Error(
      "Database not initialized. Call initializeDatabase() first."
    );
  }
  return dbInstance;
}
</file>

<file path="src/main/ipc/handlers/artists.ts">
import { ipcMain } from "electron";
import { z } from "zod";
import axios from "axios";
import { IPC_CHANNELS } from "../channels";
import { ArtistsService } from "../../services/artists.service";
import { NewArtist } from "../../db/schema";
import { logger } from "../../lib/logger";

const AddArtistSchema = z.object({
  name: z.string().trim().min(1),
  tag: z.string().trim().min(1),
  type: z.enum(["tag", "uploader", "query"]),
  apiEndpoint: z.string().url().trim(),
});

export const registerArtistHandlers = (service: ArtistsService) => {
  ipcMain.handle(IPC_CHANNELS.DB.GET_ARTISTS, async () => {
    try {
      return await service.getAll();
    } catch (error) {
      logger.error("IPC: [db:get-artists] error:", error);
      throw new Error("Failed to fetch artists.");
    }
  });

  ipcMain.handle(IPC_CHANNELS.DB.ADD_ARTIST, async (_, payload: unknown) => {
    const validation = AddArtistSchema.safeParse(payload);
    if (!validation.success) {
      logger.error("IPC: Invalid artist data", validation.error);
      throw new Error(`Validation failed: ${validation.error.message}`);
    }

    const artistData = validation.data;
    logger.info(`IPC: [db:add-artist] Adding: ${artistData.name}`);

    try {
      return await service.add(artistData as NewArtist);
    } catch (error) {
      const msg = error instanceof Error ? error.message : String(error);
      logger.error("IPC: [db:add-artist] error:", error);
      throw new Error(`Database error: ${msg}`);
    }
  });

  ipcMain.handle(IPC_CHANNELS.DB.DELETE_ARTIST, async (_, id: unknown) => {
    const validation = z.number().int().positive().safeParse(id);
    if (!validation.success) throw new Error("Invalid ID.");
    try {
      return await service.delete(validation.data);
    } catch (error) {
      logger.error(`IPC: [db:delete-artist] error:`, error);
      throw new Error("Failed to delete artist.");
    }
  });

  ipcMain.handle(IPC_CHANNELS.DB.SEARCH_TAGS, async (_, query: unknown) => {
    const validQuery = z.string().trim().safeParse(query);
    if (!validQuery.success) return [];
    try {
      return await service.searchTags(validQuery.data);
    } catch {
      return [];
    }
  });

  ipcMain.handle(IPC_CHANNELS.API.SEARCH_REMOTE, async (_, query: unknown) => {
    const validQuery = z.string().trim().safeParse(query);
    if (!validQuery.success || validQuery.data.length < 2) return [];

    interface Rule34AutocompleteItem {
      label: string;
      value: string;
      type?: string;
    }

    try {
      const { data } = await axios.get<Rule34AutocompleteItem[]>(
        `https://api.rule34.xxx/autocomplete.php?q=${encodeURIComponent(
          validQuery.data
        )}`
      );
      return Array.isArray(data)
        ? data.map((item) => ({ id: item.value, label: item.label }))
        : [];
    } catch {
      return [];
    }
  });
};
</file>

<file path="src/main/ipc/handlers/settings.ts">
import { ipcMain, safeStorage } from "electron";
import { IPC_CHANNELS } from "../channels";
import { z } from "zod";
import { logger } from "../../lib/logger";
import { SettingsService } from "../../services/settings.service";
import type { Settings } from "../../db/schema";

const SettingsPayloadSchema = z.object({
  userId: z.string().optional(),
  apiKey: z.string().optional(),
  isSafeMode: z.boolean().optional(),
  isAdultConfirmed: z.boolean().optional(),
});

export const registerSettingsHandlers = (service: SettingsService) => {
  ipcMain.removeHandler(IPC_CHANNELS.SETTINGS.GET);
  ipcMain.removeHandler(IPC_CHANNELS.SETTINGS.SAVE);

  // GET Settings
  ipcMain.handle(IPC_CHANNELS.SETTINGS.GET, async () => {
    try {
      return await service.getSettingsStatus();
    } catch (e) {
      logger.error("IPC: Error getting settings:", e);
      throw new Error("Failed to get settings");
    }
  });

  // SAVE Settings
  ipcMain.handle(IPC_CHANNELS.SETTINGS.SAVE, async (_, payload: unknown) => {
    const validation = SettingsPayloadSchema.safeParse(payload);

    if (!validation.success) {
      logger.error("Settings validation failed:", validation.error.issues);
      return false;
    }

    const { userId, apiKey, isSafeMode, isAdultConfirmed } = validation.data;

    let encryptedApiKey: string | undefined;

    if (apiKey) {
      if (!safeStorage.isEncryptionAvailable()) {
        logger.error("safeStorage is not available.");
        return false;
      }
      try {
        encryptedApiKey = safeStorage.encryptString(apiKey).toString("base64");
      } catch (e) {
        logger.error("Encryption failed:", e);
        return false;
      }
    }

    try {
      const updateData: Partial<Settings> = {};

      if (userId !== undefined) updateData.userId = userId;
      if (encryptedApiKey !== undefined)
        updateData.encryptedApiKey = encryptedApiKey;
      if (isSafeMode !== undefined) updateData.isSafeMode = isSafeMode;
      if (isAdultConfirmed !== undefined)
        updateData.isAdultConfirmed = isAdultConfirmed;

      const result = await service.updateSettings(updateData);

      logger.info("IPC: Settings saved.");
      return result;
    } catch (e) {
      logger.error("IPC: Error saving settings:", e);
      return false;
    }
  });
};
</file>

<file path="src/renderer/components/layout/Sidebar.tsx">
import { useState } from "react";
import { NavLink } from "react-router-dom";
import {
  Activity,
  LayoutGrid,
  Heart,
  Users,
  Settings,
  RefreshCw,
  Zap,
  LogOut,
} from "lucide-react";
import { cn } from "../../lib/utils";

const navItems = [
  { to: "/updates", icon: Zap, label: "Updates" },
  { to: "/browse", icon: LayoutGrid, label: "Browse" },
  { to: "/favorites", icon: Heart, label: "Favorites" },
  { to: "/tracked", icon: Users, label: "Sources" },
  { to: "/settings", icon: Settings, label: "Settings" },
];

export const Sidebar = () => {
  const [isSyncing, setIsSyncing] = useState(false);
  const [lastSyncTime, setLastSyncTime] = useState("12:30");

  const handleSync = async () => {
    if (isSyncing) return;

    setIsSyncing(true);
    try {
      console.log("Triggering Sync...");
      await window.api.syncAll();

      const now = new Date();
      setLastSyncTime(
        `${now.getHours()}:${now.getMinutes().toString().padStart(2, "0")}`
      );
    } catch (error) {
      console.error("Sync failed:", error);
    } finally {
      setIsSyncing(false);
    }
  };

  const handleLogout = async () => {
    const confirmed = window.confirm(
      "Are you sure you want to log out? You will need to enter your API credentials again."
    );
    if (!confirmed) return;

    try {
      await window.api.logout();
      window.location.reload();
    } catch (error) {
      console.error("Failed to logout:", error);
      alert("Failed to log out. Please try again.");
    }
  };

  return (
    <aside className="flex sticky top-0 flex-col w-64 h-screen border-r bg-background">
      {/* Logo Area */}
      <div className="flex items-center px-6 h-14 border-b">
        <Activity className="mr-2 w-6 h-6 text-primary" />
        <span className="text-lg font-bold tracking-tight">RuleDesk</span>
      </div>

      {/* Navigation */}
      <nav className="flex-1 px-3 py-6 space-y-1">
        {navItems.map((item) => (
          <NavLink
            key={item.to}
            to={item.to}
            className={({ isActive }) =>
              cn(
                "flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors",
                isActive
                  ? "bg-primary/10 text-primary"
                  : "text-muted-foreground hover:bg-accent hover:text-accent-foreground"
              )
            }
          >
            <item.icon className="w-4 h-4" />
            {item.label}
          </NavLink>
        ))}
      </nav>

      {/* Sync Status Footer */}
      <div className="p-4 space-y-2 border-t bg-muted/20">
        <button
          onClick={handleSync}
          disabled={isSyncing}
          className={cn(
            "flex gap-3 items-center p-1 -ml-1 w-full text-left rounded-md transition-all hover:bg-background/50",
            isSyncing
              ? "opacity-70 cursor-wait"
              : "cursor-pointer hover:opacity-100"
          )}
          title="Click to sync all sources"
        >
          <div
            className={cn(
              "p-2 rounded-full bg-background border shadow-sm",
              isSyncing && "animate-spin text-primary border-primary"
            )}
          >
            <RefreshCw className="w-4 h-4" />
          </div>
          <div className="flex flex-col">
            <span className="text-xs font-medium">Sync Status</span>
            <span className="text-[10px] text-muted-foreground">
              {isSyncing ? "Syncing..." : `Last: ${lastSyncTime}`}
            </span>
          </div>
        </button>

        {/* Log Out Button */}
        <button
          onClick={handleLogout}
          className="flex gap-3 items-center p-2 -ml-1 w-full text-left rounded-md transition-all text-muted-foreground hover:bg-destructive/10 hover:text-destructive"
          title="Log out"
        >
          <LogOut className="w-4 h-4" />
          <span className="text-sm font-medium">Log Out</span>
        </button>
      </div>
    </aside>
  );
};
</file>

<file path="src/renderer/components/pages/Settings.tsx">
import { useState } from "react";
import { Button } from "../../components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "../ui/card";
import { Loader2, Database, Upload } from "lucide-react";

export const Settings = () => {
  const [isBackingUp, setIsBackingUp] = useState(false);
  const [isRestoring, setIsRestoring] = useState(false);
  const [backupStatus, setBackupStatus] = useState<
    "idle" | "success" | "error"
  >("idle");
  const [restoreStatus, setRestoreStatus] = useState<
    "idle" | "success" | "error"
  >("idle");

  const handleBackup = async () => {
    setIsBackingUp(true);
    setBackupStatus("idle");

    try {
      const result = await window.api.createBackup();
      if (result.success) {
        setBackupStatus("success");
        setTimeout(() => setBackupStatus("idle"), 3000);
      } else {
        setBackupStatus("error");
        setTimeout(() => setBackupStatus("idle"), 3000);
      }
    } catch (error) {
      console.error("Failed to create backup:", error);
      setBackupStatus("error");
      setTimeout(() => setBackupStatus("idle"), 3000);
    } finally {
      setIsBackingUp(false);
    }
  };

  const handleRestore = async () => {
    setIsRestoring(true);
    setRestoreStatus("idle");

    try {
      const result = await window.api.restoreBackup();
      if (result.success) {
        setRestoreStatus("success");
        setTimeout(() => setRestoreStatus("idle"), 3000);
      } else {
        setRestoreStatus("error");
        setTimeout(() => setRestoreStatus("idle"), 3000);
      }
    } catch (error) {
      console.error("Failed to restore backup:", error);
      setRestoreStatus("error");
      setTimeout(() => setRestoreStatus("idle"), 3000);
    } finally {
      setIsRestoring(false);
    }
  };

  return (
    <div className="container py-10 space-y-8 max-w-2xl duration-500 animate-in fade-in">
      <div>
        <h2 className="text-3xl font-bold tracking-tight">Settings</h2>
        <p className="text-muted-foreground">
          Manage your database backups and application preferences.
        </p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Database Management</CardTitle>
          <CardDescription>
            Create backups of your database or restore from a previous backup.
            Backups include all your tracked artists, posts, and settings.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex flex-col gap-4">
            <div className="flex justify-between items-center p-4 rounded-lg border">
              <div className="space-y-1">
                <h3 className="text-sm font-medium">Backup Database</h3>
                <p className="text-sm text-muted-foreground">
                  Create a backup file of your current database. The backup will
                  be saved and the folder will open automatically.
                </p>
              </div>
              <Button
                onClick={handleBackup}
                disabled={isBackingUp}
                variant="outline"
              >
                {isBackingUp ? (
                  <>
                    <Loader2 className="mr-2 w-4 h-4 animate-spin" />
                    Creating...
                  </>
                ) : (
                  <>
                    <Database className="mr-2 w-4 h-4" />
                    Backup Database
                  </>
                )}
              </Button>
            </div>

            {backupStatus === "success" && (
              <div className="p-3 text-sm text-green-600 bg-green-50 rounded-md dark:bg-green-950">
                Backup created successfully!
              </div>
            )}
            {backupStatus === "error" && (
              <div className="p-3 text-sm text-red-600 bg-red-50 rounded-md dark:bg-red-950">
                Failed to create backup. Please try again.
              </div>
            )}

            <div className="flex justify-between items-center p-4 rounded-lg border">
              <div className="space-y-1">
                <h3 className="text-sm font-medium">Restore Database</h3>
                <p className="text-sm text-muted-foreground">
                  Restore your database from a previous backup file. This will
                  replace your current database.
                </p>
              </div>
              <Button
                onClick={handleRestore}
                disabled={isRestoring}
                variant="outline"
              >
                {isRestoring ? (
                  <>
                    <Loader2 className="mr-2 w-4 h-4 animate-spin" />
                    Restoring...
                  </>
                ) : (
                  <>
                    <Upload className="mr-2 w-4 h-4" />
                    Restore Database
                  </>
                )}
              </Button>
            </div>

            {restoreStatus === "success" && (
              <div className="p-3 text-sm text-green-600 bg-green-50 rounded-md dark:bg-green-950">
                Database restored successfully! The page will reload.
              </div>
            )}
            {restoreStatus === "error" && (
              <div className="p-3 text-sm text-red-600 bg-red-50 rounded-md dark:bg-red-950">
                Failed to restore backup. Please try again.
              </div>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  );
};
</file>

<file path="src/renderer/index.html">
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="
    default-src 'self'; 
    script-src 'self' 'unsafe-inline' 'unsafe-eval'; 
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
    font-src 'self' https://fonts.gstatic.com; 
    img-src 'self' data: https: blob:; 
    connect-src 'self' https:; 
    media-src 'self' https: blob:;
  "
    />
    <title>RuleDesk</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="./main.tsx"></script>
  </body>
</html>
</file>

<file path="docs/database.md">
# Database Documentation

## Overview

The application uses **SQLite** as the local database for storing metadata, tracked artists, posts, and subscriptions. The database is accessed exclusively through the **Main Process** using **Drizzle ORM** for type-safe queries.

## Database Location

The database file is stored in the Electron user data directory:

- **Windows:** `%APPDATA%/NSFW Booru Client/metadata.db`
- **macOS:** `~/Library/Application Support/NSFW Booru Client/metadata.db`
- **Linux:** `~/.config/NSFW Booru Client/metadata.db`

**Implementation:**

```typescript
const DB_PATH = path.join(app.getPath("userData"), "metadata.db");
```

## Schema

### Table: `artists`

Stores information about tracked artists/users.

| Column            | Type                           | Description                                 |
| ----------------- | ------------------------------ | ------------------------------------------- |
| `id`              | INTEGER (PK, AutoIncrement)    | Primary key                                 |
| `name`            | TEXT (NOT NULL)                | Artist display name                         |
| `tag`             | TEXT (NOT NULL, UNIQUE)        | Tag or username for tracking                |
| `type`            | TEXT (NOT NULL, DEFAULT 'tag') | Type: "tag" or "uploader"                   |
| `api_endpoint`    | TEXT (NOT NULL)                | Base API endpoint URL                       |
| `last_post_id`    | INTEGER (NOT NULL, DEFAULT 0)  | ID of the last seen post                    |
| `new_posts_count` | INTEGER (NOT NULL, DEFAULT 0)  | Count of new, unviewed posts                |
| `last_checked`    | INTEGER (NULL)                 | Timestamp of last API poll (timestamp mode) |
| `created_at`      | INTEGER (NOT NULL)             | Creation timestamp (timestamp mode, ms)     |

**Schema Definition:**

```typescript
export const artists = sqliteTable("artists", {
  id: integer("id", { mode: "number" }).primaryKey({ autoIncrement: true }),
  name: text("name").notNull(),
  tag: text("tag").notNull(),
  type: text("type", { enum: ["tag", "uploader", "query"] }).notNull(),
  apiEndpoint: text("api_endpoint").notNull(),
  lastPostId: integer("last_post_id").default(0).notNull(),
  newPostsCount: integer("new_posts_count").default(0).notNull(),
  lastChecked: integer("last_checked", { mode: "timestamp" }),
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .$defaultFn(() => new Date()),
});
```

**TypeScript Types:**

```typescript
export type Artist = typeof artists.$inferSelect;
export type NewArtist = typeof artists.$inferInsert;
```

### Table: `posts`

Caches post metadata for filtering, statistics, and download management. Supports progressive image loading with preview, sample, and full-resolution URLs.

| Column         | Type                                   | Description                                   |
| -------------- | -------------------------------------- | --------------------------------------------- |
| `id`           | INTEGER (PK, AutoIncrement)            | Internal post ID                              |
| `post_id`      | INTEGER (NOT NULL)                     | Post ID from external API                     |
| `artist_id`    | INTEGER (FK ‚Üí artists.id)              | Reference to artist                           |
| `file_url`     | TEXT (NOT NULL)                        | Direct URL to full-resolution media file      |
| `preview_url`  | TEXT (NOT NULL)                        | URL to low-resolution preview (blurred)       |
| `sample_url`   | TEXT (NOT NULL, DEFAULT '')            | URL to medium-resolution sample               |
| `title`        | TEXT                                   | Post title                                    |
| `rating`       | TEXT                                   | Content rating (safe, questionable, explicit) |
| `tags`         | TEXT                                   | Space-separated tags                          |
| `published_at` | TEXT                                   | Publication timestamp (as string)             |
| `created_at`   | INTEGER (NOT NULL)                     | When added to local database (timestamp ms)   |
| `is_viewed`    | INTEGER (BOOLEAN, NOT NULL, DEFAULT 0) | Whether post has been viewed                  |

**Unique Constraint:** `(artist_id, post_id)` - Prevents duplicate posts per artist.

**Schema Definition:**

```typescript
export const posts = sqliteTable(
  "posts",
  {
    id: integer("id", { mode: "number" }).primaryKey({ autoIncrement: true }),
    postId: integer("post_id").notNull(),
    artistId: integer("artist_id")
      .notNull()
      .references(() => artists.id, { onDelete: "cascade" }),
    fileUrl: text("file_url").notNull(),
    previewUrl: text("preview_url").notNull(),
    sampleUrl: text("sample_url").notNull().default(""),
    title: text("title").default(""),
    rating: text("rating").default(""),
    tags: text("tags").notNull(),
    publishedAt: text("published_at"),
    createdAt: integer("created_at", { mode: "timestamp" })
      .notNull()
      .$defaultFn(() => new Date()),
    isViewed: integer("is_viewed", { mode: "boolean" })
      .default(false)
      .notNull(),
  },
  (table) => ({
    uniquePostPerArtist: unique().on(table.artistId, table.postId),
  })
);
```

**TypeScript Types:**

```typescript
export type Post = typeof posts.$inferSelect;
export type NewPost = typeof posts.$inferInsert;
```

### Table: `subscriptions`

Stores user subscriptions to tag combinations.

| Column            | Type                          | Description                                      |
| ----------------- | ----------------------------- | ------------------------------------------------ |
| `id`              | INTEGER (PK, AutoIncrement)   | Primary key                                      |
| `tag_string`      | TEXT (NOT NULL, UNIQUE)       | Tag search string (e.g., 'tag_a, tag_b, -tag_c') |
| `last_post_id`    | INTEGER (NOT NULL, DEFAULT 0) | ID of last seen post for this subscription       |
| `new_posts_count` | INTEGER (NOT NULL, DEFAULT 0) | Count of new posts matching tags                 |

**Schema Definition:**

```typescript
export const subscriptions = sqliteTable("subscriptions", {
  id: integer("id", { mode: "number" }).primaryKey({ autoIncrement: true }),
  tagString: text("tag_string").notNull().unique(),
  lastPostId: integer("last_post_id", { mode: "number" }).notNull().default(0),
  newPostsCount: integer("new_posts_count", { mode: "number" })
    .notNull()
    .default(0),
});
```

## Database Architecture

All database operations are performed through a **dedicated Worker Thread** to prevent blocking the main Electron process. The architecture uses an RPC (Remote Procedure Call) pattern with correlation IDs for request/response matching.

### Worker Thread Architecture

**Database Worker** (`src/main/db/db-worker.ts`):

- Runs in a separate Node.js worker thread
- Handles all SQLite operations using Drizzle ORM
- Executes migrations on initialization
- Provides thread-safe database access

**Database Worker Client** (`src/main/db/db-worker-client.ts`):

- Client interface for communicating with the worker thread
- Manages worker lifecycle (initialization, termination)
- Provides async/await interface over worker RPC calls
- Handles backup and restore operations

### Initialization

```typescript
import { DbWorkerClient } from "./db/db-worker-client";

const dbWorkerClient = new DbWorkerClient(DB_PATH);
await dbWorkerClient.initialize();
```

**Note:** The worker thread is automatically initialized when `DbWorkerClient` is created. Migrations run automatically on worker initialization.

### Available Methods (via Worker Client)

All database operations are accessed through `DbWorkerClient.call()` method, which communicates with the worker thread via RPC.

#### `getTrackedArtists(): Promise<Artist[]>`

Retrieves all tracked artists, ordered by username.

**Example:**

```typescript
const artists = await dbWorkerClient.call("getTrackedArtists");
```

#### `addArtist(artistData: NewArtist): Promise<Artist>`

Adds a new artist to track.

**Example:**

```typescript
const newArtist: NewArtist = {
  name: "Example Artist",
  tag: "tag_name",
  type: "tag",
  apiEndpoint: "https://api.rule34.xxx",
  lastPostId: 0,
  newPostsCount: 0,
};

const savedArtist = await dbWorkerClient.call("addArtist", newArtist);
```

#### `deleteArtist(id: number): Promise<void>`

Deletes an artist and all associated posts (cascade delete).

**Example:**

```typescript
await dbWorkerClient.call("deleteArtist", { id: 123 });
```

#### `getPostsByArtist(params: { artistId: number; limit?: number; offset?: number }): Promise<Post[]>`

Retrieves posts for a specific artist with pagination.

**Parameters:**

- `params.artistId: number` - Artist ID
- `params.limit?: number` - Number of posts to retrieve (default: 1000)
- `params.offset?: number` - Number of posts to skip (default: 0)

**Example:**

```typescript
// Get first 50 posts
const posts = await dbWorkerClient.call("getPostsByArtist", {
  artistId: 123,
  limit: 50,
  offset: 0,
});

// Get next 50 posts (page 2)
const nextPosts = await dbWorkerClient.call("getPostsByArtist", {
  artistId: 123,
  limit: 50,
  offset: 50,
});
```

**Note:** The IPC method `getArtistPosts` uses a limit of 50 posts per page for better performance.

#### `savePostsForArtist(params: { artistId: number; posts: NewPost[] }): Promise<void>`

Saves posts for an artist. Updates artist's `lastPostId` and increments `newPostsCount`.

**Example:**

```typescript
const newPosts: NewPost[] = [
  {
    postId: 12345,
    artistId: 1,
    fileUrl: "https://...",
    previewUrl: "https://...",
    rating: "s",
    tags: "tag1 tag2 tag3",
    publishedAt: "1234567890",
  },
];

await dbWorkerClient.call("savePostsForArtist", {
  artistId: 1,
  posts: newPosts,
});
```

#### `getSettings(): Promise<{ userId: string; apiKey: string } | undefined>`

Retrieves stored API credentials. Returns encrypted API key (needs decryption in Main Process).

**Example:**

```typescript
const settings = await dbWorkerClient.call("getApiKeyDecrypted");
if (settings) {
  // API key is encrypted, decrypt using SecureStorage
  const decryptedKey = SecureStorage.decrypt(settings.apiKey);
}
```

#### `saveSettings(params: { userId: string; apiKey: string }): Promise<void>`

Saves or updates API credentials. API key should be encrypted before saving.

**Example:**

```typescript
const encryptedKey = SecureStorage.encrypt("your-api-key");
await dbWorkerClient.call("saveSettings", {
  userId: "123456",
  apiKey: encryptedKey,
});
```

#### `markPostAsViewed(params: { postId: number }): Promise<void>`

Marks a post as viewed in the database.

**Example:**

```typescript
await dbWorkerClient.call("markPostAsViewed", { postId: 123 });
```

#### `searchArtists(params: { query: string }): Promise<{ id: number; label: string }[]>`

Searches for artists in the local database by name or tag.

**Example:**

```typescript
const results = await dbWorkerClient.call("searchArtists", {
  query: "artist",
});
```

#### `backup(): Promise<{ backupPath: string }>`

Creates a timestamped backup of the database.

**Example:**

```typescript
const result = await dbWorkerClient.call("backup");
console.log(`Backup created at: ${result.backupPath}`);
```

#### `restore(backupPath: string): Promise<void>`

Restores the database from a backup file. Worker thread is terminated and reinitialized after restore.

**Example:**

```typescript
await dbWorkerClient.restore("/path/to/backup.db");
```

## Migrations

### Generating Migrations

When modifying the schema (`src/main/db/schema.ts`), generate a migration:

```bash
npm run db:generate
```

This creates a new migration file in the `drizzle/` directory.

### Running Migrations

Migrations are automatically run on application startup via `src/main/db/migrate.ts`.

**Manual execution:**

```bash
npm run db:migrate
```

### Migration Files

Migrations are stored in `drizzle/`:

- SQL files: `0000_*.sql`
- Metadata: `meta/_journal.json`
- Snapshots: `meta/*_snapshot.json`

**Example Migration:**

```sql
CREATE TABLE `artists` (
  `id` integer PRIMARY KEY AUTOINCREMENT NOT NULL,
  `username` text NOT NULL,
  `api_endpoint` text NOT NULL,
  `last_post_id` integer DEFAULT 0 NOT NULL,
  `new_posts_count` integer DEFAULT 0 NOT NULL,
  `last_checked` integer,
  `created_at` integer DEFAULT (unixepoch()) NOT NULL
);
```

## Drizzle ORM

### Configuration

**File:** `drizzle.config.ts`

```typescript
export default defineConfig({
  schema: "./src/main/db/schema.ts",
  out: "./drizzle",
  dialect: "sqlite",
  dbCredentials: {
    url: "./metadata.db",
  },
});
```

### Query Examples

**Select All Artists:**

```typescript
const artists = await db.query.artists.findMany({
  orderBy: [asc(schema.artists.username)],
});
```

**Find Artist by ID:**

```typescript
const artist = await db.query.artists.findFirst({
  where: eq(schema.artists.id, artistId),
});
```

**Insert Artist:**

```typescript
const result = await db
  .insert(schema.artists)
  .values(artistData)
  .returning({ id: schema.artists.id });
```

**Update Artist:**

```typescript
await db
  .update(schema.artists)
  .set({
    lastPostId: newPostId,
    newPostsCount: count,
    lastChecked: new Date(), // Uses timestamp mode
  })
  .where(eq(schema.artists.id, artistId));
```

## Database Studio

Drizzle Kit provides a database studio for viewing and editing data:

```bash
npm run db:studio
```

This opens a web interface at `http://localhost:4983` (default).

## Best Practices

### 1. Type Safety

Always use Drizzle's inferred types:

```typescript
// Good
const artist: Artist = await dbService.getTrackedArtists()[0];

// Bad
const artist: any = await dbService.getTrackedArtists()[0];
```

### 2. Error Handling

Always handle database errors:

```typescript
try {
  const artist = await dbService.addArtist(data);
} catch (error) {
  logger.error("Database error:", error);
  throw error;
}
```

### 3. Transactions

For multiple related operations, use transactions:

```typescript
// Example (to be implemented)
await db.transaction(async (tx) => {
  await tx.insert(schema.artists).values(artistData);
  await tx.insert(schema.posts).values(postData);
});
```

### 4. Indexes

Add indexes for frequently queried columns:

```typescript
// Example (to be added)
export const artists = sqliteTable(
  "artists",
  {
    // ... columns
  },
  (table) => ({
    usernameIdx: index("username_idx").on(table.username),
  })
);
```

## Backup and Recovery

### Backup

The application provides built-in backup functionality:

1. **Manual Backup:** Use `window.api.createBackup()` or the Backup Controls UI component
2. **Backup Location:** Backups are stored in the user data directory with timestamped filenames
3. **Backup Format:** Full SQLite database copy

**Example:**

```typescript
const result = await window.api.createBackup();
if (result.success) {
  console.log(`Backup created at: ${result.path}`);
}
```

### Recovery

**Using the Application:**

1. Use `window.api.restoreBackup()` or the Backup Controls UI component
2. Select a backup file from the file dialog
3. Application will automatically restart after restore

**Manual Recovery:**

If the database becomes corrupted and you need to restore manually:

1. Stop the application
2. Locate the backup file (in user data directory)
3. Copy the backup file to replace `metadata.db`
4. Restart the application (migrations will run automatically)

**Note:** The application will automatically reload after restore to ensure all components are reinitialized with the restored data.

## Performance Considerations

1. **Worker Thread Isolation:** Database operations run in a separate thread, preventing main process blocking
2. **Indexes:** Add indexes on frequently queried columns
3. **Batch Operations:** Use transactions for multiple inserts
4. **Query Optimization:** Use Drizzle's query builder efficiently
5. **Connection Pooling:** SQLite uses a single connection in the worker thread (better-sqlite3)
6. **RPC Pattern:** Worker communication uses correlation IDs for efficient request/response matching

## Future Enhancements

Planned database improvements:

- ‚è≥ **Full-text search indexes for tags (FTS5):** Planned but not implemented
  - **Current:** Standard indexes only (`artistIdIdx`, `isViewedIdx`, `publishedAtIdx`, `isFavoritedIdx`)
  - **Target:** FTS5 virtual table for efficient tag searching
  - **Status:** See [Roadmap](./roadmap.md#-technical-improvements-from-audit) for implementation plan
- Post deduplication logic
- Statistics tables for analytics
- Export/import functionality
- Database compaction utilities
</file>

<file path="drizzle/meta/0000_snapshot.json">
{
  "version": "5",
  "dialect": "sqlite",
  "id": "878805c6-d7ea-4493-b3bc-feb31cf6dcf2",
  "prevId": "00000000-0000-0000-0000-000000000000",
  "tables": {
    "artists": {
      "name": "artists",
      "columns": {
        "id": {
          "name": "id",
          "type": "integer",
          "primaryKey": true,
          "notNull": true,
          "autoincrement": true
        },
        "name": {
          "name": "name",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "tag": {
          "name": "tag",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "type": {
          "name": "type",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "api_endpoint": {
          "name": "api_endpoint",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "last_post_id": {
          "name": "last_post_id",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false,
          "default": 0
        },
        "new_posts_count": {
          "name": "new_posts_count",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false,
          "default": 0
        },
        "last_checked": {
          "name": "last_checked",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "autoincrement": false
        },
        "created_at": {
          "name": "created_at",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        }
      },
      "indexes": {
        "artists_tag_unique": {
          "name": "artists_tag_unique",
          "columns": [
            "tag"
          ],
          "isUnique": true
        }
      },
      "foreignKeys": {},
      "compositePrimaryKeys": {},
      "uniqueConstraints": {}
    },
    "posts": {
      "name": "posts",
      "columns": {
        "id": {
          "name": "id",
          "type": "integer",
          "primaryKey": true,
          "notNull": true,
          "autoincrement": true
        },
        "post_id": {
          "name": "post_id",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "artist_id": {
          "name": "artist_id",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "file_url": {
          "name": "file_url",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "preview_url": {
          "name": "preview_url",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "sample_url": {
          "name": "sample_url",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false,
          "default": "''"
        },
        "title": {
          "name": "title",
          "type": "text",
          "primaryKey": false,
          "notNull": false,
          "autoincrement": false,
          "default": "''"
        },
        "rating": {
          "name": "rating",
          "type": "text",
          "primaryKey": false,
          "notNull": false,
          "autoincrement": false,
          "default": "''"
        },
        "tags": {
          "name": "tags",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "published_at": {
          "name": "published_at",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "created_at": {
          "name": "created_at",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false
        },
        "is_viewed": {
          "name": "is_viewed",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false,
          "default": false
        },
        "is_favorited": {
          "name": "is_favorited",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "autoincrement": false,
          "default": false
        }
      },
      "indexes": {
        "artistIdIdx": {
          "name": "artistIdIdx",
          "columns": [
            "artist_id"
          ],
          "isUnique": false
        },
        "isViewedIdx": {
          "name": "isViewedIdx",
          "columns": [
            "is_viewed"
          ],
          "isUnique": false
        },
        "publishedAtIdx": {
          "name": "publishedAtIdx",
          "columns": [
            "published_at"
          ],
          "isUnique": false
        },
        "isFavoritedIdx": {
          "name": "isFavoritedIdx",
          "columns": [
            "is_favorited"
          ],
          "isUnique": false
        },
        "posts_artist_id_post_id_unique": {
          "name": "posts_artist_id_post_id_unique",
          "columns": [
            "artist_id",
            "post_id"
          ],
          "isUnique": true
        }
      },
      "foreignKeys": {
        "posts_artist_id_artists_id_fk": {
          "name": "posts_artist_id_artists_id_fk",
          "tableFrom": "posts",
          "tableTo": "artists",
          "columnsFrom": [
            "artist_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {}
    },
    "settings": {
      "name": "settings",
      "columns": {
        "id": {
          "name": "id",
          "type": "integer",
          "primaryKey": true,
          "notNull": true,
          "autoincrement": true
        },
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": false,
          "autoincrement": false,
          "default": "''"
        },
        "encrypted_api_key": {
          "name": "encrypted_api_key",
          "type": "text",
          "primaryKey": false,
          "notNull": false,
          "autoincrement": false,
          "default": "''"
        },
        "is_safe_mode": {
          "name": "is_safe_mode",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "autoincrement": false,
          "default": true
        },
        "is_adult_confirmed": {
          "name": "is_adult_confirmed",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "autoincrement": false,
          "default": false
        }
      },
      "indexes": {},
      "foreignKeys": {},
      "compositePrimaryKeys": {},
      "uniqueConstraints": {}
    }
  },
  "enums": {},
  "_meta": {
    "schemas": {},
    "tables": {},
    "columns": {}
  }
}
</file>

<file path="electron.vite.config.ts">
import { resolve } from "path";
import { defineConfig, externalizeDepsPlugin } from "electron-vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  main: {
    resolve: {
      alias: {
        "@shared": resolve("src/shared"),
      },
    },
    plugins: [externalizeDepsPlugin()],
    build: {
      sourcemap: true,
      rollupOptions: {
        input: {
          main: resolve(__dirname, "src/main/main.ts"),
        },
        output: {
          dir: "out/main",
          format: "cjs",
          entryFileNames: "[name].cjs",
        },
      },
    },
  },
  preload: {
    resolve: {
      alias: {
        "@shared": resolve("src/shared"),
      },
    },
    plugins: [externalizeDepsPlugin()],
    build: {
      sourcemap: true,
      lib: {
        entry: "src/main/bridge.ts",
        formats: ["cjs"],
      },
      rollupOptions: {
        output: {
          entryFileNames: "[name].cjs",
        },
      },
    },
  },
  renderer: {
    root: "src/renderer",
    resolve: {
      alias: {
        "@": resolve(__dirname, "src/renderer"),
        "@shared": resolve("src/shared"),
      },
    },
    build: {
      sourcemap: true,
      rollupOptions: {
        input: "src/renderer/index.html",
      },
    },
    plugins: [react()],
  },
});
</file>

<file path="src/main/services/posts.service.ts">
import { eq, count, desc, and, like } from "drizzle-orm";
import { getDatabase } from "../db";
import { posts } from "../db/schema";
import type { Post } from "../db/schema";

export type PostUpdateChanges = {
  rating?: string;
  tags?: string;
  title?: string;
  isViewed?: boolean;
  isFavorited?: boolean;
  fileUrl?: string;
  previewUrl?: string;
  sampleUrl?: string;
};

export type GetPostsParams = {
  artistId?: number;
  limit: number;
  offset: number;
  filters?: {
    tags?: string;
    rating?: "s" | "q" | "e";
    isFavorited?: boolean;
    isViewed?: boolean;
  };
};

export class PostsService {
  private get db() {
    return getDatabase();
  }

  async getPosts(params: GetPostsParams) {
    const conditions = [];

    if (params.artistId) {
      conditions.push(eq(posts.artistId, params.artistId));
    }

    if (params.filters) {
      if (params.filters.tags) {
        conditions.push(like(posts.tags, `%${params.filters.tags}%`));
      }
      if (params.filters.rating) {
        conditions.push(eq(posts.rating, params.filters.rating));
      }
      if (params.filters.isFavorited !== undefined) {
        conditions.push(eq(posts.isFavorited, params.filters.isFavorited));
      }
      if (params.filters.isViewed !== undefined) {
        conditions.push(eq(posts.isViewed, params.filters.isViewed));
      }
    }

    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;

    return this.db
      .select()
      .from(posts)
      .where(whereClause)
      .orderBy(desc(posts.publishedAt))
      .limit(params.limit)
      .offset(params.offset);
  }

  async toggleFavorite(postId: number): Promise<boolean> {
    const db = getDatabase();

    // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ –ø–æ–ª–µ)
    const post = await db.query.posts.findFirst({
      where: eq(posts.id, postId),
      columns: {
        isFavorited: true,
      },
    });

    if (!post) throw new Error(`Post ${postId} not found`);

    const newState = !post.isFavorited;

    // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    await db
      .update(posts)
      .set({ isFavorited: newState })
      .where(eq(posts.id, postId))
      .run();

    return newState;
  }

  async getPostsCount(
    params: Omit<GetPostsParams, "limit" | "offset">
  ): Promise<number> {
    try {
      const conditions = [];

      if (params.artistId) conditions.push(eq(posts.artistId, params.artistId));

      if (params.filters) {
        if (params.filters.tags)
          conditions.push(like(posts.tags, `%${params.filters.tags}%`));
        if (params.filters.rating)
          conditions.push(eq(posts.rating, params.filters.rating));
        if (params.filters.isFavorited !== undefined)
          conditions.push(eq(posts.isFavorited, params.filters.isFavorited));
      }

      const whereClause =
        conditions.length > 0 ? and(...conditions) : undefined;

      const result = await this.db
        .select({ count: count() })
        .from(posts)
        .where(whereClause);

      return result[0]?.count ?? 0;
    } catch (error) {
      console.error("Failed to get posts count:", error);
      return 0;
    }
  }

  async getPostById(postId: number): Promise<Post | null> {
    const result = await this.db
      .select()
      .from(posts)
      .where(eq(posts.id, postId))
      .limit(1);

    return (result[0] as Post) ?? null;
  }

  async updatePost(
    postId: number,
    changes: PostUpdateChanges
  ): Promise<boolean> {
    const updateData: Partial<typeof posts.$inferInsert> = {};

    if (changes.rating !== undefined) updateData.rating = changes.rating;
    if (changes.tags !== undefined) updateData.tags = changes.tags;
    if (changes.title !== undefined) updateData.title = changes.title;
    if (changes.fileUrl !== undefined) updateData.fileUrl = changes.fileUrl;
    if (changes.previewUrl !== undefined)
      updateData.previewUrl = changes.previewUrl;
    if (changes.sampleUrl !== undefined)
      updateData.sampleUrl = changes.sampleUrl;
    if (changes.isViewed !== undefined) updateData.isViewed = changes.isViewed;
    if (changes.isFavorited !== undefined)
      updateData.isFavorited = changes.isFavorited;

    if (Object.keys(updateData).length === 0) return false;

    const result = await this.db
      .update(posts)
      .set(updateData)
      .where(eq(posts.id, postId))
      .run();

    return result.changes > 0;
  }

  async resetArtistCache(artistId: number): Promise<boolean> {
    const result = await this.db
      .update(posts)
      .set({ isViewed: false })
      .where(eq(posts.artistId, artistId))
      .run();

    return result.changes > 0;
  }

  async resetPostCache(postId: number): Promise<boolean> {
    return this.updatePost(postId, { isViewed: false });
  }
}
</file>

<file path="docs/api.md">
# API Documentation

## Overview

This document describes the IPC (Inter-Process Communication) API between the Electron Main Process and Renderer Process. All communication is strictly typed using TypeScript interfaces and follows security best practices.

## Architecture

The application uses Electron's IPC (Inter-Process Communication) with Context Isolation enabled. The Renderer process cannot directly access Node.js APIs. Instead, it communicates with the Main process through a secure bridge defined in `src/main/bridge.ts`.

## IPC Bridge Interface

The IPC bridge is exposed to the Renderer process via `window.api`. All methods return Promises and are fully typed.

### Type Definitions

```typescript
interface IpcBridge {
  // App
  getAppVersion: () => Promise<string>;
  writeToClipboard: (text: string) => Promise<boolean>;
  verifyCredentials: () => Promise<boolean>;
  logout: () => Promise<void>;

  // Settings
  getSettings: () => Promise<Settings | undefined>;
  saveSettings: (creds: { userId: string; apiKey: string }) => Promise<boolean>;

  // Artists
  getTrackedArtists: () => Promise<Artist[]>;
  addArtist: (artist: NewArtist) => Promise<Artist | undefined>;
  deleteArtist: (id: number) => Promise<void>;
  searchArtists: (query: string) => Promise<{ id: number; label: string }[]>;

  // Posts
  getArtistPosts: (params: {
    artistId: number;
    page?: number;
  }) => Promise<Post[]>;
  getArtistPostsCount: (artistId?: number) => Promise<number>;
  markPostAsViewed: (postId: number) => Promise<boolean>;
  togglePostViewed: (postId: number) => Promise<boolean>;
  togglePostFavorite: (postId: number) => Promise<boolean>;
  resetPostCache: (postId: number) => Promise<boolean>;

  // External
  openExternal: (url: string) => Promise<void>;
  searchRemoteTags: (query: string) => Promise<{ id: string; label: string }[]>;

  // Sync
  syncAll: () => Promise<boolean>;
  repairArtist: (artistId: number) => Promise<boolean>;

  // Downloads
  downloadFile: (
    url: string,
    filename: string
  ) => Promise<{
    success: boolean;
    path?: string;
    error?: string;
    canceled?: boolean;
  }>;
  openFileInFolder: (path: string) => Promise<boolean>;
  onDownloadProgress: (callback: DownloadProgressCallback) => () => void;

  // Backup
  createBackup: () => Promise<BackupResponse>;
  restoreBackup: () => Promise<BackupResponse>;

  // Updater
  checkForUpdates: () => Promise<void>;
  quitAndInstall: () => Promise<void>;
  startDownload: () => Promise<void>;

  // Event Listeners
  onUpdateStatus: (callback: UpdateStatusCallback) => () => void;
  onUpdateProgress: (callback: UpdateProgressCallback) => () => void;
  onSyncStart: (callback: () => void) => () => void;
  onSyncEnd: (callback: () => void) => () => void;
  onSyncProgress: (callback: (message: string) => void) => () => void;
  onSyncError: (callback: SyncErrorCallback) => () => void;
}
```

## API Methods

### `getAppVersion()`

Returns the current application version.

**Returns:** `Promise<string>`

**Example:**

```typescript
const version = await window.api.getAppVersion();
console.log(version); // "1.0.0"
```

**IPC Channel:** `app:get-version`

---

### `getTrackedArtists()`

Retrieves all tracked artists from the local database.

**Returns:** `Promise<Artist[]>`

**Example:**

```typescript
const artists = await window.api.getTrackedArtists();
artists.forEach((artist) => {
  console.log(artist.name, artist.tag, artist.apiEndpoint);
});
```

**IPC Channel:** `db:get-artists`

**Artist Type:**

```typescript
type Artist = {
  id: number;
  name: string;
  tag: string;
  type: "tag" | "uploader";
  apiEndpoint: string;
  lastPostId: number;
  newPostsCount: number;
  lastChecked: number | null;
  createdAt: number;
};
```

**Post Type:**

```typescript
type Post = {
  id: number;
  artistId: number;
  fileUrl: string;
  previewUrl: string | null;
  title: string;
  rating: string | null; // "s", "q", or "e"
  tags: string | null;
  publishedAt: number;
  createdAt: number;
  isViewed: boolean;
};
```

**Settings Type:**

```typescript
type Settings = {
  id: number;
  userId: string;
  apiKey: string;
};
```

---

### `getSettings()`

Retrieves stored API credentials (User ID and API Key).

**Returns:** `Promise<Settings | undefined>`

**Example:**

```typescript
const settings = await window.api.getSettings();
if (settings) {
  console.log("User ID:", settings.userId);
}
```

**IPC Channel:** `app:get-settings`

---

### `saveSettings(creds: { userId: string; apiKey: string })`

Saves API credentials to the database.

**Parameters:**

- `creds.userId: string` - Rule34.xxx User ID
- `creds.apiKey: string` - Rule34.xxx API Key

**Returns:** `Promise<boolean>`

**Throws:**

- `Error("Data is required")` - If userId or apiKey is missing

**Example:**

```typescript
try {
  await window.api.saveSettings({
    userId: "123456",
    apiKey: "your-api-key-here",
  });
  console.log("Settings saved");
} catch (error) {
  console.error("Failed to save settings:", error);
}
```

**IPC Channel:** `app:save-settings`

---

### `addArtist(artist: NewArtist)`

Adds a new artist to track. Validates the input before insertion.

**Parameters:**

- `artist: NewArtist` - Artist data to add

**Returns:** `Promise<Artist | undefined>`

**Throws:**

- `Error("Username is required")` - If name is empty or whitespace
- `Error("Invalid API Endpoint URL")` - If apiEndpoint is not a valid URL

**Example:**

```typescript
const newArtist: NewArtist = {
  name: "example_artist",
  tag: "tag_name",
  type: "tag", // or "uploader"
  apiEndpoint: "https://api.rule34.xxx",
};

try {
  const savedArtist = await window.api.addArtist(newArtist);
  if (savedArtist) {
    console.log("Artist added:", savedArtist.id);
  }
} catch (error) {
  console.error("Failed to add artist:", error);
}
```

**IPC Channel:** `db:add-artist`

**NewArtist Type:**

```typescript
type NewArtist = {
  name: string;
  tag: string;
  type?: "tag" | "uploader"; // Defaults to "tag"
  apiEndpoint: string;
  lastPostId?: number; // Defaults to 0
  newPostsCount?: number; // Defaults to 0
};
```

---

### `deleteArtist(id: number)`

Removes an artist from tracking. Also deletes all associated posts (cascade delete).

**Parameters:**

- `id: number` - Artist ID to delete

**Returns:** `Promise<void>`

**Example:**

```typescript
try {
  await window.api.deleteArtist(123);
  console.log("Artist deleted");
} catch (error) {
  console.error("Failed to delete artist:", error);
}
```

**IPC Channel:** `db:delete-artist`

---

### `getArtistPosts(params: { artistId: number; page?: number })`

Retrieves posts for a specific artist with pagination.

**Parameters:**

- `params.artistId: number` - Artist ID
- `params.page?: number` - Page number (defaults to 1)

**Returns:** `Promise<Post[]>`

**Example:**

```typescript
const posts = await window.api.getArtistPosts({ artistId: 123, page: 1 });
console.log(`Found ${posts.length} posts`);
```

**IPC Channel:** `db:get-posts`

**Note:** Each page returns up to 50 posts (limit). Use pagination to retrieve more posts.

---

### `openExternal(url: string)`

Opens a URL in the default external browser. Only allows rule34.xxx URLs for security.

**Parameters:**

- `url: string` - URL to open

**Returns:** `Promise<void>`

**Example:**

```typescript
await window.api.openExternal(
  "https://rule34.xxx/index.php?page=post&s=list&tags=tag_name"
);
```

**IPC Channel:** `app:open-external`

**Security:** Only HTTPS URLs from rule34.xxx domain are allowed.

---

### `syncAll()`

Initiates background synchronization of all tracked artists. Fetches new posts from Rule34.xxx API.

**Returns:** `Promise<boolean>`

**Example:**

```typescript
const success = await window.api.syncAll();
if (success) {
  console.log("Sync started");
}
```

**IPC Channel:** `db:sync-all`

**Note:** This is an asynchronous operation. The method returns immediately, and synchronization runs in the background. Use event listeners (`onSyncStart`, `onSyncEnd`, `onSyncProgress`, `onSyncError`) to track progress. Check artist `newPostsCount` to see results.

---

### `repairArtist(artistId: number)`

Repairs/resynchronizes an artist by resetting their `lastPostId` to 0 and re-fetching initial pages. Useful for updating low-quality previews or fixing synchronization issues.

**Parameters:**

- `artistId: number` - Artist ID to repair

**Returns:** `Promise<boolean>`

**Example:**

```typescript
try {
  const success = await window.api.repairArtist(123);
  if (success) {
    console.log("Artist repair completed");
  }
} catch (error) {
  console.error("Failed to repair artist:", error);
}
```

**IPC Channel:** `sync:repair-artist`

**Note:** This operation may take time depending on the number of pages to sync. The artist's `lastPostId` is reset to 0, and initial pages are re-fetched.

---

### `checkForUpdates()`

Checks for available application updates from the GitHub releases.

**Returns:** `Promise<void>`

**Example:**

```typescript
await window.api.checkForUpdates();
```

**IPC Channel:** `app:check-for-updates`

**Note:** Use `onUpdateStatus` event listener to receive update status notifications.

---

### `startDownload()`

Starts downloading an available update. Must be called after `checkForUpdates()` indicates an update is available.

**Returns:** `Promise<void>`

**Example:**

```typescript
await window.api.startDownload();
```

**IPC Channel:** `app:start-download`

**Note:** Use `onUpdateProgress` event listener to track download progress.

---

### `quitAndInstall()`

Quits the application and installs the downloaded update. Should only be called after the update has been fully downloaded.

**Returns:** `Promise<void>`

**Example:**

```typescript
await window.api.quitAndInstall();
```

**IPC Channel:** `app:quit-and-install`

**Warning:** This will immediately quit the application. Ensure all user data is saved before calling.

---

### `markPostAsViewed(postId: number)`

Marks a post as viewed in the database.

**Parameters:**

- `postId: number` - Post ID to mark as viewed

**Returns:** `Promise<boolean>`

**Example:**

```typescript
const success = await window.api.markPostAsViewed(123);
if (success) {
  console.log("Post marked as viewed");
}
```

**IPC Channel:** `db:mark-post-viewed`

---

### `searchArtists(query: string)`

Searches for artists in the local database by name or tag.

**Parameters:**

- `query: string` - Search query string

**Returns:** `Promise<{ id: number; label: string }[]>`

**Example:**

```typescript
const results = await window.api.searchArtists("artist");
results.forEach((result) => {
  console.log(result.id, result.label);
});
```

**IPC Channel:** `db:search-tags`

---

### `searchRemoteTags(query: string)`

Searches for tags using Rule34.xxx autocomplete API.

**Parameters:**

- `query: string` - Search query string (minimum 2 characters)

**Returns:** `Promise<{ id: string; label: string }[]>`

**Example:**

```typescript
const results = await window.api.searchRemoteTags("tag");
results.forEach((result) => {
  console.log(result.id, result.label);
});
```

**IPC Channel:** `api:search-remote-tags`

**Note:** Requires at least 2 characters. Returns empty array if query is too short or API call fails.

---

### `createBackup()`

Creates a timestamped backup of the database.

**Returns:** `Promise<BackupResponse>`

**BackupResponse Type:**

```typescript
type BackupResponse = {
  success: boolean;
  path?: string;
  error?: string;
};
```

**Example:**

```typescript
const result = await window.api.createBackup();
if (result.success) {
  console.log(`Backup created at: ${result.path}`);
} else {
  console.error(`Backup failed: ${result.error}`);
}
```

**IPC Channel:** `db:create-backup`

**Note:** The backup file is created in the user data directory. The file explorer will open to show the backup location.

---

### `restoreBackup()`

Restores the database from a backup file. Opens a file dialog to select the backup file.

**Returns:** `Promise<BackupResponse>`

**Example:**

```typescript
const result = await window.api.restoreBackup();
if (result.success) {
  console.log("Backup restored successfully");
  // Application will restart automatically
} else if (result.error !== "Canceled by user") {
  console.error(`Restore failed: ${result.error}`);
}
```

**IPC Channel:** `db:restore-backup`

**Warning:** This will overwrite the current database. The application will restart automatically after restore. User confirmation is required before restore.

---

### `writeToClipboard(text: string)`

Writes text to the system clipboard.

**Parameters:**

- `text: string` - Text to copy to clipboard

**Returns:** `Promise<boolean>`

**Example:**

```typescript
await window.api.writeToClipboard("Copied text");
```

**IPC Channel:** `app:write-to-clipboard`

---

### `verifyCredentials()`

Verifies API credentials by making a test API call.

**Returns:** `Promise<boolean>`

**Example:**

```typescript
const isValid = await window.api.verifyCredentials();
if (isValid) {
  console.log("Credentials are valid");
} else {
  console.log("Credentials are invalid or expired");
}
```

**IPC Channel:** `app:verify-creds`

---

### `logout()`

Clears stored API credentials from the database.

**Returns:** `Promise<void>`

**Example:**

```typescript
await window.api.logout();
// User will be redirected to onboarding screen
```

**IPC Channel:** `app:logout`

---

### `getArtistPostsCount(artistId?: number)`

Gets the total count of posts for an artist or all posts if no artistId is provided.

**Parameters:**

- `artistId?: number` - Optional artist ID. If omitted, returns count of all posts.

**Returns:** `Promise<number>`

**Example:**

```typescript
const count = await window.api.getArtistPostsCount(123);
console.log(`Artist has ${count} posts`);
```

**IPC Channel:** `db:get-posts-count`

---

### `togglePostViewed(postId: number)`

Toggles the viewed status of a post.

**Parameters:**

- `postId: number` - Post ID to toggle

**Returns:** `Promise<boolean>`

**Example:**

```typescript
const success = await window.api.togglePostViewed(123);
```

**IPC Channel:** `db:toggle-post-viewed`

---

### `togglePostFavorite(postId: number)`

Toggles the favorite status of a post.

**Parameters:**

- `postId: number` - Post ID to toggle

**Returns:** `Promise<boolean>`

**Example:**

```typescript
const success = await window.api.togglePostFavorite(123);
if (success) {
  console.log("Post favorite status toggled");
}
```

**IPC Channel:** `db:toggle-post-favorite`

---

### `resetPostCache(postId: number)`

Resets the cache for a specific post (clears viewed/favorite status).

**Parameters:**

- `postId: number` - Post ID to reset

**Returns:** `Promise<boolean>`

**Example:**

```typescript
const success = await window.api.resetPostCache(123);
```

**IPC Channel:** `db:reset-post-cache`

---

### `downloadFile(url: string, filename: string)`

Downloads a file from a URL to the local file system. Opens a save dialog for the user to choose the download location.

**Parameters:**

- `url: string` - URL of the file to download
- `filename: string` - Suggested filename for the download

**Returns:** `Promise<{ success: boolean; path?: string; error?: string; canceled?: boolean }>`

**Example:**

```typescript
const result = await window.api.downloadFile(
  "https://example.com/image.jpg",
  "image.jpg"
);
if (result.success && result.path) {
  console.log(`File downloaded to: ${result.path}`);
} else if (result.canceled) {
  console.log("Download canceled by user");
} else {
  console.error(`Download failed: ${result.error}`);
}
```

**IPC Channel:** `files:download`

**Note:** Downloads run in the Main Process with progress tracking via `onDownloadProgress` event.

---

### `openFileInFolder(path: string)`

Opens the file system folder containing the specified file and highlights the file.

**Parameters:**

- `path: string` - Full path to the file

**Returns:** `Promise<boolean>`

**Example:**

```typescript
const success = await window.api.openFileInFolder("/path/to/file.jpg");
```

**IPC Channel:** `files:open-folder`

---

### Event Listeners

The IPC bridge provides several event listeners for real-time updates:

#### `onUpdateStatus(callback: UpdateStatusCallback)`

Listens for update status changes.

**Callback Type:**

```typescript
type UpdateStatusCallback = (data: UpdateStatusData) => void;

type UpdateStatusData = {
  status: string; // "checking" | "available" | "not-available" | "downloaded" | "error"
  message?: string;
  version?: string; // Available when status is "available"
};
```

**Returns:** `() => void` - Unsubscribe function

**Example:**

```typescript
const unsubscribe = window.api.onUpdateStatus((data) => {
  if (data.status === "available") {
    console.log(`Update ${data.version} is available!`);
  }
});

// Later, to unsubscribe:
unsubscribe();
```

**IPC Channel:** `updater:status`

---

#### `onUpdateProgress(callback: UpdateProgressCallback)`

Listens for download progress updates.

**Callback Type:**

```typescript
type UpdateProgressCallback = (percent: number) => void;
```

**Returns:** `() => void` - Unsubscribe function

**Example:**

```typescript
const unsubscribe = window.api.onUpdateProgress((percent) => {
  console.log(`Download progress: ${percent}%`);
});

// Later, to unsubscribe:
unsubscribe();
```

**IPC Channel:** `updater:progress`

---

#### `onSyncStart(callback: () => void)`

Listens for sync start events.

**Returns:** `() => void` - Unsubscribe function

**Example:**

```typescript
const unsubscribe = window.api.onSyncStart(() => {
  console.log("Sync started");
});
```

**IPC Channel:** `sync:start`

---

#### `onSyncEnd(callback: () => void)`

Listens for sync completion events.

**Returns:** `() => void` - Unsubscribe function

**Example:**

```typescript
const unsubscribe = window.api.onSyncEnd(() => {
  console.log("Sync completed");
});
```

**IPC Channel:** `sync:end`

---

#### `onSyncProgress(callback: (message: string) => void)`

Listens for sync progress messages.

**Returns:** `() => void` - Unsubscribe function

**Example:**

```typescript
const unsubscribe = window.api.onSyncProgress((message) => {
  console.log(`Sync: ${message}`);
});
```

**IPC Channel:** `sync:progress`

---

#### `onSyncError(callback: SyncErrorCallback)`

Listens for sync error events.

**Callback Type:**

```typescript
type SyncErrorCallback = (message: string) => void;
```

**Returns:** `() => void` - Unsubscribe function

**Example:**

```typescript
const unsubscribe = window.api.onSyncError((message) => {
  console.error(`Sync error: ${message}`);
});
```

**IPC Channel:** `sync:error`

---

#### `onDownloadProgress(callback: DownloadProgressCallback)`

Listens for file download progress updates.

**Callback Type:**

```typescript
type DownloadProgressCallback = (data: DownloadProgressData) => void;

type DownloadProgressData = {
  id: string;
  percent: number;
};
```

**Returns:** `() => void` - Unsubscribe function

**Example:**

```typescript
const unsubscribe = window.api.onDownloadProgress((data) => {
  console.log(`Download ${data.id}: ${data.percent}%`);
});

// Later, to unsubscribe:
unsubscribe();
```

**IPC Channel:** `files:download-progress`

---

## Error Handling

All IPC methods can throw errors. Always wrap calls in try-catch blocks:

```typescript
try {
  const result = await window.api.addArtist(artistData);
} catch (error) {
  // Handle error appropriately
  if (error instanceof Error) {
    console.error(error.message);
  }
}
```

## Security Considerations

1. **Context Isolation:** The Renderer process runs in a sandboxed environment with no direct Node.js access.

2. **Type Safety:** All IPC communication is strictly typed. The bridge interface ensures type safety at compile time.

3. **Input Validation:** All inputs are validated in the Main process using Zod schemas before processing.

4. **Error Propagation:** Errors are properly propagated from Main to Renderer, but sensitive information is not exposed.

5. **Secure Credentials:** API keys are encrypted at rest using Electron's `safeStorage` API. Decryption only occurs in Main Process when needed for API calls.

6. **Worker Thread Isolation:** Database operations run in a dedicated worker thread, providing additional isolation.

## Implementation Details

### Main Process (IPC Handlers)

IPC handlers are registered in `src/main/ipc/index.ts`:

```typescript
export const registerIpcHandlers = (
  dbWorkerClient: DbWorkerClient,
  syncService: SyncService,
  updaterService: UpdaterService,
  mainWindow: BrowserWindow
) => {
  // App handlers
  ipcMain.handle("app:get-version", handleGetAppVersion);
  ipcMain.handle("app:get-settings", async () => {
    // Decrypts API key using SecureStorage
    const settings = await dbWorkerClient.call("getApiKeyDecrypted");
    // ... decryption logic
  });
  ipcMain.handle("app:save-settings", async (_event, { userId, apiKey }) => {
    // Encrypts API key using SecureStorage before saving
    const encryptedKey = SecureStorage.encrypt(apiKey);
    await dbWorkerClient.call("saveSettings", { userId, apiKey: encryptedKey });
  });
  ipcMain.handle("app:open-external", async (_event, urlString: string) => {
    // Security validation and shell.openExternal
  });

  // Database handlers (via worker thread)
  ipcMain.handle("db:get-artists", async () => {
    return dbWorkerClient.call("getTrackedArtists");
  });
  ipcMain.handle("db:add-artist", async (_event, payload: unknown) => {
    // Zod validation
    const artistData = AddArtistSchema.parse(payload);
    return dbWorkerClient.call("addArtist", artistData);
  });
  ipcMain.handle("db:delete-artist", async (_event, id: unknown) => {
    const validId = DeleteArtistSchema.parse(id);
    return dbWorkerClient.call("deleteArtist", { id: validId });
  });
  ipcMain.handle("db:get-posts", async (_event, payload: unknown) => {
    // Zod validation
    const { artistId, page, limit } = GetPostsSchema.parse(payload);
    const offset = (page - 1) * limit;
    return dbWorkerClient.call("getPostsByArtist", { artistId, limit, offset });
  });
  ipcMain.handle("db:mark-post-viewed", async (_event, postId: unknown) => {
    const validId = MarkViewedSchema.parse(postId);
    return dbWorkerClient.call("markPostAsViewed", { postId: validId });
  });
  ipcMain.handle("db:search-tags", async (_event, query: unknown) => {
    const validQuery = SearchTagsSchema.parse(query);
    return dbWorkerClient.call("searchArtists", { query: validQuery });
  });

  // Backup handlers
  ipcMain.handle("db:create-backup", async () => {
    const result = await dbWorkerClient.call("backup");
    shell.showItemInFolder(result.backupPath);
    return { success: true, path: result.backupPath };
  });
  ipcMain.handle("db:restore-backup", async () => {
    const { filePaths } = await dialog.showOpenDialog(mainWindow, {
      filters: [{ name: "SQLite DB", extensions: ["db", "sqlite"] }],
    });
    await dbWorkerClient.restore(filePaths[0]);
    mainWindow.reload();
    return { success: true };
  });

  // Remote search
  ipcMain.handle("api:search-remote-tags", async (_event, query: unknown) => {
    // Calls Rule34.xxx autocomplete API
  });

  // Sync handlers
  ipcMain.handle("db:sync-all", async () => {
    syncService.syncAllArtists();
  });
  ipcMain.handle("sync:repair-artist", async (_event, artistId: number) => {
    await syncService.repairArtist(artistId);
    return { success: true };
  });

  // Updater handlers
  ipcMain.handle("app:check-for-updates", () => {
    updaterService.checkForUpdates();
  });
  // ... other updater handlers
};
```

### Preload Script (Bridge)

The bridge is exposed in `src/main/bridge.ts`:

```typescript
const ipcBridge: IpcBridge = {
  getAppVersion: () => ipcRenderer.invoke("app:get-version"),

  getSettings: () => ipcRenderer.invoke("app:get-settings"),
  saveSettings: (creds) => ipcRenderer.invoke("app:save-settings", creds),

  getTrackedArtists: () => ipcRenderer.invoke("db:get-artists"),
  addArtist: (artist) => ipcRenderer.invoke("db:add-artist", artist),
  deleteArtist: (id) => ipcRenderer.invoke("db:delete-artist", id),
  searchArtists: (query) => ipcRenderer.invoke("db:search-tags", query),

  getArtistPosts: ({ artistId, page }) =>
    ipcRenderer.invoke("db:get-posts", { artistId, page }),
  markPostAsViewed: (postId) =>
    ipcRenderer.invoke("db:mark-post-viewed", postId),

  openExternal: (url) => ipcRenderer.invoke("app:open-external", url),
  searchRemoteTags: (query) =>
    ipcRenderer.invoke("api:search-remote-tags", query),

  syncAll: () => ipcRenderer.invoke("db:sync-all"),
  repairArtist: (artistId) =>
    ipcRenderer.invoke("sync:repair-artist", artistId),

  createBackup: () => ipcRenderer.invoke("db:create-backup"),
  restoreBackup: () => ipcRenderer.invoke("db:restore-backup"),

  // Updater methods
  checkForUpdates: () => ipcRenderer.invoke("app:check-for-updates"),
  quitAndInstall: () => ipcRenderer.invoke("app:quit-and-install"),
  startDownload: () => ipcRenderer.invoke("app:start-download"),

  // Event listeners
  onUpdateStatus: (callback) => {
    const subscription = (_: IpcRendererEvent, data: UpdateStatusData) =>
      callback(data);
    ipcRenderer.on("updater:status", subscription);
    return () => ipcRenderer.removeListener("updater:status", subscription);
  },
  onUpdateProgress: (callback) => {
    const subscription = (_: IpcRendererEvent, percent: number) =>
      callback(percent);
    ipcRenderer.on("updater:progress", subscription);
    return () => ipcRenderer.removeListener("updater:progress", subscription);
  },
  onSyncStart: (callback) => {
    const sub = () => callback();
    ipcRenderer.on("sync:start", sub);
    return () => ipcRenderer.removeListener("sync:start", sub);
  },
  onSyncEnd: (callback) => {
    const sub = () => callback();
    ipcRenderer.on("sync:end", sub);
    return () => ipcRenderer.removeListener("sync:end", sub);
  },
  onSyncProgress: (callback) => {
    const sub = (_: IpcRendererEvent, msg: string) => callback(msg);
    ipcRenderer.on("sync:progress", sub);
    return () => ipcRenderer.removeListener("sync:progress", sub);
  },
  onSyncError: (callback) => {
    const subscription = (_: IpcRendererEvent, msg: string) => callback(msg);
    ipcRenderer.on("sync:error", subscription);
    return () => ipcRenderer.removeListener("sync:error", subscription);
  },
};

contextBridge.exposeInMainWorld("api", ipcBridge);
```

## Future API Extensions

Planned API methods (not yet implemented):

- `updateArtist(artistId: number, data: Partial<Artist>)` - Update artist settings
- `downloadPost(postId: number)` - Download a post's media file
- `getSubscriptions()` - Get tag subscriptions
- `addSubscription(tagString: string)` - Subscribe to a tag combination
- `deleteSubscription(id: number)` - Remove a subscription
- `getBackupList()` - List available backup files
- `deleteBackup(backupPath: string)` - Delete a backup file

## External API Integration

The application integrates with **Rule34.xxx API**. Integration is handled in the Main process via `SyncService` (`src/main/services/sync-service.ts`) and is not directly exposed via IPC for security reasons.

**Features:**

- **Rate Limiting:** 1.5 second delay between artists, 0.5 second between pages
- **Pagination:** Handles Rule34.xxx pagination (up to 1000 posts per page)
- **Error Handling:** Graceful handling of API errors and network failures
- **Incremental Sync:** Only fetches posts newer than `lastPostId`
- **Authentication:** Uses User ID and API Key from settings

**API Endpoint:** `https://api.rule34.xxx/index.php?page=dapi&s=post&q=index`

See [Rule34 API Reference](./rule34-api-reference.md) for detailed API documentation.
</file>

<file path="docs/development.md">
# Development Guide

This guide covers the development setup, build process, and common development tasks.

## Prerequisites

- **Node.js:** v18 or higher
- **npm:** v9 or higher (or yarn)
- **Git:** For version control

## Initial Setup

### 1. Clone the Repository

```bash
git clone https://github.com/KazeKaze93/ruledesk.git
cd ruledesk
```

### 2. Install Dependencies

```bash
npm install
```

This installs:

- Electron and Electron-related dependencies
- React and React-related dependencies
- TypeScript and build tools
- Database libraries (Drizzle ORM, better-sqlite3)
- UI libraries (Tailwind CSS, shadcn/ui components)

### 3. Verify Installation

```bash
npm run typecheck
npm run lint
```

## Development Scripts

### `npm run dev`

Starts the application in development mode with Hot Module Replacement (HMR).

**What it does:**

- Starts Vite dev server for the Renderer process
- Compiles Main process with watch mode
- Opens Electron window with DevTools enabled
- Enables HMR for React components

**Usage:**

```bash
npm run dev
```

### `npm run build`

Builds the application for production.

**What it does:**

- Compiles TypeScript for Main and Renderer
- Bundles React application
- Generates production-ready Electron app in `out/`

**Usage:**

```bash
npm run build
```

### `npm run preview`

Previews the production build locally.

**Usage:**

```bash
npm run build
npm run preview
```

### `npm run typecheck`

Runs TypeScript compiler in check mode (no emit).

**Usage:**

```bash
npm run typecheck
```

### `npm run lint`

Runs ESLint to check code quality.

**Usage:**

```bash
npm run lint
```

### Database Scripts

#### `npm run db:generate`

Generates a new database migration from schema changes.

**Usage:**

1. Modify `src/main/db/schema.ts`
2. Run: `npm run db:generate`
3. Review generated migration in `drizzle/`

#### `npm run db:migrate`

Runs pending database migrations.

**Usage:**

```bash
npm run db:migrate
```

**Note:** Migrations run automatically on app startup, but you can run them manually for testing.

#### `npm run db:studio`

Opens Drizzle Studio for database inspection.

**Usage:**

```bash
npm run db:studio
```

Opens web interface at `http://localhost:4983` (default port).

## Project Structure

```
.
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main/                          # Electron Main Process
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db/                        # Database layer
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repositories/          # Repository pattern
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ artists.repo.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ posts.repo.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db-worker.ts          # Worker thread implementation
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db-worker-client.ts   # Worker client interface
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrate.ts             # Migration runner
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.ts              # Drizzle schema definitions
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ worker-types.ts        # Worker type definitions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ipc/                       # IPC handlers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/              # Modular handlers
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ artists.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ files.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ viewer.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ channels.ts            # IPC channel constants
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts               # Handler registration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/                  # Background services
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ secure-storage.ts      # Secure storage for credentials
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync-service.ts        # API synchronization
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ updater-service.ts     # Auto-updater
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/                        # Utilities
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts              # Logging utility
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bridge.ts                  # IPC bridge interface
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.d.ts                  # Type definitions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.ts                    # Main process entry point
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ renderer/                      # Electron Renderer Process
‚îÇ       ‚îú‚îÄ‚îÄ components/                 # React components
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dialogs/               # Dialog components
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ gallery/               # Gallery components
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ inputs/                # Input components
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ layout/                # Layout components
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ pages/                 # Page components
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ settings/              # Settings components
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ui/                    # shadcn/ui components
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ viewer/                # Viewer components
‚îÇ       ‚îú‚îÄ‚îÄ i18n/                      # Internationalization
‚îÇ       ‚îú‚îÄ‚îÄ lib/                       # Utilities
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ hooks/                 # Custom React hooks
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ artist-utils.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ tag-utils.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îÇ       ‚îú‚îÄ‚îÄ locales/                   # Translation files
‚îÇ       ‚îú‚îÄ‚îÄ schemas/                    # Form validation schemas
‚îÇ       ‚îú‚îÄ‚îÄ store/                      # Zustand stores
‚îÇ       ‚îú‚îÄ‚îÄ App.tsx                     # Main React component
‚îÇ       ‚îú‚îÄ‚îÄ main.tsx                    # Renderer entry point
‚îÇ       ‚îî‚îÄ‚îÄ index.html                  # HTML template
‚îÇ
‚îú‚îÄ‚îÄ drizzle/                            # Database migrations
‚îÇ   ‚îú‚îÄ‚îÄ meta/                          # Migration metadata
‚îÇ   ‚îî‚îÄ‚îÄ *.sql                          # SQL migration files
‚îÇ
‚îú‚îÄ‚îÄ docs/                               # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ api.md
‚îÇ   ‚îú‚îÄ‚îÄ architecture.md
‚îÇ   ‚îú‚îÄ‚îÄ contributing.md
‚îÇ   ‚îú‚îÄ‚îÄ database.md
‚îÇ   ‚îú‚îÄ‚îÄ development.md
‚îÇ   ‚îú‚îÄ‚îÄ roadmap.md
‚îÇ   ‚îî‚îÄ‚îÄ rule34-api-reference.md
‚îÇ
‚îú‚îÄ‚îÄ scripts/                            # Build and utility scripts
‚îÇ   ‚îú‚îÄ‚îÄ ai_reviewer.py
‚îÇ   ‚îî‚îÄ‚îÄ system_prompt.md
‚îÇ
‚îú‚îÄ‚îÄ .github/                            # GitHub workflows
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ ai-review.yml
‚îÇ       ‚îî‚îÄ‚îÄ ci.yml
‚îÇ
‚îú‚îÄ‚îÄ electron.vite.config.ts             # Electron-Vite configuration
‚îú‚îÄ‚îÄ drizzle.config.ts                   # Drizzle ORM configuration
‚îú‚îÄ‚îÄ tailwind.config.js                  # Tailwind CSS configuration
‚îú‚îÄ‚îÄ tsconfig.json                       # TypeScript configuration
‚îî‚îÄ‚îÄ package.json                        # Project dependencies and scripts
```

## Development Workflow

### 1. Making Changes

**Main Process Changes:**

- Edit files in `src/main/`
- Changes require app restart (no HMR for Main process)
- Check console for errors

**Renderer Changes:**

- Edit files in `src/renderer/`
- Changes hot-reload automatically
- Check browser DevTools for errors

### 2. Adding New Features

**Adding an IPC Method:**

1. Define in `src/main/bridge.ts`:

   ```typescript
   export interface IpcBridge {
     newMethod: () => Promise<ReturnType>;
   }
   ```

2. Implement in `src/main/bridge.ts`:

   ```typescript
   const ipcBridge: IpcBridge = {
     newMethod: () => ipcRenderer.invoke("channel:name"),
   };
   ```

3. Add handler in `src/main/ipc/handlers/` (create new file or add to existing):

   ```typescript
   ipcMain.handle("channel:name", async () => {
     // Implementation
   });
   ```

4. Update types in `src/renderer.d.ts`:
   ```typescript
   export interface IpcApi {
     newMethod: () => Promise<ReturnType>;
   }
   ```

**Adding a Database Table:**

1. Add schema in `src/main/db/schema.ts`
2. Generate migration: `npm run db:generate`
3. Review migration in `drizzle/`
4. Test: `npm run db:migrate`

**Adding a React Component:**

1. Create component in `src/renderer/components/`
2. Use TypeScript and proper typing
3. Use Tailwind CSS for styling
4. Follow component patterns from existing code

### 3. Testing Changes

**Before Committing:**

```bash
# Type check
npm run typecheck

# Lint
npm run lint

# Manual testing
npm run dev
```

## Build Configuration

### Electron-Vite

**File:** `electron.vite.config.ts`

Configures:

- Main process build
- Preload script build
- Renderer process build (Vite)

### TypeScript

**File:** `tsconfig.json`

- Strict mode enabled
- ES modules
- Path aliases configured

### Tailwind CSS

**File:** `tailwind.config.js`

- Content paths configured
- Custom theme extensions
- shadcn/ui integration

## Debugging

### Main Process Debugging

**Console Logs:**

- Use `logger` from `src/main/lib/logger.ts`
- Logs appear in terminal/console

**Debugger:**

- Use VS Code debugger with Electron configuration
- Set breakpoints in Main process code

### Renderer Process Debugging

**DevTools:**

- Automatically opened in development mode
- Use React DevTools extension
- Use browser DevTools for debugging

**Console:**

- Access via `window.api` in DevTools console
- Test IPC calls directly

### Database Debugging

**Drizzle Studio:**

```bash
npm run db:studio
```

**Logs:**

- Database operations logged via `logger`
- Check for SQL errors in console

## Common Issues

### Issue: TypeScript Errors

**Solution:**

```bash
npm run typecheck
# Fix errors shown
```

### Issue: Database Migration Errors

**Solution:**

1. Check migration files in `drizzle/`
2. Verify schema changes
3. Try manual migration: `npm run db:migrate`

### Issue: IPC Not Working

**Solution:**

1. Verify bridge is exposed: Check `src/main/bridge.ts`
2. Verify handler is registered: Check `src/main/ipc/index.ts`
3. Check types match: Verify `src/renderer.d.ts`

### Issue: Build Fails

**Solution:**

1. Clear build cache: Delete `out/` and `node_modules/.vite/`
2. Reinstall dependencies: `rm -rf node_modules && npm install`
3. Check for TypeScript errors: `npm run typecheck`

## Performance Optimization

### Development

- Use React DevTools Profiler
- Monitor IPC call frequency
- Check database query performance

### Production

- Enable production builds
- Minimize bundle size
- Optimize database queries
- Use indexes where needed

## Code Quality

### TypeScript

- No `any` types
- No unsafe casts
- Proper error handling
- Type inference where possible

### React

- Functional components only
- Proper prop typing
- Hooks best practices
- No inline styles

### Database

- Use Drizzle ORM (no raw SQL)
- Type-safe queries
- Proper error handling
- Transaction support where needed

## Environment Variables

Currently, no environment variables are required. Future additions:

- `API_KEY` - External API key (if needed)
- `NODE_ENV` - Development/production mode
- `ELECTRON_RENDERER_URL` - Dev server URL (auto-set by electron-vite)

## Hot Module Replacement (HMR)

**Renderer Process:**

- ‚úÖ Fully supported
- React components hot-reload
- CSS changes apply instantly
- Vite dev server provides instant updates

**Main Process:**

- ‚ö†Ô∏è Partially supported
- No automatic HMR - changes require manual app restart
- `electron-vite` watches Main process files but doesn't auto-restart
- **Workaround:** Use `nodemon` or similar tool for auto-restart during development
- **Current Status:** Manual restart required after Main process changes

## Production Build

### Building

```bash
npm run build
```

Output in `out/`:

- `out/main/` - Main process bundle
- `out/preload/` - Preload script
- `out/renderer/` - Renderer bundle

### Distribution

Use `electron-builder` (configured in `package.json`):

```bash
# Build for current platform
npm run build
npx electron-builder

# Build for specific platform
npx electron-builder --win
npx electron-builder --mac
npx electron-builder --linux
```

## Additional Resources

- [Electron Documentation](https://www.electronjs.org/docs)
- [Drizzle ORM Documentation](https://orm.drizzle.team/)
- [React Documentation](https://react.dev/)
- [TypeScript Documentation](https://www.typescriptlang.org/docs/)
- [Tailwind CSS Documentation](https://tailwindcss.com/docs)

## Getting Help

1. Check existing documentation in `docs/`
2. Review similar code in the codebase
3. Check GitHub issues
4. Open a new issue with details
</file>

<file path="drizzle/meta/_journal.json">
{
  "version": "5",
  "dialect": "sqlite",
  "entries": [
    {
      "idx": 0,
      "version": "5",
      "when": 1766130825943,
      "tag": "0000_tearful_jimmy_woo",
      "breakpoints": true
    }
  ]
}
</file>

<file path="src/main/db/worker-types.ts">
export type DbMethod =
  // Database Maintenance
  | "fixDatabaseSchema"
  | "repairArtistTags"
  | "runDeferredMaintenance"
  // Artist Management
  | "getTrackedArtists"
  | "addArtist"
  | "updateArtistLastChecked"
  | "updateArtistProgress"
  | "savePostsForArtist"
  | "getPostsByArtist"
  | "getPostsCountByArtist"
  | "getPostById"
  | "getArtistById"
  | "searchArtists"
  | "deleteArtist"
  | "markPostAsViewed"
  | "togglePostFavorite"
  | "togglePostViewed"
  | "resetPostCache"
  | "updatePost"
  // Settings & Security
  | "getSettings"
  | "saveSettings"
  | "getSettingsStatus"
  | "getApiKeyDecrypted"
  | "logout"
  // Backup
  | "backup";

/**
 * Request message sent from Main process to DB Worker
 */
export interface WorkerRequest {
  id: string;
  type: DbMethod;
  payload: unknown;
}

/**
 * Response message sent from DB Worker to Main process
 */
export interface WorkerResponse {
  id: string;
  success: boolean;
  data?: unknown;
  error?: string;
}
</file>

<file path="src/renderer/components/gallery/ArtistGallery.tsx">
import React, { forwardRef, useMemo, useEffect, useState } from "react";
import {
  useInfiniteQuery,
  useQueryClient,
  useQuery,
  useMutation,
  InfiniteData,
} from "@tanstack/react-query";
import { useTranslation } from "react-i18next";
import { ArrowLeft, ExternalLink, Wrench, Loader2 } from "lucide-react";
import { VirtuosoGrid } from "react-virtuoso";
import { Button } from "../ui/button";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "../ui/tabs";
import type { Artist, Post } from "../../../main/db/schema";
import { cn } from "../../lib/utils";
import { useViewerStore } from "../../store/viewerStore";
import { PostCard } from "../gallery/PostCard";
import { useDebounce } from "../../lib/hooks/useDebounce";
import { useSearchStore } from "../../store/searchStore";

interface ArtistGalleryProps {
  artist: Artist;
  onBack: () => void;
}

const GridContainer = forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "grid grid-cols-2 gap-4 p-4 pb-32 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5",
      className
    )}
    {...props}
  />
));
GridContainer.displayName = "GridContainer";

const ItemContainer = forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("w-full aspect-[2/3]", className)} {...props} />
));
ItemContainer.displayName = "ItemContainer";

export const ArtistGallery: React.FC<ArtistGalleryProps> = ({
  artist,
  onBack,
}) => {
  const { t } = useTranslation();
  const queryClient = useQueryClient();
  const [activeTab, setActiveTab] = useState<"tracked" | "source">("tracked");

  // Global Search State
  const { searchQuery, setSearchQuery } = useSearchStore();
  const debouncedSearch = useDebounce(searchQuery, 500);

  useEffect(() => {
    setSearchQuery("");
  }, [artist.id, setSearchQuery]);

  // Zustand Store
  const openViewer = useViewerStore((state) => state.open);
  const updateQueueIds = useViewerStore((state) => state.updateQueueIds);
  const isOpen = useViewerStore((state) => state.isOpen);

  const { data: totalCount = 0 } = useQuery({
    queryKey: ["posts-count", artist.id],
    queryFn: () => window.api.getArtistPostsCount(artist.id),
  });

  // Tracked posts (from DB)
  const {
    data: trackedData,
    fetchNextPage: fetchNextTrackedPage,
    hasNextPage: hasNextTrackedPage,
    isFetchingNextPage: isFetchingNextTrackedPage,
    isLoading: isLoadingTracked,
  } = useInfiniteQuery({
    queryKey: ["posts", artist.id, { tags: debouncedSearch }],
    queryFn: async ({ pageParam = 1 }) => {
      return window.api.getArtistPosts({
        artistId: artist.id,
        page: pageParam,
        filters: { tags: debouncedSearch },
      });
    },
    getNextPageParam: (lastPage, allPages) => {
      return lastPage.length === 50 ? allPages.length + 1 : undefined;
    },
    initialPageParam: 1,
    enabled: activeTab === "tracked",
  });

  const trackedPosts = useMemo(
    () => trackedData?.pages.flatMap((page) => page) || [],
    [trackedData]
  );

  // Source posts (from Rule34 API)
  const {
    data: sourceData,
    fetchNextPage: fetchNextSourcePage,
    hasNextPage: hasNextSourcePage,
    isFetchingNextPage: isFetchingNextSourcePage,
    isLoading: isLoadingSource,
  } = useInfiniteQuery({
    queryKey: ["posts-source", artist.id, { tags: debouncedSearch }],
    queryFn: async ({ pageParam = 1 }) => {
      const tagQuery = `${artist.type === "uploader" ? "user:" : ""}${
        artist.tag
      }`;
      const searchTags = debouncedSearch
        ? `${tagQuery} ${debouncedSearch}`
        : tagQuery;
      return window.api.getRecentPostsRemote(pageParam, searchTags);
    },
    getNextPageParam: (lastPage, allPages) => {
      return lastPage.length === 100 ? allPages.length + 1 : undefined;
    },
    initialPageParam: 1,
    enabled: activeTab === "source",
  });

  const sourcePosts = useMemo(
    () => sourceData?.pages.flatMap((page) => page) || [],
    [sourceData]
  );

  const allPosts = activeTab === "tracked" ? trackedPosts : sourcePosts;
  const isLoading =
    activeTab === "tracked" ? isLoadingTracked : isLoadingSource;
  const hasNextPage =
    activeTab === "tracked" ? hasNextTrackedPage : hasNextSourcePage;
  const isFetchingNextPage =
    activeTab === "tracked"
      ? isFetchingNextTrackedPage
      : isFetchingNextSourcePage;
  const fetchNextPage =
    activeTab === "tracked" ? fetchNextTrackedPage : fetchNextSourcePage;

  React.useEffect(() => {
    if (isOpen && allPosts.length > 0) {
      updateQueueIds(allPosts.map((p) => p.id));
    }
  }, [allPosts, isOpen, updateQueueIds]);

  const handleResetCache = async () => {
    if (!confirm(t("artistGallery.resetConfirm"))) return;
    try {
      await window.api.resetPostCache(artist.id);
      queryClient.invalidateQueries({ queryKey: ["posts", artist.id] });
    } catch (error) {
      console.error("Failed to reset cache:", error);
    }
  };

  const viewMutation = useMutation({
    mutationFn: async (postId: number) => {
      await window.api.updatePost(postId, { isViewed: true });
    },
    onSuccess: (_, postId) => {
      queryClient.setQueryData<InfiniteData<Post[]>>(
        ["posts", artist.id],
        (oldData) => {
          if (!oldData) return oldData;
          return {
            ...oldData,
            pages: oldData.pages.map((page) =>
              page.map((post) =>
                post.id === postId ? { ...post, isViewed: true } : post
              )
            ),
          };
        }
      );
    },
  });

  const handlePostClick = (post: Post, posts: Post[]) => {
    const index = posts.findIndex((p) => p.id === post.id);
    if (index === -1) return;

    // 1. –û—Ç–∫—Ä—ã–≤–∞–µ–º (UI First)
    openViewer({
      origin: { kind: "artist", artistId: artist.id },
      ids: posts.map((p) => p.id),
      initialIndex: index,
      listKey: `artist-${artist.id}-${activeTab}`,
      hasNextPage,
      fetchNextPage,
    });

    // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å (Fire and forget) - only for tracked posts
    if (activeTab === "tracked" && !post.isViewed) {
      viewMutation.mutate(post.id);
    }
  };

  const handleToggleFavorite = async (post: Post) => {
    const newState = !post.isFavorited;
    // Only update DB for tracked posts
    if (activeTab === "tracked") {
      await window.api.updatePost(post.id, { isFavorited: newState });
      queryClient.invalidateQueries({ queryKey: ["posts", artist.id] });
    }
  };

  const renderGrid = (posts: Post[]) => {
    if (isLoading && posts.length === 0) {
      return (
        <div className="flex justify-center items-center h-full text-muted-foreground">
          <Loader2 className="w-8 h-8 animate-spin" />
        </div>
      );
    }

    if (posts.length === 0) {
      return (
        <div className="flex justify-center items-center h-full text-muted-foreground">
          <p>No posts found</p>
        </div>
      );
    }

    return (
      <VirtuosoGrid
        style={{ height: "100%" }}
        totalCount={posts.length}
        endReached={() => {
          if (hasNextPage && !isFetchingNextPage) {
            fetchNextPage();
          }
        }}
        components={{
          List: GridContainer,
          Item: ItemContainer,
          Footer: () =>
            isFetchingNextPage ? (
              <div className="flex col-span-full justify-center py-4 w-full">
                <Loader2 className="w-6 h-6 animate-spin text-primary" />
              </div>
            ) : null,
        }}
        itemContent={(index) => {
          const post = posts[index];
          if (!post) return null;

          return (
            <PostCard
              post={post}
              onClick={() => handlePostClick(post, allPosts)}
              onToggleFavorite={() => handleToggleFavorite(post)}
            />
          );
        }}
      />
    );
  };

  return (
    <div className="flex flex-col h-full bg-background">
      {/* Header */}
      <div className="flex z-10 shrink-0 justify-between items-center px-6 py-4 bg-background/95 border-b backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div className="flex gap-4 items-center">
          <Button variant="ghost" size="icon" onClick={onBack}>
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div>
            <h2 className="text-xl font-bold tracking-tight">{artist.name}</h2>
            <p className="text-sm text-muted-foreground">
              {activeTab === "tracked" ? `${totalCount} posts` : "Source"}
            </p>
          </div>
        </div>

        <div className="flex gap-2">
          {activeTab === "tracked" && (
            <Button variant="outline" size="sm" onClick={handleResetCache}>
              <Wrench className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Edit</span>
            </Button>
          )}
          <Button
            variant="outline"
            size="sm"
            onClick={() =>
              window.api.openExternal(
                `https://rule34.xxx/index.php?page=post&s=list&tags=${artist.tag}`
              )
            }
          >
            <ExternalLink className="w-4 h-4 sm:mr-2" />
            <span className="hidden sm:inline">{t("artistGallery.web")}</span>
          </Button>
        </div>
      </div>

      {/* Tabs */}
      <Tabs
        value={activeTab}
        onValueChange={(v) => setActiveTab(v as "tracked" | "source")}
        className="flex flex-col flex-1 min-h-0"
      >
        <div className="px-6 pt-4">
          <TabsList>
            <TabsTrigger value="tracked">Tracked</TabsTrigger>
            <TabsTrigger value="source">Source</TabsTrigger>
          </TabsList>
        </div>

        {/* Grid Content */}
        <TabsContent value="tracked" className="flex-1 mt-0 min-h-0">
          {renderGrid(trackedPosts)}
        </TabsContent>

        <TabsContent value="source" className="flex-1 mt-0 min-h-0">
          {renderGrid(sourcePosts)}
        </TabsContent>
      </Tabs>
    </div>
  );
};
</file>

<file path="src/main/ipc/channels.ts">
export const IPC_CHANNELS = {
  APP: {
    GET_VERSION: "app:get-version",
    OPEN_EXTERNAL: "app:open-external",
    DOWNLOAD_FILE: "app:download-file",
    WRITE_CLIPBOARD: "app:write-to-clipboard",
    LOGOUT: "app:logout",
    VERIFY_CREDS: "app:verify-creds",
  },
  SETTINGS: {
    GET: "app:get-settings-status",
    SAVE: "app:save-settings",
  },
  DB: {
    GET_ARTISTS: "db:get-artists",
    ADD_ARTIST: "db:add-artist",
    DELETE_ARTIST: "db:delete-artist",
    SEARCH_TAGS: "db:search-tags",
    GET_POSTS: "db:get-posts",
    GET_POSTS_COUNT: "db:get-posts-count",
    UPDATE_POST: "db:update-post",
    MARK_VIEWED: "db:mark-post-viewed",
    TOGGLE_FAVORITE: "db:toggle-post-favorite",
    SYNC_ALL: "db:sync-all",
    TOGGLE_POST_VIEWED: "db:toggle-post-viewed" as const,
    RESET_POST_CACHE: "db:reset-post-cache" as const,
    GET_API_KEY_ENCRYPTED: "db:get-api-key-encrypted",
  },
  API: {
    SEARCH_REMOTE: "api:search-remote-tags",
    GET_RECENT_POSTS: "api:get-recent-posts",
  },
  BACKUP: {
    CREATE: "db:create-backup",
    RESTORE: "db:restore-backup",
  },
  SYNC: {
    REPAIR: "sync:repair-artist",
  },

  FILES: {
    DOWNLOAD: "files:download",
    OPEN_FOLDER: "files:open-folder",
    DOWNLOAD_PROGRESS: "files:download-progress",
  },
} as const;
</file>

<file path="src/main/ipc/handlers/files.ts">
import { ipcMain, app, shell, dialog, BrowserWindow } from "electron";
import path from "path";
import fs from "fs";
import axios, { AxiosProgressEvent } from "axios";
import { pipeline } from "stream/promises";
import { logger } from "../../lib/logger";
import { IPC_CHANNELS } from "../channels";
import { z } from "zod";

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ Electron
const getMainWindow = (): BrowserWindow | undefined => {
  const windows = BrowserWindow.getAllWindows();
  return windows.find((w) => w.isVisible() && !w.isDestroyed()) || windows[0];
};

const DOWNLOAD_ROOT = path.join(app.getPath("downloads"), "BooruClient");

const DownloadFileSchema = z.object({
  url: z
    .string()
    .url()
    .refine((val) => val.startsWith("http://") || val.startsWith("https://"), {
      message: "Only HTTP/HTTPS protocols are allowed for downloads.",
    }),
  filename: z
    .string()
    .min(1)
    .regex(/^[\w\-. ]+$/, "Invalid filename characters"),
});

export const registerFileHandlers = () => {
  let totalBytes = 0;

  // –•–µ–Ω–¥–ª–µ—Ä —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å –¥–∏–∞–ª–æ–≥–æ–º "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫"
  ipcMain.handle(
    IPC_CHANNELS.FILES.DOWNLOAD,
    async (_event, url: unknown, filename: unknown) => {
      const mainWindow = getMainWindow();
      if (!mainWindow) {
        logger.error("IPC: Main window not found for download.");
        return { success: false, error: "Main window not available" };
      }

      // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Zod
      const validation = DownloadFileSchema.safeParse({ url, filename });

      if (!validation.success) {
        logger.error("IPC: Download validation failed", validation.error);
        return { success: false, error: "Invalid URL or Filename" };
      }

      const { url: validUrl, filename: validFilename } = validation.data;

      try {
        const defaultDir = DOWNLOAD_ROOT;

        // 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        if (!fs.existsSync(defaultDir)) {
          try {
            fs.mkdirSync(defaultDir, { recursive: true });
          } catch (e) {
            logger.error("Failed to create download directory", e);
            // –ù–µ –ø–∞–¥–∞–µ–º, –¥–∏–∞–ª–æ–≥ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –ø–∞–ø–∫–µ –û–°
          }
        }

        const defaultPath = path.join(defaultDir, validFilename);

        const { canceled, filePath } = await dialog.showSaveDialog(mainWindow, {
          title: "–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª",
          defaultPath: defaultPath,
          buttonLabel: "–°–∫–∞—á–∞—Ç—å",
          filters: [
            {
              name: "Media Files",
              extensions: ["jpg", "jpeg", "png", "gif", "mp4", "webm"],
            },
            { name: "All Files", extensions: ["*"] },
          ],
        });

        if (canceled || !filePath) {
          logger.info("IPC: Download canceled by user");
          return { success: false, canceled: true };
        }

        logger.info(`IPC: Downloading: ${validUrl} -> ${filePath}`);

        const response = await axios({
          method: "GET",
          url: validUrl,
          responseType: "stream",
          headers: {
            "User-Agent":
              "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
          },
          onDownloadProgress: (progressEvent: AxiosProgressEvent) => {
            if (!mainWindow || !progressEvent.total) return;

            totalBytes = progressEvent.total;
            const percent = Math.round(
              (progressEvent.loaded * 100) / totalBytes
            );

            mainWindow.webContents.send(IPC_CHANNELS.FILES.DOWNLOAD_PROGRESS, {
              id: validFilename, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è –∫–∞–∫ ID
              percent: percent,
            });
          },
        });

        const writer = fs.createWriteStream(filePath);
        await pipeline(response.data, writer);

        mainWindow.webContents.send(IPC_CHANNELS.FILES.DOWNLOAD_PROGRESS, {
          id: validFilename,
          percent: 100,
        });
        logger.info(`IPC: Download success -> ${filePath}`);
        return { success: true, path: filePath };
      } catch (error) {
        if (mainWindow) {
          mainWindow.webContents.send(IPC_CHANNELS.FILES.DOWNLOAD_PROGRESS, {
            id: validFilename,
            percent: 0,
          });
        }
        logger.error("IPC: Download failed:", error);
        return {
          success: false,
          error: error instanceof Error ? error.message : String(error),
        };
      }
    }
  );

  // –•–µ–Ω–¥–ª–µ—Ä –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–ø–∫–∏
  ipcMain.handle(
    IPC_CHANNELS.FILES.OPEN_FOLDER,
    async (_, filePathOrName: string) => {
      if (!filePathOrName || typeof filePathOrName !== "string") return false;

      try {
        let fullPath = filePathOrName;

        if (!path.isAbsolute(filePathOrName)) {
          fullPath = path.join(DOWNLOAD_ROOT, filePathOrName);
        }

        const normalizedPath = path.normalize(fullPath);

        if (!normalizedPath.startsWith(DOWNLOAD_ROOT)) {
          logger.error(
            `SECURITY VIOLATION: Attempt to open path outside safe directory: ${normalizedPath}`
          );
          shell.openPath(DOWNLOAD_ROOT);
          return false;
        }

        if (fs.existsSync(normalizedPath)) {
          shell.showItemInFolder(normalizedPath);
          return true;
        }

        if (fs.existsSync(DOWNLOAD_ROOT)) {
          await shell.openPath(DOWNLOAD_ROOT);
          return true;
        }

        return false;
      } catch (error) {
        logger.error("Failed to open folder:", error);
        return false;
      }
    }
  );
};
</file>

<file path="src/main/db/schema.ts">
import {
  sqliteTable,
  text,
  integer,
  unique,
  index,
} from "drizzle-orm/sqlite-core";

export const artists = sqliteTable("artists", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  name: text("name").notNull(),
  tag: text("tag").notNull().unique(),
  type: text("type", { enum: ["tag", "uploader", "query"] }).notNull(),
  apiEndpoint: text("api_endpoint").notNull(),
  lastPostId: integer("last_post_id").notNull().default(0),
  newPostsCount: integer("new_posts_count").notNull().default(0),
  lastChecked: integer("last_checked", { mode: "timestamp" }),
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .$defaultFn(() => new Date()),
});

export const posts = sqliteTable(
  "posts",
  {
    id: integer("id").primaryKey({ autoIncrement: true }),
    postId: integer("post_id").notNull(),
    artistId: integer("artist_id")
      .notNull()
      .references(() => artists.id, { onDelete: "cascade" }),
    fileUrl: text("file_url").notNull(),
    previewUrl: text("preview_url").notNull(),
    sampleUrl: text("sample_url").notNull().default(""),
    title: text("title").default(""),
    rating: text("rating").default(""),
    tags: text("tags").notNull(),
    publishedAt: integer("published_at", { mode: "timestamp" }).notNull(),
    createdAt: integer("created_at", { mode: "timestamp" })
      .notNull()
      .$defaultFn(() => new Date()),
    isViewed: integer("is_viewed", { mode: "boolean" })
      .notNull()
      .default(false),
    isFavorited: integer("is_favorited", { mode: "boolean" }) // –î–æ–±–∞–≤–∏–ª–∏ –ø–æ–ª–µ
      .notNull()
      .default(false),
  },
  (t) => ({
    uniquePost: unique().on(t.artistId, t.postId),
    artistIdIdx: index("artistIdIdx").on(t.artistId),
    isViewedIdx: index("isViewedIdx").on(t.isViewed),
    publishedAtIdx: index("publishedAtIdx").on(t.publishedAt),
    isFavoritedIdx: index("isFavoritedIdx").on(t.isFavorited),
  })
);

export const settings = sqliteTable("settings", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  userId: text("user_id").default(""),
  encryptedApiKey: text("encrypted_api_key").default(""),
  isSafeMode: integer("is_safe_mode", { mode: "boolean" }).default(true),
  isAdultConfirmed: integer("is_adult_confirmed", { mode: "boolean" }).default(
    false
  ),
});

// Types
export type Artist = typeof artists.$inferSelect;
export type NewArtist = typeof artists.$inferInsert;
export type Post = typeof posts.$inferSelect & {
  isFavorited: boolean;
};
export type NewPost = typeof posts.$inferInsert;
export type Settings = typeof settings.$inferSelect;
export type NewSettings = typeof settings.$inferInsert;
</file>

<file path="src/main/ipc/handlers/posts.ts">
import { ipcMain, safeStorage } from "electron";
import { z } from "zod";
import { IPC_CHANNELS } from "../channels";
import { PostsService } from "../../services/posts.service";
import { logger } from "../../lib/logger";
import { SettingsService } from "../../services/settings.service";

// --- Schemas & Interfaces ---

const GetPostsSchema = z.object({
  artistId: z.number().int(),
  page: z.number().int().default(1),
  filters: z
    .object({
      tags: z.string().optional(),
      rating: z.enum(["s", "q", "e"]).optional(),
      isFavorited: z.boolean().optional(),
    })
    .optional(),
});

const UpdatePostSchema = z.object({
  id: z.number(),
  changes: z.object({
    isViewed: z.boolean().optional(),
    isFavorited: z.boolean().optional(),
  }),
});

const GetRecentPostsSchema = z.object({
  page: z.number().default(1),
  tags: z.string().optional(),
});

interface RemotePost {
  id: number;
  postId: number;
  artistId: number;
  fileUrl: string;
  previewUrl: string;
  sampleUrl: string;
  title: string;
  rating: string;
  tags: string;
  publishedAt: Date;
  createdAt: Date;
  isViewed: boolean;
  isFavorited: boolean;
}

// --- Handlers ---

export const registerPostHandlers = (service: PostsService) => {
  // [DB] Get Posts
  ipcMain.handle(IPC_CHANNELS.DB.GET_POSTS, async (_, payload: unknown) => {
    const validation = GetPostsSchema.safeParse(payload);
    if (!validation.success) return [];
    try {
      const { artistId, page, filters } = validation.data;
      const limit = 50;
      const offset = (page - 1) * limit;
      return await service.getPosts({ artistId, filters, limit, offset });
    } catch (error) {
      logger.error("IPC: [db:get-posts] error:", error);
      return [];
    }
  });

  // [DB] Get Posts Count
  ipcMain.handle(
    IPC_CHANNELS.DB.GET_POSTS_COUNT,
    async (_, artistId: number) => {
      try {
        return await service.getPostsCount({ artistId });
      } catch (_error) {
        return 0;
      }
    }
  );

  // [DB] Update Post
  ipcMain.handle(IPC_CHANNELS.DB.UPDATE_POST, async (_, payload: unknown) => {
    const validation = UpdatePostSchema.safeParse(payload);
    if (!validation.success) return false;
    try {
      const { id, changes } = validation.data;
      await service.updatePost(id, changes);
      return true;
    } catch (_error) {
      return false;
    }
  });

  // [API] Get Recent Posts (XML FIX - SPLIT METHOD)
  ipcMain.handle(
    IPC_CHANNELS.API.GET_RECENT_POSTS,
    async (_, payload: unknown) => {
      const validation = GetRecentPostsSchema.safeParse(payload);
      const { page, tags } = validation.success
        ? validation.data
        : { page: 1, tags: "" };

      try {
        const pid = Math.max(0, page - 1);
        const limit = 100;
        const baseUrl = "https://api.rule34.xxx/index.php";
        const params = new URLSearchParams({
          page: "dapi",
          s: "post",
          q: "index",
          limit: limit.toString(),
          pid: pid.toString(),
        });
        if (tags) params.append("tags", tags);

        const settingsService = new SettingsService();
        const settings = await settingsService.getSettings();

        if (settings.userId && settings.encryptedApiKey) {
          params.append("user_id", settings.userId);

          // –î–µ—à–∏—Ñ—Ä—É–µ–º API key
          if (safeStorage.isEncryptionAvailable()) {
            try {
              const decrypted = safeStorage.decryptString(
                Buffer.from(settings.encryptedApiKey, "base64")
              );
              params.append("api_key", decrypted);
            } catch (e) {
              logger.warn("Failed to decrypt API key for browse", e);
            }
          }
        }

        const url = `${baseUrl}?${params.toString()}`;
        logger.info(`IPC: Fetching remote posts (XML): ${url}`);

        const response = await fetch(url, {
          headers: {
            "User-Agent":
              "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
          },
        });

        if (!response.ok) return [];

        const xmlText = await response.text();
        const posts: RemotePost[] = [];

        // [FIX] –ü–∞—Ä—Å–∏–Ω–≥ –º–µ—Ç–æ–¥–æ–º split (–Ω–∞–¥–µ–∂–Ω–µ–µ —á–µ–º —Å–ª–æ–∂–Ω—ã–π regex)
        const rawParts = xmlText.split("<post ");

        for (let i = 1; i < rawParts.length; i++) {
          const part = rawParts[i];

          // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∞—Ç—Ä–∏–±—É—Ç–∞
          const getAttr = (name: string) => {
            // –ò—â–µ–º name="value"
            const match = part.match(new RegExp(`${name}="([^"]*)"`));
            return match ? match[1] : "";
          };

          const id = getAttr("id");
          const fileUrl = getAttr("file_url");

          if (id && fileUrl) {
            posts.push({
              id: Number(id),
              postId: Number(id),
              artistId: 0,
              fileUrl: fileUrl,
              previewUrl: getAttr("preview_url") || fileUrl,
              sampleUrl: getAttr("sample_url") || fileUrl,
              title: "",
              rating: getAttr("rating") || "q",
              tags: getAttr("tags"),
              publishedAt: new Date(
                Number(getAttr("change") || Date.now() / 1000) * 1000
              ),
              createdAt: new Date(),
              isViewed: false,
              isFavorited: false,
            });
          }
        }

        logger.info(
          `IPC: Parsed ${posts.length} posts from XML (Split Method)`
        );
        return posts;
      } catch (error) {
        logger.error("IPC: [api:get-recent-posts] error:", error);
        return [];
      }
    }
  );
};
</file>

<file path="docs/roadmap.md">
# üöÄ Roadmap

## ‚úÖ Recent Fixes & Current Status (COMPLETED)

We have successfully stabilized the application core. The following issues are RESOLVED:

### Infrastructure & Build

- ‚úÖ Fixed `better-sqlite3` native build on Windows (resolved `node-gyp`, Python, and ABI version mismatches)
- ‚úÖ App runs successfully via `npm run dev` and communicates with the SQLite database

### Database & Schema

- ‚úÖ Replaced incompatible `unixepoch` and JS-dates with raw SQL timestamps (ms)
- ‚úÖ Added proper `UNIQUE` constraints to the `posts` table (`artistId` + `postId`) to enable correct UPSERT operations
- ‚úÖ Added `sampleUrl` column for progressive image loading
- ‚úÖ Migrations system (`drizzle-kit`) is fully functional

### Data Integrity & Sync

- ‚úÖ Implemented Tag Normalization in `AddArtistModal`: Inputs like "tag (123)" are now stripped to "tag" before saving/syncing
- ‚úÖ SyncService correctly handles `ON CONFLICT` and populates the gallery
- ‚úÖ Fixed timestamp handling: `lastChecked` now uses `new Date()` with proper Drizzle timestamp mode

### UI/UX

- ‚úÖ Fixed "Soapy/Blurred" Previews: Image rendering quality for previews has been corrected
- ‚úÖ Implemented Progressive Image Loading: 3-layer system (Preview ‚Üí Sample ‚Üí Original) for instant viewing
- ‚úÖ Basic Gallery grid is functional
- ‚úÖ AsyncAutocomplete component for artist/tag search with free-text input support

---

## üöÄ Active Roadmap (Priority Tasks)

We are moving to Feature Development. Implement the following modules:

## üß≠ Navigation & UX Revamp

### Sidebar Navigation

Implement a persistent sidebar with main navigation sections:

- **Updates** - Subscriptions feed (new posts from tracked sources)
- **Browse** - All posts view with advanced filtering
- **Favorites** - Account favorites synced from booru
- **Tracked** - Artists and tags management
- **Settings** - Application configuration

### Global Top Bar

Unified top bar on all content pages:

- **Search Bar** - Quick search across posts, tags, artists
- **Filters Panel** - Rating, media type, tags, date range filters
- **Sort Controls** - Sort by date added, posted date, rating
- **View Toggle** - Grid, list, masonry layout options
- **Sync Status** - Real-time sync indicator with last sync timestamp

### Viewer Polish

Enhanced full-screen viewer experience:

- **Auto-hide Bars** - Top and bottom bars hide after inactivity
- **Tags Sheet** - Right-side slide-over drawer with clickable tags
  - Click tag to add filter (`+tag`)
  - Right-click or modifier key to exclude (`-tag`)
  - Visual indicators for active filters
- **Tooltips** - Keyboard shortcuts and action hints
- **Keyboard Shortcuts:**
  - `Esc` - Close viewer
  - `‚Üê/‚Üí` - Navigate between posts
  - `F` - Toggle favorite
  - `V` - Mark as viewed
  - `T` - Toggle tags drawer

### Gallery Card Overlays

Post cards with informative overlays:

- **Viewed Badge** - Indicator for viewed posts
- **Favorite Badge** - Star icon for favorited posts
- **Rating Badge** - Visual indicator (Safe/Questionable/Explicit)
- **Media Type Badge** - Icon for image/video content

### Progressive Image Loading

Optimized loading strategy:

- **Preview URL** - Low-res blurred preview (instant display in gallery)
- **Sample URL** - Medium-res sample (loaded in gallery)
- **File URL** - Full-res original (loaded only in viewer)

## üì∞ Subscriptions / Updates

### Feed Tab

Unified feed showing all new posts:

- **All New Posts** - Combined feed from all tracked sources
- **Filters** - Apply tags, rating, media type filters
- **Infinite Scroll** - Progressive loading as user scrolls
- **Mark as Read** - Batch mark posts as viewed

### Creators Tab

List/tile view of creators with new post counts:

- **Creator List** - Grid or list view of tracked artists
- **New Count Badge** - Display number of unviewed posts per creator
- **Quick Actions** - Sync, repair, view gallery per creator
- **Filters** - Filter creators by type (tag/uploader)

### Filters

Advanced filtering within Updates section:

- **Tag Filters** - Include/exclude specific tags
- **Rating Filter** - Safe, Questionable, Explicit
- **Media Type Filter** - Images, Videos, or both
- **Date Range** - Filter by publication date

## üõ°Ô∏è Security & Reliability (Hardening)

### API Key Security

Enhanced security for API credentials:

- **Renderer Isolation** - Renderer process never receives raw API key
- **Safe Storage** - Use Electron's `safeStorage` API (Windows Credential Manager, macOS Keychain, Linux libsecret)
- **AES-GCM Policy** - Encrypt API keys at rest with AES-GCM encryption
- **Threat Model** - Stolen database file does not reveal API key in plaintext

**Status:** ‚úÖ **COMPLETED:** API keys encrypted at rest, decryption only in Main Process.

### Database Backups & Integrity

Comprehensive database protection:

- **Backup System** - Manual and automatic pre-maintenance backups
- **Restore Flow** - Restore from backup with automatic restart
- **Integrity Check** - Run `PRAGMA integrity_check` and display results
- **Retention Policy** - Keep last N backups, auto-cleanup old backups

**Status:** ‚úÖ **Phase 1 COMPLETED:** Manual backup/restore implemented. Future: Auto-backups, integrity check UI, retention policy.

### Auto Maintenance

Non-blocking database maintenance:

- **Worker Thread** - All heavy operations run in database worker thread
- **Non-blocking** - Maintenance operations don't freeze UI
- **Progress Events** - Real-time progress updates for long operations
- **Scheduled Runs** - Automatic maintenance on startup or periodic intervals

**Status:** ‚úÖ **COMPLETED:** Database operations run in worker thread. Future: Scheduled maintenance runs.

## üìã Milestones

### MVP (Minimum Viable Product)

Core features for initial release:

- ‚úÖ **Navigation & Sidebar** - Basic sidebar with main sections (implemented)
- ‚úÖ **Global Top Bar** - Search, filters, sort, view toggle UI (implemented, backend filtering pending)
- ‚úÖ **Viewer Polish** - Full-screen viewer with keyboard shortcuts, download, favorites (implemented)
- ‚úÖ **Progressive Loading** - Preview ‚Üí Sample ‚Üí Original (implemented)
- ‚è≥ **Auto-sync Startup** - Toggle for automatic sync on app launch (planned)
- ‚úÖ **Worker Threads** - Database operations in worker thread (completed)
- ‚úÖ **Download Manager** - Individual file downloads with progress tracking (implemented)
- ‚úÖ **Favorites System** - Mark and manage favorite posts (implemented)

### Next Phase

Enhanced features after MVP:

- ‚úÖ **Favorites System** - Mark and manage favorite posts (implemented)
- ‚úÖ **Tag Autocomplete** - Local and remote tag search with autocomplete (implemented)
- ‚è≥ **Favorites Sync** - Sync account favorites from booru (planned)
- ‚è≥ **Playlists Groundwork** - Basic playlist tables and UI structure (planned)
- ‚è≥ **Periodic Sync** - Configurable interval sync while app running (planned)
- ‚è≥ **Card Overlays** - Viewed, favorite, rating, media type badges (partially implemented - viewed and favorite badges exist)

### Later Phase

Advanced features for future releases:

- ‚è≥ **Smart Playlists** - Auto-fill playlists based on tag rules
- ‚è≥ **Normalized Tag Index** - Full-text search on tags (FTS5 virtual tables)
- ‚è≥ **Advanced Caching** - Intelligent cache management with size limits
- ‚è≥ **Proxy Support** - Optional proxy configuration for API requests
- ‚è≥ **Multi-Booru** - Provider pattern for multiple booru sources

## üîß Technical Improvements (From Audit)

### Developer Experience

- ‚è≥ **Main Process HMR:** Implement auto-restart for Main process changes (nodemon/watch mode)
  - **Current:** Manual restart required
  - **Target:** Automatic restart on Main process file changes

### Security & Privacy

- ‚è≥ **Safe Mode / NSFW Filter:** Implement content blur/filtering based on settings
  - **Current:** No blur logic or `safeMode` flag
  - **Target:** Add `safeMode` setting in database, blur logic in `PostCard.tsx`
- ‚è≥ **Age Gate:** Implement 18+ confirmation overlay
  - **Current:** Only disclaimer text in README
  - **Target:** One-time confirmation dialog with localStorage flag

### Portability

- ‚è≥ **Portable Mode:** Support relative database and asset paths
  - **Current:** Uses absolute paths via `app.getPath("userData")`
  - **Target:** Check for `portable` flag/env var, use relative paths

### Code Quality

- ‚è≥ **Centralized Input Sanitization:** Create shared validation utility
  - **Current:** Zod validation per handler (decentralized)
  - **Target:** `src/main/lib/validation.ts` with shared schemas

### Anti-Bot Measures

- ‚è≥ **Request Randomization:** Implement User-Agent rotation and request jitters
  - **Current:** Static User-Agent, fixed delays
  - **Target:** Randomized User-Agents, variable delays with jitter

### Database Optimization

- ‚è≥ **FTS5 Virtual Tables:** Full-text search for tag searching
  - **Current:** Standard indexes only (`artistIdIdx`, `isViewedIdx`, etc.)
  - **Target:** FTS5 virtual table for efficient tag search

### Error Handling

- ‚è≥ **Standardized IPC Error Responses:** User-friendly error messages
  - **Current:** Some handlers return raw errors, inconsistent formatting
  - **Target:** Consistent user-friendly error messages across all IPC handlers

### Video Performance

- ‚è≥ **Explicit Hardware Acceleration:** Configure webPreferences for optimal video playback
  - **Current:** Video handling exists, relies on Electron defaults
  - **Target:** Explicit `enableWebGL` and hardware acceleration flags

### A. Filters (Advanced Search) [Priority: High] üöß In Progress

**Goal:** Allow users to refine the gallery view.

**UI:**

- ‚úÖ Top Bar filter panel (part of Global Top Bar) - UI implemented
- ‚úÖ Search bar in Global Top Bar
- ‚úÖ Sort dropdown in Global Top Bar
- ‚úÖ View toggle (Grid/List) in Global Top Bar

**Functionality:**

- ‚è≥ Filter by **Rating** (Safe, Questionable, Explicit) - UI ready, backend filtering pending
- ‚è≥ Filter by **Media Type** (Image vs Video) - UI ready, backend filtering pending
- ‚è≥ Filter by **Tags** (Local search within downloaded posts) - UI ready, backend filtering pending
- ‚è≥ Sort by: Date Added (New/Old), Posted Date - UI ready, backend sorting pending

**Implementation Notes:**

- Use Drizzle ORM queries with proper filtering
- Maintain type safety with Zod/TypeScript
- Update UI state via React Query invalidation

**Status:** UI components implemented in `GlobalTopBar.tsx`. Backend filtering and sorting logic needs to be connected to the UI controls.

---

### B. Download Manager [Priority: High] ‚úÖ Implemented (Partial)

**Goal:** Allow saving full-resolution files to the local file system (outside the app's internal DB cache).

**Features:**

- ‚úÖ "Download Original" button on post view (implemented in ViewerDialog)
- ‚úÖ **Queue System:** Handle downloads in the background/main process with progress tracking
- ‚úÖ **Progress Events:** Real-time download progress via IPC events (`onDownloadProgress`)
- ‚úÖ **File Management:** Open downloaded file in folder (`openFileInFolder`)
- ‚è≥ "Download All" for current filter/artist (planned)
- ‚è≥ **Settings:** Allow choosing a default download directory (planned)

**Implementation Notes:**

- Downloads run in Main Process (file I/O) via `registerFileHandlers`
- IPC events provide download progress updates
- Queue management prevents overwhelming the system
- Download preferences can be stored in settings table (future enhancement)

**Status:** Core download functionality implemented. Individual file downloads work with progress tracking. Batch download and default directory settings are planned for future releases.

---

### C. Playlists / Collections [Priority: Medium] ‚è≥ Not Started

**Goal:** Create curated collections of posts independent of Artists/Trackers.

#### Phase 1: MVP

1. **Database:**

   - [ ] New table `playlists` (`id`, `name`, `created_at`)
   - [ ] New table `playlist_posts` (`playlist_id`, `post_id`, `added_at`)

2. **UI Interactions:**

   - [ ] "‚≠ê Add to playlist" button on Post Card (opens Popover: List of playlists + "Create New")
   - [ ] New Page/Tab: "Playlists" (in Sidebar)
   - [ ] View Playlist: Grid view of posts inside a playlist

3. **Logic:**
   - [ ] Filter inside playlist (Search tags by `LIKE`)
   - [ ] Sort by `addedAt`
   - [ ] Remove post from playlist
   - [ ] Delete/Rename playlist

**Implementation Notes:**

- Follow existing database patterns (Drizzle ORM, type safety)
- Use IPC for all database operations
- Maintain separation of concerns (Renderer ‚Üî Main)

**Status:** No playlist tables in schema, no playlist-related code implemented.

#### Phase 2: Future Improvements (Not for now)

- Drag & Drop sorting
- Smart/Dynamic Playlists (Auto-fill based on tags)
- JSON Export/Import

---

## üèóÔ∏è Architecture Considerations

### Design Principles

- **KISS & YAGNI:** Keep It Simple, Stupid. You Aren't Gonna Need It.
- **SOLID:** Single Responsibility, Open/Closed, Dependency Inversion
- **DRY:** Don't Repeat Yourself
- **Type Safety:** Strict TypeScript, Zod validation, no `any` types
- **Separation of Concerns:** Renderer (UI) ‚Üî Main Process (I/O, DB, API)

### Implementation Guidelines

- Maintain current schema patterns (no regression)
- Strict type safety (Zod/TypeScript)
- Separation of Concerns (Renderer vs Main process)
- Follow existing IPC patterns and service architecture
- Use Drizzle ORM for all database operations (no raw SQL)
- Proper error handling with descriptive messages

---

## üîÆ Long-Term Goals (Future Considerations)

### Multi-Booru Support

- Refactor `SyncService` into Provider Pattern
- Abstract booru-specific logic
- Support for Danbooru, Gelbooru, etc.

### Dual-Module System

- **Module 1: Library** - Local database, favorites, gallery
- **Module 2: Browser** - Embedded Webview for native site navigation
  - JS injection (`preload`) for site integration
  - Floating Action Button (FAB) "Track Artist" overlay

### Statistics Dashboard

- Analytics on tracked artists and posts
- Sync history and statistics
- Content analysis

---

---

## üìù Notes

- All features must maintain backward compatibility
- Database migrations must be tested thoroughly
- UI/UX should follow existing design patterns
- Performance optimization is important for large datasets (6000+ posts)
</file>

<file path="docs/architecture.md">
# Architecture Documentation

## Overview

This application follows a strict **Separation of Concerns (SoC)** architecture, dividing responsibilities between the Electron Main Process (secure Node.js environment) and the Renderer Process (sandboxed browser environment).

### Architecture Diagram

```mermaid
graph TB
    subgraph "Renderer Process (Browser)"
        ReactContext[React Context<br/>Components & State]
        TanStackQuery[TanStack Query<br/>Data Fetching]
        Zustand[Zustand Store<br/>UI State]
    end

    subgraph "IPC Bridge"
        Preload[preload.ts<br/>Context Bridge]
        IPCHandlers[IPC Handlers<br/>Validation & Routing]
    end

    subgraph "Main Process (Node.js)"
        ServicesLayer[Services Layer<br/>Business Logic]
        BackendClients[Backend Clients<br/>API Communication]
    end

    subgraph "Worker Thread"
        DBWorker[Database Worker<br/>SQLite Operations]
        DrizzleORM[Drizzle ORM<br/>Type-Safe Queries]
    end

    subgraph "External"
        Rule34API[Rule34.xxx API<br/>External Service]
        SQLiteDB[(SQLite Database<br/>Local Storage)]
    end

    ReactContext <--> Preload
    TanStackQuery <--> Preload
    Zustand --> ReactContext
    Preload <--> IPCHandlers
    IPCHandlers --> ServicesLayer
    ServicesLayer --> BackendClients
    ServicesLayer <--> DBWorker
    DBWorker --> DrizzleORM
    DrizzleORM --> SQLiteDB
    BackendClients --> Rule34API

    style ReactContext fill:#e1f5ff
    style Preload fill:#fff4e1
    style ServicesLayer fill:#ffe1e1
    style DBWorker fill:#f0e1ff
    style SQLiteDB fill:#e1ffe1
    style Rule34API fill:#ffe1f5
```

## Architecture Concept

### 1. Dual-Module Interface

- **Library Mode:** Works with local SQLite database. Maximum performance, virtualization.
- **Browser Mode:** Isolated `<webview>` process. Allows users to browse the source (Source) natively. "Bridge" between the site and application is implemented through script injection (DOM scraping + IPC triggers).

### 2. Provider Abstraction (Future Proofing)

- In the future, `SyncService` will no longer be tightly coupled to Rule34.
- Introduces `BooruProvider` interface (methods: `getPosts`, `getArtistInfo`, `search`).
- Current implementation will become `Rule34Provider`. This allows adding new sources without rewriting the core database.

## High-Level Architecture

### System Overview

```mermaid
graph TB
    subgraph "Electron Application"
        subgraph "Renderer Process (Browser)"
            ReactUI[React UI Components]
            Zustand[Zustand Store]
            ReactQuery[TanStack Query]
        end

        subgraph "IPC Bridge"
            Preload[preload.ts]
            IPC[IPC Handlers]
        end

        subgraph "Main Process (Node.js)"
            Services[Services Layer]
            BackendClients[Backend Clients]
        end

        subgraph "Worker Thread"
            DBWorker[Database Worker]
            Drizzle[Drizzle ORM]
        end
    end

    subgraph "External"
        Rule34API[Rule34.xxx API]
        SQLite[(SQLite Database)]
    end

    ReactUI <--> Preload
    Preload <--> IPC
    IPC --> Services
    Services --> BackendClients
    Services <--> DBWorker
    DBWorker --> Drizzle
    Drizzle --> SQLite
    BackendClients --> Rule34API

    ReactUI --> Zustand
    ReactUI --> ReactQuery
    ReactQuery --> Preload
```

### Process Communication Flow

```mermaid
sequenceDiagram
    participant User
    participant ReactUI as React UI
    participant Bridge as IPC Bridge
    participant IPC as IPC Handlers
    participant Service as Services
    participant Worker as DB Worker
    participant DB as SQLite
    participant API as Rule34 API

    User->>ReactUI: User Action
    ReactUI->>Bridge: window.api.method()
    Bridge->>IPC: ipcRenderer.invoke()
    IPC->>IPC: Validate Input (Zod)
    IPC->>Service: Call Service Method
    Service->>Worker: dbWorkerClient.call()
    Worker->>DB: Execute Query
    DB-->>Worker: Return Data
    Worker-->>Service: Return Result
    Service-->>IPC: Return Response
    IPC-->>Bridge: IPC Response
    Bridge-->>ReactUI: Promise Resolve
    ReactUI->>User: Update UI
```

### Database Worker Architecture

```mermaid
graph LR
    subgraph "Main Process"
        Main[Main Process]
        Client[DB Worker Client]
    end

    subgraph "Worker Thread"
        Worker[DB Worker]
        DrizzleORM[Drizzle ORM]
        SQLiteDB[(SQLite)]
    end

    Main -->|RPC Call| Client
    Client -->|PostMessage| Worker
    Worker -->|Query| DrizzleORM
    DrizzleORM -->|SQL| SQLiteDB
    SQLiteDB -->|Result| DrizzleORM
    DrizzleORM -->|Data| Worker
    Worker -->|PostMessage| Client
    Client -->|Promise Resolve| Main
```

## Process Separation

### Main Process (The Brain)

**Location:** `src/main/`

**Responsibilities:**

- Database operations (SQLite via Drizzle ORM)
- External API communication
- File system operations
- Background polling jobs
- Security-sensitive operations

**Key Components:**

1. **Database Worker** (`src/main/db/db-worker.ts`)

   - Runs in a dedicated worker thread for non-blocking database operations
   - Manages all database operations using Drizzle ORM
   - Thread-safe SQLite access isolated from main process
   - RPC pattern with correlation IDs for request/response matching
   - Methods: getTrackedArtists, addArtist, deleteArtist, getPostsByArtist, savePostsForArtist, getSettings, saveSettings, backup, restore, searchArtists, markPostAsViewed

2. **Database Worker Client** (`src/main/db/db-worker-client.ts`)

   - Client interface for communicating with database worker thread
   - Handles worker lifecycle (initialization, termination)
   - Provides async/await interface over worker RPC calls
   - Manages backup and restore operations

3. **Repositories** (`src/main/db/repositories/`)

   - **ArtistsRepository** (`artists.repo.ts`) - Abstraction layer for artist operations

     - `getAll()` - Get all tracked artists
     - `add(artist)` - Add new artist
     - `delete(id)` - Delete artist
     - `searchTags(query)` - Search artists by tag/name

   - **PostsRepository** (`posts.repo.ts`) - Abstraction layer for post operations

     - `getByArtist(params)` - Get posts for artist with pagination
     - `getCountByArtist(artistId)` - Get post count
     - `markAsViewed(postId)` - Mark post as viewed
     - `toggleFavorite(postId)` - Toggle favorite status
     - `togglePostViewed(postId)` - Toggle viewed status
     - `resetPostCache(postId)` - Reset post cache

   - Repositories provide a clean abstraction over direct worker client calls
   - Used by IPC handlers for type-safe database operations

4. **Sync Service** (`src/main/services/sync-service.ts`)

   - Handles Rule34.xxx API synchronization
   - Implements rate limiting and pagination
   - Maps API responses to database schema
   - Updates artist post counts
   - Provides repair/resync functionality for artists
   - Emits IPC events for sync progress tracking

5. **IPC Handlers** (`src/main/ipc/index.ts`)

   - Registers all IPC communication channels
   - Modular handler structure in `src/main/ipc/handlers/`
   - Validates input from Renderer using Zod schemas
   - Delegates to appropriate services and repositories
   - Security validation (e.g., openExternal URL whitelist)
   - Handles updater and sync event subscriptions

   **Handler Modules:**

   - `artists.ts` - Artist-related IPC handlers
   - `files.ts` - File download handlers
   - `posts.ts` - Post-related IPC handlers
   - `settings.ts` - Settings IPC handlers
   - `viewer.ts` - Viewer-related IPC handlers

6. **Updater Service** (`src/main/services/updater-service.ts`)

   - Manages automatic update checking via `electron-updater`
   - Handles update download and installation
   - Emits IPC events for update status and progress
   - User-controlled download (manual download trigger)

7. **Secure Storage** (`src/main/services/secure-storage.ts`)

   - Encrypts and decrypts sensitive data using Electron's `safeStorage` API
   - Used for API credentials encryption at rest
   - Decryption only occurs in Main Process when needed
   - Methods: encrypt, decrypt

8. **Bridge** (`src/main/bridge.ts`)

   - Defines the IPC interface
   - Exposed via preload script
   - Type-safe communication contract
   - Event listener management for real-time updates

9. **Main Entry** (`src/main/main.ts`)
   - Application initialization
   - Window creation
   - Security configuration
   - Database worker thread initialization and migrations

### Renderer Process (The Face)

**Location:** `src/renderer/`

**Responsibilities:**

- User interface rendering
- User interactions
- State management
- Data presentation

**Key Components:**

1. **React Application** (`src/renderer/App.tsx`)

   - Main UI component with routing logic
   - Onboarding screen for API credentials
   - Sidebar navigation with multiple pages
   - Uses TanStack Query for data fetching
   - State management via React hooks and Zustand

2. **Components** (`src/renderer/components/`)

   - **Pages:**

     - **Updates.tsx** - Subscriptions feed (stub, in development)
     - **Browse.tsx** - All posts view with filtering (stub, in development)
     - **Favorites.tsx** - Favorites collection (stub, in development)
     - **Tracked.tsx** - Artists and tags management
     - **Settings.tsx** - Application configuration
     - **ArtistDetails.tsx** - Artist gallery view
     - **Onboarding.tsx** - API credentials input form

   - **Layout:**

     - **AppLayout.tsx** - Main application layout with sidebar
     - **Sidebar.tsx** - Persistent sidebar navigation
     - **GlobalTopBar.tsx** - Unified top bar with search, filters, sort controls

   - **Gallery:**

     - **ArtistCard.tsx** - Artist card component
     - **ArtistGallery.tsx** - Grid view of posts for an artist
     - **PostCard.tsx** - Individual post card component

   - **Viewer:**

     - **ViewerDialog.tsx** - Full-screen viewer with download, favorites, keyboard shortcuts

   - **Dialogs:**

     - **AddArtistModal.tsx** - Modal for adding new artists
     - **DeleteArtistDialog.tsx** - Confirmation dialog for artist deletion
     - **UpdateNotification.tsx** - Update notification component

   - **Settings:**

     - **BackupControls.tsx** - Database backup and restore controls

   - **Inputs:**

     - **AsyncAutocomplete.tsx** - Autocomplete component with local and remote search

   - **ui/** - shadcn/ui components (Button, Dialog, Select, Input, etc.)

3. **IPC Client** (`window.api`)
   - Typed interface to Main process
   - All communication goes through this bridge
   - Methods: getSettings, saveSettings, getTrackedArtists, addArtist, deleteArtist, getArtistPosts, getArtistPostsCount, syncAll, openExternal, searchArtists, searchRemoteTags, markPostAsViewed, togglePostViewed, togglePostFavorite, downloadFile, openFileInFolder, createBackup, restoreBackup, writeToClipboard, verifyCredentials, logout, resetPostCache

## Security Architecture

### Security Layers

```mermaid
graph TB
    subgraph "Renderer Process (Sandboxed)"
        ReactUI[React UI]
        BridgeAPI[window.api]
    end

    subgraph "IPC Bridge (Secure)"
        Preload[preload.ts]
        ContextIsolation[Context Isolation]
    end

    subgraph "Main Process (Secure)"
        IPCHandlers[IPC Handlers]
        ZodValidation[Zod Validation]
        Services[Services]
    end

    subgraph "Secure Storage"
        SafeStorage[Electron safeStorage]
        Keychain[Platform Keychain]
    end

    subgraph "Worker Thread (Isolated)"
        DBWorker[DB Worker]
        SQLite[(SQLite)]
    end

    ReactUI -->|Only via| BridgeAPI
    BridgeAPI -->|contextBridge| Preload
    Preload -->|contextIsolation: true| ContextIsolation
    ContextIsolation -->|Validated| IPCHandlers
    IPCHandlers -->|Zod Schema| ZodValidation
    ZodValidation -->|Validated Input| Services
    Services -->|Encrypted| SafeStorage
    SafeStorage -->|Platform API| Keychain
    Services -->|RPC| DBWorker
    DBWorker -->|Isolated| SQLite

    style ReactUI fill:#e1f5ff
    style ContextIsolation fill:#fff4e1
    style ZodValidation fill:#ffe1e1
    style SafeStorage fill:#e1ffe1
    style DBWorker fill:#f0e1ff
```

### Context Isolation

**Status:** ‚úÖ Enabled

The Renderer process runs in a sandboxed environment with no direct Node.js access. This prevents Remote Code Execution (RCE) attacks.

**Configuration:**

```typescript
webPreferences: {
  contextIsolation: true,  // Required
  nodeIntegration: false,  // Never true
  sandbox: true,           // Additional security
  preload: path.join(__dirname, "../preload/bridge.cjs"),
}
```

### IPC Security

1. **Type Safety:** All IPC communication is strictly typed
2. **Input Validation:** All inputs are validated in Main process using Zod schemas
3. **Error Handling:** Errors are properly handled without exposing sensitive data
4. **No Direct Node Access:** Renderer cannot access Node.js APIs directly
5. **Secure Credentials:** API keys encrypted at rest, only decrypted in Main Process when needed
6. **Worker Thread Isolation:** Database operations isolated in worker thread

### Credential Security Flow

```mermaid
sequenceDiagram
    participant User
    participant ReactUI as React UI
    participant Bridge as IPC Bridge
    participant IPC as IPC Handler
    participant SecureStorage as Secure Storage
    participant Keychain as Platform Keychain
    participant DB as Database

    User->>ReactUI: Enter API Credentials
    ReactUI->>Bridge: window.api.saveSettings({userId, apiKey})
    Bridge->>IPC: ipcRenderer.invoke('app:save-settings')
    IPC->>SecureStorage: encrypt(apiKey)
    SecureStorage->>Keychain: safeStorage.encryptString()
    Keychain-->>SecureStorage: Encrypted Buffer
    SecureStorage-->>IPC: Encrypted String
    IPC->>DB: Save (encrypted)
    DB-->>IPC: Success
    IPC-->>Bridge: Promise Resolve
    Bridge-->>ReactUI: Success

    Note over DB,Keychain: API Key never stored in plaintext

    ReactUI->>Bridge: window.api.getSettings()
    Bridge->>IPC: ipcRenderer.invoke('app:get-settings')
    IPC->>DB: Get Settings
    DB-->>IPC: {userId, encryptedKey}
    IPC->>SecureStorage: decrypt(encryptedKey)
    SecureStorage->>Keychain: safeStorage.decryptString()
    Keychain-->>SecureStorage: Decrypted String
    SecureStorage-->>IPC: Decrypted Key
    IPC-->>Bridge: {userId, apiKey}
    Bridge-->>ReactUI: Settings (decrypted)

    Note over ReactUI,Keychain: Decryption only in Main Process
```

## Data Flow

### Reading Data Flow

```mermaid
sequenceDiagram
    participant User
    participant ReactUI as React UI
    participant ReactQuery as TanStack Query
    participant Bridge as IPC Bridge
    participant IPC as IPC Handler
    participant Client as DB Worker Client
    participant Worker as DB Worker
    participant DB as SQLite

    User->>ReactUI: Click "View Artists"
    ReactUI->>ReactQuery: useQuery(['artists'])
    ReactQuery->>Bridge: window.api.getTrackedArtists()
    Bridge->>IPC: ipcRenderer.invoke('db:get-artists')
    IPC->>IPC: Validate (Zod)
    IPC->>Client: dbWorkerClient.call('getTrackedArtists')
    Client->>Worker: PostMessage (RPC)
    Worker->>DB: Drizzle Query
    DB-->>Worker: Artist[]
    Worker-->>Client: PostMessage (Response)
    Client-->>IPC: Promise Resolve
    IPC-->>Bridge: IPC Response
    Bridge-->>ReactQuery: Promise Resolve
    ReactQuery->>ReactQuery: Cache Data
    ReactQuery-->>ReactUI: Update UI
    ReactUI-->>User: Display Artists
```

### Writing Data Flow

```mermaid
sequenceDiagram
    participant User
    participant ReactUI as React UI
    participant Bridge as IPC Bridge
    participant IPC as IPC Handler
    participant Client as DB Worker Client
    participant Worker as DB Worker
    participant DB as SQLite
    participant ReactQuery as TanStack Query

    User->>ReactUI: Submit "Add Artist" Form
    ReactUI->>Bridge: window.api.addArtist(data)
    Bridge->>IPC: ipcRenderer.invoke('db:add-artist', data)
    IPC->>IPC: Zod Validation
    alt Validation Failed
        IPC-->>Bridge: Error
        Bridge-->>ReactUI: Reject Promise
    else Validation Success
        IPC->>Client: dbWorkerClient.call('addArtist', data)
        Client->>Worker: PostMessage (RPC)
        Worker->>DB: Drizzle Insert
        DB-->>Worker: New Artist
        Worker-->>Client: PostMessage (Response)
        Client-->>IPC: Promise Resolve
        IPC-->>Bridge: IPC Response
        Bridge-->>ReactUI: Promise Resolve
        ReactUI->>ReactQuery: Invalidate Query
        ReactQuery->>ReactQuery: Refetch Data
        ReactQuery-->>ReactUI: Update UI
        ReactUI-->>User: Show Success
    end
```

### Synchronization Flow

```mermaid
sequenceDiagram
    participant User
    participant ReactUI as React UI
    participant Bridge as IPC Bridge
    participant IPC as IPC Handler
    participant SyncService as Sync Service
    participant SecureStorage as Secure Storage
    participant Rule34API as Rule34.xxx API
    participant Client as DB Worker Client
    participant Worker as DB Worker
    participant DB as SQLite

    User->>ReactUI: Click "Sync All"
    ReactUI->>Bridge: window.api.syncAll()
    Bridge->>IPC: ipcRenderer.invoke('db:sync-all')
    IPC->>SyncService: syncService.syncAllArtists()
    IPC-->>Bridge: Return (async)
    Bridge-->>ReactUI: Promise Resolve

    par For Each Artist
        SyncService->>Client: Get Artist List
        Client->>Worker: getTrackedArtists()
        Worker->>DB: Query Artists
        DB-->>Worker: Artist[]
        Worker-->>Client: Return Artists
        Client-->>SyncService: Artists

        SyncService->>SecureStorage: Decrypt API Key
        SecureStorage-->>SyncService: Decrypted Key

        SyncService->>Rule34API: GET /index.php?page=dapi&s=post&q=index
        Rule34API-->>SyncService: JSON Posts

        SyncService->>SyncService: Map API Response
        SyncService->>SyncService: Rate Limit (1.5s delay)

        SyncService->>Client: savePostsForArtist()
        Client->>Worker: PostMessage (RPC)
        Worker->>DB: INSERT/UPDATE Posts
        Worker->>DB: UPDATE Artist (lastPostId)
        DB-->>Worker: Success
        Worker-->>Client: PostMessage (Response)
        Client-->>SyncService: Success

        SyncService->>ReactUI: emit('sync:progress', message)
        ReactUI->>ReactUI: Update Progress UI
    end

    SyncService->>ReactUI: emit('sync:end')
    ReactUI->>ReactUI: Show Completion
    ReactUI->>User: Sync Complete
```

## Database Architecture

### Schema

The database uses SQLite with the following tables:

1. **artists** - Tracked artists/users (by tag or uploader)
2. **posts** - Cached post metadata with tags, ratings, and URLs
3. **settings** - API credentials (User ID and API Key)
4. **subscriptions** - Tag subscriptions (schema defined, not yet implemented)

See [Database Documentation](./database.md) for detailed schema information.

### ORM Layer

**Drizzle ORM** provides:

- Type-safe queries
- Schema migrations
- Type inference
- SQL generation

### Worker Thread Architecture

**Database Worker Thread** (`src/main/db/db-worker.ts`):

- All database operations run in a dedicated worker thread
- Prevents blocking the main Electron process
- RPC pattern with correlation IDs for request/response matching
- Timeout handling for worker requests
- Type-safe communication via `WorkerRequest` and `WorkerResponse` types
- Automatic migration execution on worker initialization

## Component Architecture

### React Component Hierarchy

```mermaid
graph TD
    App[App.tsx]
    AppLayout[AppLayout]
    Sidebar[Sidebar]
    GlobalTopBar[GlobalTopBar]

    App --> AppLayout
    AppLayout --> Sidebar
    AppLayout --> GlobalTopBar

    subgraph "Pages"
        Updates[Updates]
        Browse[Browse]
        Favorites[Favorites]
        Tracked[Tracked]
        Settings[Settings]
        ArtistDetails[ArtistDetails]
        Onboarding[Onboarding]
    end

    AppLayout --> Updates
    AppLayout --> Browse
    AppLayout --> Favorites
    AppLayout --> Tracked
    AppLayout --> Settings
    AppLayout --> ArtistDetails
    AppLayout --> Onboarding

    subgraph "Shared Components"
        ArtistGallery[ArtistGallery]
        PostCard[PostCard]
        ViewerDialog[ViewerDialog]
        AddArtistModal[AddArtistModal]
    end

    Tracked --> ArtistGallery
    ArtistDetails --> ArtistGallery
    ArtistGallery --> PostCard
    PostCard --> ViewerDialog
    Tracked --> AddArtistModal
```

## External API Integration

### API Client Design

External API calls are handled in the Main process via `SyncService` (`src/main/services/sync-service.ts`) with:

1. **Rate Limiting:** 1.5 second delay between artists, 0.5 second between pages
2. **Pagination:** Handles Rule34.xxx pagination (up to 1000 posts per page)
3. **Incremental Sync:** Only fetches posts newer than `lastPostId`
4. **Error Handling:** Graceful handling of API errors and network failures
5. **Authentication:** Uses User ID and API Key from settings table

### Download Flow

```mermaid
sequenceDiagram
    participant User
    participant Viewer as ViewerDialog
    participant Bridge as IPC Bridge
    participant IPC as IPC Handler
    participant FileHandler as File Handler
    participant FileSystem as File System

    User->>Viewer: Click "Download"
    Viewer->>Bridge: window.api.downloadFile(url, filename)
    Bridge->>IPC: ipcRenderer.invoke('files:download', url, filename)
    IPC->>FileHandler: downloadFile(url, filename)
    FileHandler->>FileSystem: Show Save Dialog
    FileSystem-->>FileHandler: User Selected Path

    par Download Process
        FileHandler->>FileHandler: Fetch File Stream
        FileHandler->>FileSystem: Write Chunks
        FileHandler->>Viewer: emit('files:download-progress', {id, percent})
        Viewer->>Viewer: Update Progress Bar
    end

    FileHandler->>FileSystem: Complete Write
    FileSystem-->>FileHandler: Success
    FileHandler-->>IPC: {success: true, path}
    IPC-->>Bridge: IPC Response
    Bridge-->>Viewer: Promise Resolve
    Viewer->>User: Show Success Notification
```

## Build Architecture

### Build Tool: Vite

The project uses **electron-vite** for building both Main and Renderer processes.

**Configuration:** `electron.vite.config.ts`

**Build Targets:**

1. **Main:** Node.js bundle (`out/main/`)
2. **Preload:** CommonJS bridge (`out/preload/`)
3. **Renderer:** React application (`out/renderer/`)

### Development Mode

- Hot Module Replacement (HMR) for Renderer ‚úÖ
- Fast rebuilds with Vite
- DevTools enabled in development
- Main Process: Manual restart required (no auto-restart) ‚ö†Ô∏è

## State Management

### Renderer State

**TanStack Query (React Query):**

- Server state (data from Main process)
- Caching and synchronization
- Loading and error states

**Zustand:**

- Client-side UI state
- Minimal boilerplate
- KISS principle compliance

### Main Process State

- Database is the source of truth
- Services maintain minimal in-memory state
- Background jobs use timers, not persistent state

## File Structure

```
src/
‚îú‚îÄ‚îÄ main/                          # Electron Main Process
‚îÇ   ‚îú‚îÄ‚îÄ db/                        # Database layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repositories/         # Repository pattern implementations
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ artists.repo.ts    # Artists repository
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ posts.repo.ts       # Posts repository
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db-service.ts          # Legacy database service (deprecated)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db-worker.ts           # Database worker thread implementation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db-worker-client.ts    # Worker client interface
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrate.ts             # Migration runner
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.ts              # Drizzle ORM schema definitions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ worker-types.ts        # Worker thread type definitions
‚îÇ   ‚îú‚îÄ‚îÄ ipc/                       # IPC (Inter-Process Communication)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/              # Modular IPC handlers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ artists.ts         # Artist-related IPC handlers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ files.ts           # File download handlers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts.ts           # Post-related IPC handlers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.ts        # Settings IPC handlers
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ viewer.ts          # Viewer-related IPC handlers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ channels.ts            # IPC channel constants
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts               # Main IPC registration
‚îÇ   ‚îú‚îÄ‚îÄ services/                  # Background services
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ secure-storage.ts       # Secure storage for API credentials
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync-service.ts        # Rule34.xxx API synchronization
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ updater-service.ts     # Auto-updater service
‚îÇ   ‚îú‚îÄ‚îÄ lib/                       # Utilities
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts             # Logging utility
‚îÇ   ‚îú‚îÄ‚îÄ bridge.ts                  # IPC bridge interface definition
‚îÇ   ‚îú‚îÄ‚îÄ main.d.ts                  # Main process type definitions
‚îÇ   ‚îî‚îÄ‚îÄ main.ts                    # Main process entry point
‚îÇ
‚îú‚îÄ‚îÄ renderer/                      # Electron Renderer Process
‚îÇ   ‚îú‚îÄ‚îÄ components/                # React components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dialogs/               # Dialog components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AddArtistModal.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeleteArtistDialog.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Onboarding.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UpdateNotification.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gallery/               # Gallery components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ArtistCard.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ArtistGallery.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PostCard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ inputs/                # Input components
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AsyncAutocomplete.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout/                 # Layout components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AppLayout.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GlobalTopBar.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Sidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/                  # Page components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ArtistDetails.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Browse.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Favorites.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Onboarding.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Settings.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Tracked.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Updates.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings/               # Settings components
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BackupControls.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/                     # shadcn/ui components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alert.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ button.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ card.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dropdown-menu.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ input.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ label.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ select.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ separator.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ viewer/                 # Viewer components
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ViewerDialog.tsx
‚îÇ   ‚îú‚îÄ‚îÄ i18n/                       # Internationalization
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ lib/                        # Utilities
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/                  # Custom React hooks
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useDebounce.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ artist-utils.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tag-utils.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îÇ   ‚îú‚îÄ‚îÄ locales/                    # Translation files
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ en/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ translation.json
‚îÇ   ‚îú‚îÄ‚îÄ schemas/                    # Form validation schemas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ form-schemas.ts
‚îÇ   ‚îú‚îÄ‚îÄ store/                       # State management (Zustand)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ viewerStore.ts
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx                     # Main React component
‚îÇ   ‚îú‚îÄ‚îÄ index.css                   # Global styles
‚îÇ   ‚îú‚îÄ‚îÄ index.html                  # HTML template
‚îÇ   ‚îú‚îÄ‚îÄ main.tsx                    # Renderer entry point
‚îÇ   ‚îî‚îÄ‚îÄ renderer.d.ts               # Renderer type definitions
‚îÇ
‚îî‚îÄ‚îÄ preload/                        # Preload scripts (generated by electron-vite)
    ‚îî‚îÄ‚îÄ bridge.cjs                  # Compiled preload script

Root:
‚îú‚îÄ‚îÄ drizzle/                        # Database migrations
‚îÇ   ‚îú‚îÄ‚îÄ meta/                       # Migration metadata
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _journal.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ *_snapshot.json
‚îÇ   ‚îî‚îÄ‚îÄ *.sql                       # SQL migration files
‚îú‚îÄ‚îÄ docs/                           # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ api.md
‚îÇ   ‚îú‚îÄ‚îÄ architecture.md
‚îÇ   ‚îú‚îÄ‚îÄ contributing.md
‚îÇ   ‚îú‚îÄ‚îÄ database.md
‚îÇ   ‚îú‚îÄ‚îÄ development.md
‚îÇ   ‚îú‚îÄ‚îÄ roadmap.md
‚îÇ   ‚îî‚îÄ‚îÄ rule34-api-reference.md
‚îú‚îÄ‚îÄ scripts/                        # Build and utility scripts
‚îÇ   ‚îú‚îÄ‚îÄ ai_reviewer.py
‚îÇ   ‚îî‚îÄ‚îÄ system_prompt.md
‚îú‚îÄ‚îÄ .github/                        # GitHub workflows
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ ai-review.yml
‚îÇ       ‚îî‚îÄ‚îÄ ci.yml
‚îú‚îÄ‚îÄ electron.vite.config.ts         # Electron-Vite configuration
‚îú‚îÄ‚îÄ drizzle.config.ts               # Drizzle ORM configuration
‚îú‚îÄ‚îÄ tailwind.config.js              # Tailwind CSS configuration
‚îú‚îÄ‚îÄ tsconfig.json                   # TypeScript configuration
‚îî‚îÄ‚îÄ package.json                    # Project dependencies and scripts
```

## Design Principles

### SOLID Principles

- **Single Responsibility:** Each module has one clear purpose
- **Open/Closed:** Extend via composition, not modification
- **Dependency Inversion:** Services depend on abstractions

### KISS & YAGNI

- **KISS:** Simple, readable code over clever solutions
- **YAGNI:** Implement only what's needed now

### DRY

- Shared types between Main and Renderer
- Reusable components and utilities
- No code duplication

## Recent Fixes & Current Status

### ‚úÖ Completed Stabilization

**Infrastructure & Build:**

- Fixed `better-sqlite3` native build on Windows (resolved `node-gyp`, Python, and ABI version mismatches)
- App runs successfully via `npm run dev` and communicates with SQLite database
- **Database Worker Thread:** All database operations moved to dedicated worker thread for non-blocking main process

**Database & Schema:**

- Replaced incompatible `unixepoch` and JS-dates with raw SQL timestamps (ms)
- Added proper `UNIQUE` constraints to the `posts` table (`artistId` + `postId`) to enable correct UPSERT operations
- Added `sampleUrl` column for progressive image loading
- Migrations system (`drizzle-kit`) is fully functional
- **Worker Thread Architecture:** Database operations isolated in worker thread with RPC pattern

**Security & Reliability:**

- **Secure Storage:** API credentials encrypted using Electron's `safeStorage` API. Credentials encrypted at rest, decryption only in Main Process
- **Database Backup/Restore:** Manual backup and restore functionality implemented. Create timestamped backups and restore from files
- **Thread Safety:** Database operations run in dedicated worker thread, preventing main process blocking

**Data Integrity & Sync:**

- Implemented Tag Normalization in `AddArtistModal`: Inputs like "tag (123)" are now stripped to "tag" before saving/syncing
- SyncService correctly handles `ON CONFLICT` and populates the gallery
- Fixed timestamp handling: `lastChecked` now uses `new Date()` with proper Drizzle timestamp mode

**UI/UX:**

- Fixed "Soapy/Blurred" Previews: Image rendering quality for previews has been corrected
- Implemented Progressive Image Loading: 3-layer system (Preview ‚Üí Sample ‚Üí Original) for instant viewing
- Basic Gallery grid is functional
- AsyncAutocomplete component for artist/tag search with free-text input support
- **Search Functionality:** Local artist search and remote tag search via Rule34.xxx autocomplete API
- **Backup Controls:** UI component for creating and restoring database backups
- **Mark as Viewed:** Ability to mark posts as viewed for better organization

## Implemented Features

1. ‚úÖ **Sync Service:** Dedicated service for Rule34.xxx API synchronization with progress tracking
2. ‚úÖ **Settings Management:** Secure storage of API credentials with encryption using Electron's `safeStorage` API
3. ‚úÖ **Artist Tracking:** Support for tag-based tracking with autocomplete search and tag normalization
4. ‚úÖ **Post Gallery:** Grid view of cached posts with preview images and pagination
5. ‚úÖ **Progressive Image Loading:** 3-layer loading system (Preview ‚Üí Sample ‚Üí Original) for instant viewing
6. ‚úÖ **Artist Repair:** Resync functionality to update previews and fix sync issues
7. ‚úÖ **Auto-Updater:** Automatic update checking and installation via electron-updater
8. ‚úÖ **Event System:** Real-time IPC events for sync progress, update status, and download progress
9. ‚úÖ **Database Worker Thread:** All database operations run in dedicated worker thread for non-blocking performance
10. ‚úÖ **Secure Storage:** API credentials encrypted at rest using Electron's `safeStorage` API
11. ‚úÖ **Backup/Restore:** Manual database backup and restore functionality with timestamped backups
12. ‚úÖ **Search Functionality:** Local artist search and remote tag search via Rule34.xxx autocomplete API
13. ‚úÖ **Mark as Viewed:** Ability to mark posts as viewed for better organization
14. ‚úÖ **Favorites System:** Mark and manage favorite posts with toggle functionality
15. ‚úÖ **Download Manager:** Download full-resolution files with progress tracking and queue management
16. ‚úÖ **Full-Screen Viewer:** Immersive viewer with keyboard shortcuts, download, favorites, and tag management
17. ‚úÖ **Sidebar Navigation:** Persistent sidebar with main navigation sections (Updates, Browse, Favorites, Tracked, Settings)
18. ‚úÖ **Global Top Bar:** Unified top bar with search, filters, sort controls, and view toggles
19. ‚úÖ **Credential Verification:** Verify API credentials before saving and during sync operations
20. ‚úÖ **Clipboard Integration:** Copy metadata and debug information to clipboard
21. ‚úÖ **Logout Functionality:** Clear stored credentials and return to onboarding

## Active Roadmap (Priority Tasks)

### A. Filters (Advanced Search) ‚è≥ Not Started

**Goal:** Allow users to refine the gallery view.

- Filter by **Rating** (Safe, Questionable, Explicit)
- Filter by **Media Type** (Image vs Video)
- Filter by **Tags** (Local search within downloaded posts)
- Sort by: Date Added (New/Old), Posted Date

**Status:** No filtering UI or logic implemented. `ArtistGallery` component currently displays all posts without filtering options.

### B. Download Manager ‚è≥ Not Started

**Goal:** Allow saving full-resolution files to the local file system.

- "Download Original" button on post view
- "Download All" for current filter/artist
- **Queue System:** Handle downloads in the background/main process
- **Settings:** Allow choosing a default download directory

**Status:** No download functionality for posts. Only auto-updater download exists.

### C. Playlists / Collections ‚è≥ Not Started

**Goal:** Create curated collections of posts independent of Artists/Trackers.

**Phase 1: MVP**

- New table `playlists` (`id`, `name`, `created_at`)
- New table `playlist_posts` (`playlist_id`, `post_id`, `added_at`)
- "‚≠ê Add to playlist" button on Post Card
- New Page/Tab: "Playlists"
- View Playlist: Grid view with filtering and sorting

**Status:** No playlist tables in schema, no playlist-related code implemented.

### üõ°Ô∏è Security & Reliability (Hardening)

See [Roadmap](./roadmap.md#-security--reliability-hardening) for detailed security improvements:

- ‚úÖ **DB Worker Thread Migration** - ‚úÖ **COMPLETED:** SQLite access moved to dedicated worker thread
- ‚úÖ **Encrypt / Secure Storage for API Credentials** - ‚úÖ **COMPLETED:** Using Electron's `safeStorage` API for encryption
- ‚úÖ **Database Backup / Restore System** - ‚úÖ **COMPLETED:** Manual backup and restore functionality implemented

### Future Considerations

1. **Tag Subscriptions:** Subscribe to tag combinations (schema ready)
2. **Content Script Injection:** DOM enhancements for external sites
3. **Statistics Dashboard:** Analytics on tracked artists and posts
4. **Dual-Module System:** Library mode (local database) and Browser mode (embedded webview)
5. **Multi-Booru Support:** Provider pattern abstraction for multiple booru sources

### Scalability

- Database can handle thousands of artists and posts
- Polling can be optimized with batching
- UI can be virtualized for large lists
- Provider abstraction allows adding new booru sources without core changes

## Performance Considerations

1. **Database Indexing:** Proper indexes on frequently queried fields
2. **Query Optimization:** Efficient Drizzle queries
3. **React Optimization:** Memoization where needed
4. **Lazy Loading:** Code splitting for large components

## Error Handling Strategy

1. **Fail Fast:** Validate inputs at boundaries
2. **Descriptive Errors:** Clear error messages
3. **Error Logging:** All errors logged via `electron-log`
4. **User Feedback:** Errors surfaced to UI appropriately

## Implementation Status (Technical Audit)

Based on a comprehensive technical audit, here's the current implementation status of key features:

### ‚úÖ Fully Implemented

- **Virtualization:** `react-virtuoso` implemented for efficient large list rendering (`ArtistGallery.tsx`)
- **Video Support:** `.mp4` and `.webm` formats handled with native `<video>` element
- **Input Validation:** Zod validation implemented per IPC handler
- **Error Handling:** Try-catch blocks in IPC handlers with error logging

### ‚ö†Ô∏è Partially Implemented

- **Developer HMR:** Renderer process has full HMR support. Main process requires manual restart (no auto-restart on file changes)
- **Input Sanitization:** Zod validation per handler (decentralized), no centralized utility
- **Error Handling:** IPC handlers have try-catch blocks, but some return raw errors instead of user-friendly messages
- **Modern Video:** Video handling exists, but no explicit hardware acceleration configuration in `webPreferences`

### ‚è≥ Missing / Planned

- **Safe Mode / NSFW Filter:** No blur logic or `safeMode` flag in database/settings
- **Age Gate:** Only disclaimer text in README, no confirmation overlay or `isAdult` flag
- **Portable Mode:** Uses absolute paths via `app.getPath("userData")`, no relative path support
- **Anti-Bot Measures:** Static User-Agent strings, fixed delays (1.5s/0.5s) but no randomization or rotation
- **DB Optimization (FTS5):** Standard indexes only, no FTS5 virtual tables for tag searching
- **Centralized Validation:** No shared validation utility (`src/main/lib/validation.ts`)

See [Roadmap](./roadmap.md#-technical-improvements-from-audit) for detailed implementation plans.
</file>

<file path="src/main/ipc/index.ts">
import {
  BrowserWindow,
  ipcMain,
  shell,
  dialog,
  clipboard,
  app,
} from "electron";
import path from "path";
import fs from "fs/promises";
import { getRawDatabase } from "../db";
import { SyncService } from "../services/sync-service";
import { UpdaterService } from "../services/updater-service";
import { IPC_CHANNELS } from "./channels";
import { logger } from "../lib/logger";
import { z } from "zod";

// Services
import { PostsService } from "../services/posts.service";
import { ArtistsService } from "../services/artists.service";
import { SettingsService } from "../services/settings.service";

// Handlers
import { registerPostHandlers } from "./handlers/posts";
import { registerArtistHandlers } from "./handlers/artists";
import { registerViewerHandlers } from "./handlers/viewer";
import { registerSettingsHandlers } from "./handlers/settings";
import { registerFileHandlers } from "./handlers/files";

const DeleteArtistSchema = z.number().int().positive();

// --- Helper –¥–ª—è Sync & Maintenance ---
const registerSyncAndMaintenanceHandlers = (
  syncService: SyncService,
  mainWindow: BrowserWindow
) => {
  // Sync All
  ipcMain.handle(IPC_CHANNELS.DB.SYNC_ALL, () => {
    logger.info("IPC: [DB.SYNC_ALL] Starting background sync...");
    syncService.syncAllArtists().catch((error) => {
      logger.error("IPC: Critical background sync error:", error);
      syncService.sendEvent(
        "sync:error",
        error instanceof Error ? error.message : "Sync failed."
      );
    });
    return true;
  });

  // Repair Artist
  ipcMain.handle(IPC_CHANNELS.SYNC.REPAIR, async (_, artistId: unknown) => {
    const validId = DeleteArtistSchema.safeParse(artistId);
    if (!validId.success) return { success: false, error: "Invalid ID" };

    try {
      await syncService.repairArtist(validId.data);
      return { success: true };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : "Unknown error",
      };
    }
  });

  // Backup Create
  ipcMain.handle(IPC_CHANNELS.BACKUP.CREATE, async () => {
    try {
      const db = getRawDatabase();
      const userDataPath = app.getPath("userData");
      const backupsDir = path.join(userDataPath, "backups");

      await fs.mkdir(backupsDir, { recursive: true });

      const fileName = `backup-${new Date()
        .toISOString()
        .replace(/[:.]/g, "-")}.db`;
      const backupPath = path.join(backupsDir, fileName);

      logger.info(`IPC: Starting backup to ${backupPath}`);
      await db.backup(backupPath);
      shell.showItemInFolder(backupPath);
      return { success: true, path: backupPath };
    } catch (error) {
      logger.error("Backup failed", error);
      return {
        success: false,
        error: error instanceof Error ? error.message : String(error),
      };
    }
  });

  // Backup Restore
  ipcMain.handle(IPC_CHANNELS.BACKUP.RESTORE, async () => {
    const { canceled, filePaths } = await dialog.showOpenDialog(mainWindow, {
      title: "Select backup file",
      filters: [{ name: "SQLite DB", extensions: ["db", "sqlite"] }],
      properties: ["openFile"],
    });

    if (canceled || !filePaths.length)
      return { success: false, error: "Canceled by user" };

    const sourcePath = filePaths[0];

    try {
      logger.info(`IPC: Restoring database from ${sourcePath}`);
      try {
        const currentDb = getRawDatabase();
        if (currentDb && typeof currentDb.close === "function") {
          currentDb.close();
        }
      } catch (e) {
        logger.warn("IPC: Could not close DB explicitly:", e);
      }

      const dbPath = path.join(app.getPath("userData"), "metadata.db");
      await fs.copyFile(sourcePath, dbPath);

      logger.info("IPC: Restore successful. Relaunching app...");
      app.relaunch();
      app.exit(0);
      return { success: true };
    } catch (error) {
      logger.error("Restore failed", error);
      return {
        success: false,
        error: error instanceof Error ? error.message : "Restore failed",
      };
    }
  });
};

// --- Main Registration Function ---
export const registerAllHandlers = (
  syncService: SyncService,
  updaterService: UpdaterService,
  mainWindow: BrowserWindow
) => {
  logger.info("IPC: Registering modular handlers...");

  // 0. System Handlers (APP)
  ipcMain.handle(IPC_CHANNELS.APP.WRITE_CLIPBOARD, async (_, text: string) => {
    clipboard.writeText(text);
    return true;
  });

  ipcMain.handle(IPC_CHANNELS.APP.VERIFY_CREDS, async () => {
    return await syncService.checkCredentials();
  });

  ipcMain.handle(IPC_CHANNELS.APP.LOGOUT, async () => {
    const settingsService = new SettingsService();
    await settingsService.updateSettings({ encryptedApiKey: "", userId: "" });
    return true;
  });

  ipcMain.handle(IPC_CHANNELS.APP.GET_VERSION, async () => {
    return app.getVersion();
  });

  // === UPDATER HANDLERS ===
  // –¢–µ–ø–µ—Ä—å –º–µ—Ç–æ–¥—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Å–µ—Ä–≤–∏—Å–µ
  ipcMain.handle("app:check-for-updates", () =>
    updaterService.checkForUpdates()
  );
  ipcMain.handle("app:quit-and-install", () => updaterService.quitAndInstall());
  ipcMain.handle("app:start-download", () => updaterService.downloadUpdate());

  // 1. Init Services
  const artistsService = new ArtistsService();
  const postsService = new PostsService();
  const settingsService = new SettingsService();

  syncService.setServices(settingsService, artistsService);

  // 2. Register Domain Handlers
  registerPostHandlers(postsService);
  registerArtistHandlers(artistsService);
  registerViewerHandlers();

  // 3. Register Settings
  registerSettingsHandlers(settingsService);

  // 4. Register Sync and Maintenance
  registerSyncAndMaintenanceHandlers(syncService, mainWindow);

  // 5. Register Files (Downloads)
  registerFileHandlers();

  logger.info("IPC: All modular handlers registered.");
};
</file>

<file path="src/renderer.d.ts">
import type { Artist, NewArtist, Post } from "./main/db/schema";
import {
  IpcBridge,
  UpdateStatusCallback,
  UpdateProgressCallback,
} from "./main/bridge";

export type SyncErrorCallback = (message: string) => void;

export interface BackupResponse {
  success: boolean;
  path?: string;
  error?: string;
}

export interface PostQueryFilters {
  rating?: "s" | "q" | "e";
  tags?: string;
  sortBy?: "date" | "id" | "rating";
  isViewed?: boolean;
}

export interface IpcSettings {
  userId: string;
  hasApiKey: boolean;
}

export interface IpcApi extends IpcBridge {
  // App
  getAppVersion: () => Promise<string>;

  // Settings
  getSettings: () => Promise<IpcSettings | undefined>;
  saveSettings: (creds: { userId: string; apiKey: string }) => Promise<boolean>;
  logout: () => Promise<void>;
  openExternal: (url: string) => Promise<void>;

  // Artists
  getTrackedArtists: () => Promise<Artist[]>;
  addArtist: (artist: NewArtist) => Promise<Artist | undefined>;
  deleteArtist: (id: number) => Promise<void>;

  // Search
  searchArtists: (query: string) => Promise<{ id: number; label: string }[]>;

  // Posts
  getArtistPosts: (params: {
    artistId?: number;
    page?: number;
    filters?: PostQueryFilters;
  }) => Promise<Post[]>;

  getArtistPostsCount: (artistId?: number) => Promise<number>;

  updatePost: (
    postId: number,
    changes: {
      isViewed?: boolean;
      isFavorited?: boolean;
      rating?: string;
      tags?: string;
    }
  ) => Promise<boolean>;

  togglePostViewed: (postId: number) => Promise<boolean>;

  resetPostCache: (postId: number) => Promise<boolean>;

  // Sync
  syncAll: () => Promise<boolean>;

  // UPDATER
  checkForUpdates: () => Promise<void>;
  quitAndInstall: () => Promise<void>;

  // Start download
  startDownload: () => Promise<void>;

  // Update status
  onUpdateStatus: (callback: UpdateStatusCallback) => () => void;
  onUpdateProgress: (callback: UpdateProgressCallback) => () => void;

  onSyncStart: (callback: () => void) => () => void;
  onSyncEnd: (callback: () => void) => () => void;
  onSyncProgress: (callback: (message: string) => void) => () => void;
  onSyncError: (callback: SyncErrorCallback) => () => void;

  markPostAsViewed: (postId: number) => Promise<boolean>;

  searchRemoteTags: (query: string) => Promise<{ id: string; label: string }[]>;

  createBackup: () => Promise<BackupResponse>;
  restoreBackup: () => Promise<BackupResponse>;
  writeToClipboard: (text: string) => Promise<boolean>;

  verifyCredentials: () => Promise<boolean>;
}

declare global {
  interface Window {
    api: IpcBridge;
  }
}
</file>

<file path="src/renderer/components/viewer/ViewerDialog.tsx">
import { useEffect, useCallback, useState, useMemo } from "react";
import {
  Dialog,
  DialogContent,
  DialogTitle,
  DialogDescription,
} from "../ui/dialog";
import { useViewerStore, ViewerOrigin } from "../../store/viewerStore";
import { Button } from "../ui/button";
import {
  X,
  Heart,
  Download,
  MoreHorizontal,
  ChevronLeft,
  ChevronRight,
  Folder,
  Copy,
  RefreshCw,
  Bug,
  Tags,
  ExternalLink,
  Calendar,
} from "lucide-react";

import {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuLabel,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuPortal,
  DropdownMenuSubContent,
} from "../ui/dropdown-menu";

import { useQueryClient, InfiniteData } from "@tanstack/react-query";
import type { Post } from "../../../main/db/schema";
import { cn } from "../../lib/utils";

// --- –•–µ–ª–ø–µ—Ä—ã ---

const useCurrentPost = (
  currentPostId: number | null,
  origin: ViewerOrigin | undefined
) => {
  const queryClient = useQueryClient();

  return useMemo(() => {
    if (!currentPostId || !origin) return null;

    let queryKey: unknown[] = [];

    // üî• FIX: TypeScript —Ä—É–≥–∞–ª—Å—è –Ω–∞ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Ç–∏–ø—ã.
    // –ï—Å–ª–∏ origin.kind === 'artist', –±–µ—Ä–µ–º –∫–ª—é—á –∞—Ä—Ç–∏—Å—Ç–∞.
    if (origin.kind === "artist") {
      queryKey = ["posts", origin.artistId];
    }
    // –ï—Å–ª–∏ —É —Ç–µ–±—è –≤ ViewerOrigin –ø–æ—è–≤—è—Ç—Å—è —Ç–∏–ø—ã 'search' –∏–ª–∏ 'browse', –¥–æ–±–∞–≤—å –∏—Ö —Å—é–¥–∞ —è–≤–Ω–æ.
    // –ü–æ–∫–∞ —á—Ç–æ —Ñ–æ–ª–ª–±–µ–∫ –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –≤ –∫—ç—à–µ, –µ—Å–ª–∏ —Ç–∏–ø –Ω–µ —Å–æ–≤–ø–∞–ª.
    else {
      // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ—Å—Ç –≤ –ª—é–±—ã—Ö –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–∞—Ö –ø–æ—Å—Ç–æ–≤
      const queries = queryClient.getQueriesData<InfiniteData<Post[]>>({
        queryKey: ["posts"],
      });
      for (const [_, qData] of queries) {
        if (!qData) continue;
        for (const page of qData.pages) {
          const post = page.find((p) => p.id === currentPostId);
          if (post) return post;
        }
      }
      // –ï—Å–ª–∏ —ç—Ç–æ browse –∏–ª–∏ favorites, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–ª—é—á–∏:
      // if (origin.kind === 'favorites') queryKey = ['favorites'];
      return null;
    }

    const data = queryClient.getQueryData<InfiniteData<Post[]>>(queryKey);
    if (!data) return null;

    for (const page of data.pages) {
      const post = page.find((p) => p.id === currentPostId);
      if (post) return post;
    }
    return null;
  }, [currentPostId, origin, queryClient]);
};

// --- –ü–æ–¥-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ú–µ–¥–∏–∞ ---
const ViewerMedia = ({ post }: { post: Post }) => {
  const [isZoomed, setIsZoomed] = useState(false);
  const [isVideoPlaying, setIsVideoPlaying] = useState(true);

  const isVideo =
    post.fileUrl.endsWith(".mp4") || post.fileUrl.endsWith(".webm");

  useEffect(() => {
    const handleMediaKeys = (e: KeyboardEvent) => {
      if (e.key === " ") {
        if (document.activeElement?.tagName === "VIDEO") {
          return;
        }
        e.preventDefault();
        setIsVideoPlaying((v) => !v);
      }
    };
    window.addEventListener("keydown", handleMediaKeys);
    return () => window.removeEventListener("keydown", handleMediaKeys);
  }, []);

  const handleContainerClick = (e: React.MouseEvent) => {
    if (isVideo) {
      if (e.target instanceof HTMLVideoElement) return;
      setIsVideoPlaying((v) => !v);
      return;
    }
    setIsZoomed(!isZoomed);
  };

  return (
    <div
      className="flex relative justify-center items-center pb-20 w-full h-full cursor-default"
      onClick={handleContainerClick}
    >
      {isVideo ? (
        <video
          src={post.fileUrl}
          className="object-contain max-w-full max-h-full outline-none focus:outline-none"
          autoPlay={isVideoPlaying}
          loop
          controls
          onPlay={() => setIsVideoPlaying(true)}
          onPause={() => setIsVideoPlaying(false)}
          ref={(el) => {
            if (el) {
              if (isVideoPlaying && el.paused) el.play().catch(() => {});
              else if (!isVideoPlaying && !el.paused) el.pause();
            }
          }}
        />
      ) : (
        <img
          src={isZoomed ? post.fileUrl : post.sampleUrl || post.fileUrl}
          alt={`Post ${post.id}`}
          className={cn(
            "transition-all duration-300 ease-out",
            isZoomed
              ? "max-w-none max-h-none cursor-zoom-out"
              : "object-contain max-w-full max-h-full cursor-zoom-in"
          )}
        />
      )}
    </div>
  );
};

// --- Container Scope ---

const ViewerDialogPostScope = ({
  post,
  queue: _queue,
  close,
  next,
  prev,
  controlsVisible,
}: {
  post: Post;
  queue: {
    ids: number[];
    origin: ViewerOrigin | undefined;
    totalGlobalCount?: number;
  } | null;
  close: () => void;
  next: () => void;
  prev: () => void;
  controlsVisible: boolean;
}) => {
  const queryClient = useQueryClient();

  // --- LOCAL STATE ---
  const [isFavorited, setIsFavorited] = useState(post.isFavorited);
  const [isDownloading, setIsDownloading] = useState(false);
  const [downloadProgress, setDownloadProgress] = useState(0);

  const isDeveloperMode = true;

  const formattedDate = useMemo(() => {
    const timestamp = post.publishedAt || post.createdAt;
    if (!timestamp) return "Unknown date";

    const isSeconds = Number(timestamp) < 100000000000;
    const dateVal = new Date(Number(timestamp) * (isSeconds ? 1000 : 1));

    return dateVal.toLocaleDateString("ru-RU", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  }, [post.publishedAt, post.createdAt]);

  // --- MARK VIEWED ---
  useEffect(() => {
    if (post.isViewed) return;
    window.api.markPostAsViewed(post.id);

    // Optimistic Update
    const queryKey =
      _queue?.origin?.kind === "artist"
        ? ["posts", _queue.origin.artistId]
        : ["posts"];

    queryClient.setQueryData<InfiniteData<Post[]>>(queryKey, (old) => {
      if (!old) return old;
      return {
        ...old,
        pages: old.pages.map((page) =>
          page.map((p) => (p.id === post.id ? { ...p, isViewed: true } : p))
        ),
      };
    });
  }, [post.id, post.isViewed, _queue, queryClient]);

  // --- DOWNLOAD LISTENER ---
  useEffect(() => {
    const filenameId = `${post.artistId}_${post.postId}.${
      post.fileUrl.split(".").pop() || "jpg"
    }`;

    const unsubscribe = window.api.onDownloadProgress((data) => {
      if (data.id !== filenameId) return;

      if (data.percent > 0 && data.percent < 100) {
        setIsDownloading(true);
        setDownloadProgress(data.percent);
      } else {
        setIsDownloading(false);
        setDownloadProgress(0);
      }
    });

    return () => {
      unsubscribe();
    };
  }, [post.artistId, post.postId, post.fileUrl]);

  // --- HANDLERS ---

  const toggleFavorite = async () => {
    const previousState = isFavorited;
    // Optimistic UI update
    setIsFavorited(!previousState);

    try {
      // üõë –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Å—å, —á—Ç–æ db:toggle-post-favorite –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ main.ts!
      const newState = await window.api.togglePostFavorite(post.id);
      setIsFavorited(newState);

      // Cache Update
      const queryKey =
        _queue?.origin?.kind === "artist"
          ? ["posts", _queue.origin.artistId]
          : ["posts"];

      queryClient.setQueryData<InfiniteData<Post[]>>(queryKey, (old) => {
        if (!old) return old;
        return {
          ...old,
          pages: old.pages.map((page) =>
            page.map((p) =>
              p.id === post.id ? { ...p, isFavorited: newState } : p
            )
          ),
        };
      });
    } catch (error) {
      // Revert on error
      setIsFavorited(previousState);
      console.error("Failed to toggle favorite:", error);
      alert(
        "–ù–µ —É–¥–∞–ª–æ—Å—å –ª–∞–π–∫–Ω—É—Ç—å. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ (–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç API/Backend)."
      );
    }
  };

  const downloadImage = async () => {
    if (isDownloading) return;
    setDownloadProgress(1);

    try {
      const ext = post.fileUrl.split(".").pop() || "jpg";
      const filename = `${post.artistId}_${post.postId}.${ext}`;
      await window.api.downloadFile(post.fileUrl, filename);
    } catch (error) {
      console.error("Download error", error);
      setDownloadProgress(0);
    }
  };

  const openFolder = async () => {
    const ext = post.fileUrl.split(".").pop() || "jpg";
    const filename = `${post.artistId}_${post.postId}.${ext}`;
    await window.api.openFileInFolder(filename);
  };

  const tagsToQuery = (t: string | null | undefined) => {
    if (!t) return "";
    return t.trim().split(/\s+/g).filter(Boolean).join("+");
  };

  const handleCopyText = async (text: string) => {
    try {
      await window.api.writeToClipboard(text);
    } catch (err) {
      console.error("Failed to copy text via IPC: ", err);
    }
  };

  const handleOpenExternal = (url: string) => {
    if (url) window.api.openExternal(url);
  };

  const resetLocalCache = () => {
    if (!post) return;
    window.api.resetPostCache(post.id);
  };

  const handleCopyDebugInfo = async () => {
    const debugInfo = {
      appVersion: "1.4.1",
      post: post,
      queueLength: _queue?.ids.length,
      origin: _queue?.origin,
    };
    await handleCopyText(JSON.stringify(debugInfo, null, 2));
  };

  const isCurrentlyDownloading =
    isDownloading && downloadProgress > 0 && downloadProgress < 100;

  const postPageUrl = `https://rule34.xxx/index.php?page=post&s=view&id=${post.postId}`;
  const tagQuery = tagsToQuery(post.tags);

  return (
    <>
      <ViewerMedia post={post} />

      {/* --- TOP BAR --- */}
      <div
        className={cn(
          "fixed top-0 left-0 right-0 h-16 z-50 flex items-center justify-between px-4 bg-gradient-to-b from-black/80 to-transparent transition-transform duration-300",
          !controlsVisible && "-translate-y-full"
        )}
      >
        <div className="flex gap-4 items-center">
          <Button
            variant="ghost"
            size="icon"
            onClick={close}
            className="text-white rounded-full hover:bg-white/10"
          >
            <X className="w-6 h-6" />
          </Button>
        </div>

        <div className="flex gap-2 items-center">
          <Button
            variant="ghost"
            size="icon"
            onClick={toggleFavorite}
            className="text-white rounded-full hover:bg-white/10"
            title="Toggle Favorite"
          >
            <Heart
              className={cn(
                "w-5 h-5 transition-colors",
                isFavorited ? "text-red-500 fill-red-500" : "text-white"
              )}
            />
          </Button>

          {/* DOWNLOAD */}
          <Button
            variant="ghost"
            size="icon"
            onClick={downloadImage}
            disabled={isCurrentlyDownloading}
            className="overflow-hidden relative text-white rounded-full hover:bg-white/10 group"
          >
            {isCurrentlyDownloading && (
              <div
                className="absolute inset-0 transition-all duration-100 bg-green-500/50"
                style={{ width: `${downloadProgress}%` }}
              />
            )}
            {isCurrentlyDownloading ? (
              <div className="flex relative z-10 items-center text-xs text-white/90">
                {downloadProgress}%
              </div>
            ) : (
              <Download className="relative z-10 w-5 h-5" />
            )}
          </Button>

          {/* MENU */}
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button
                variant="ghost"
                size="icon"
                className="text-white rounded-full hover:bg-white/10"
              >
                <MoreHorizontal className="w-5 h-5" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent
              className="w-56 text-white shadow-lg bg-neutral-900 border-white/10"
              sideOffset={8}
              align="end"
            >
              <DropdownMenuSub>
                <DropdownMenuSubTrigger>
                  <Copy className="mr-2 w-4 h-4" />
                  Copy...
                </DropdownMenuSubTrigger>
                <DropdownMenuPortal>
                  <DropdownMenuSubContent className="w-48 text-white shadow-xl bg-neutral-900 border-white/10">
                    <DropdownMenuItem
                      onClick={() => handleCopyText(String(post.postId))}
                    >
                      Copy post ID
                    </DropdownMenuItem>
                    <DropdownMenuItem
                      onClick={() => handleCopyText(postPageUrl)}
                    >
                      Copy post link
                    </DropdownMenuItem>
                    <DropdownMenuSeparator />
                    <DropdownMenuItem
                      disabled={!post.tags}
                      onClick={() => handleCopyText(post.tags || "")}
                    >
                      Copy tags (all)
                    </DropdownMenuItem>
                    <DropdownMenuItem
                      onClick={() => handleCopyText(post.fileUrl)}
                    >
                      Copy file URL
                    </DropdownMenuItem>
                  </DropdownMenuSubContent>
                </DropdownMenuPortal>
              </DropdownMenuSub>

              <DropdownMenuSeparator />
              <DropdownMenuLabel>Open</DropdownMenuLabel>
              <DropdownMenuItem onClick={() => handleOpenExternal(postPageUrl)}>
                <ExternalLink className="mr-2 w-4 h-4" />
                Open post page
              </DropdownMenuItem>
              <DropdownMenuItem onClick={openFolder}>
                <Folder className="mr-2 w-4 h-4" />
                Reveal in folder
              </DropdownMenuItem>
              <DropdownMenuSeparator />

              {isDeveloperMode && (
                <>
                  <DropdownMenuLabel>Developer</DropdownMenuLabel>
                  <DropdownMenuItem onClick={resetLocalCache}>
                    <RefreshCw className="mr-2 w-4 h-4" />
                    Reset cache
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={handleCopyDebugInfo}>
                    <Bug className="mr-2 w-4 h-4" />
                    Copy debug info
                  </DropdownMenuItem>
                </>
              )}
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      {/* --- BOTTOM BAR --- */}
      <div
        className={cn(
          "fixed bottom-0 left-0 right-0 h-20 z-50 flex items-center justify-between px-6 bg-gradient-to-t from-black/90 via-black/50 to-transparent transition-transform duration-300",
          !controlsVisible && "translate-y-full"
        )}
      >
        <div className="flex flex-col gap-1">
          <div className="flex gap-2 items-center">
            <span
              className={cn(
                "px-2 py-0.5 rounded text-xs font-bold uppercase",
                post.rating === "e"
                  ? "bg-red-500/20 text-red-400"
                  : "bg-green-500/20 text-green-400"
              )}
            >
              {post.rating === "s"
                ? "Safe"
                : post.rating === "q"
                ? "Questionable"
                : "Explicit"}
            </span>
            {/* DATE DISPLAY */}
            <span className="flex gap-1 items-center text-xs text-white/60">
              <Calendar className="w-3 h-3" />
              {formattedDate}
            </span>
          </div>
        </div>

        <div className="flex gap-3 items-center">
          <Button
            variant="outline"
            size="sm"
            className="gap-2 text-white bg-white/5 border-white/10 hover:bg-white/10"
            // üî• FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º tagQuery
            onClick={() => handleCopyText(tagQuery)}
          >
            <Tags className="w-4 h-4" />
            Tags
          </Button>
        </div>
      </div>

      {/* --- NAV ARROWS --- */}
      <button
        className={cn(
          "absolute left-2 top-1/2 -translate-y-1/2 p-4 text-white/50 hover:text-white transition-colors outline-none",
          !controlsVisible && "opacity-0"
        )}
        onClick={(e) => {
          e.stopPropagation();
          prev();
        }}
      >
        <ChevronLeft className="w-10 h-10 drop-shadow-md" />
      </button>

      <button
        className={cn(
          "absolute right-2 top-1/2 -translate-y-1/2 p-4 text-white/50 hover:text-white transition-colors outline-none",
          !controlsVisible && "opacity-0"
        )}
        onClick={(e) => {
          e.stopPropagation();
          next();
        }}
      >
        <ChevronRight className="w-10 h-10 drop-shadow-md" />
      </button>
    </>
  );
};

// --- –û—Å–Ω–æ–≤–Ω–æ–π –ö–æ–º–ø–æ–Ω–µ–Ω—Ç (–û–±–µ—Ä—Ç–∫–∞) ---

export const ViewerDialog = () => {
  const {
    isOpen,
    close,
    currentPostId,
    queue,
    currentIndex,
    next,
    prev,
    controlsVisible,
    setControlsVisible,
    appendQueueIds,
  } = useViewerStore();

  const post = useCurrentPost(currentPostId, queue?.origin);
  const queryClient = useQueryClient();

  // Infinite loading logic
  useEffect(() => {
    if (!isOpen || !queue || !queue.origin) return;

    const loadedCount = queue.ids.length;
    const threshold = 5;
    const isNearEnd = currentIndex >= loadedCount - threshold;
    const hasReachedLimit =
      (queue.totalGlobalCount && loadedCount >= queue.totalGlobalCount) ||
      !queue.hasNextPage;

    if (isNearEnd && !hasReachedLimit && queue.onLoadMore) {
      queue.onLoadMore();
    }
  }, [isOpen, queue, currentIndex]);

  // Sync new posts
  useEffect(() => {
    if (!isOpen || !queue || !queue.origin || !queue.onLoadMore) return;

    // üî• FIX: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–∞
    let queryKey: unknown[] = [];
    if (queue.origin.kind === "artist") {
      queryKey = ["posts", queue.origin.artistId];
    } else {
      // Fallback or specific logic for other types
      // –ï—Å–ª–∏ —É —Ç–µ–±—è browse/search –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–ª—é—á 'posts-search' –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ 'posts'
      return;
    }

    const infiniteData =
      queryClient.getQueryData<InfiniteData<Post[]>>(queryKey);

    if (infiniteData) {
      const allLoadedPosts = infiniteData.pages.flatMap((page) => page);
      const loadedPostIds = new Set(queue.ids);
      const newPosts = allLoadedPosts.filter((p) => !loadedPostIds.has(p.id));

      if (newPosts.length > 0) {
        appendQueueIds(newPosts.map((p) => p.id));
      }
    }
  }, [isOpen, queue, queryClient, appendQueueIds]);

  // Keyboard Nav
  const handleNavigationKeys = useCallback(
    (e: KeyboardEvent) => {
      if (!isOpen) return;
      switch (e.key) {
        case "ArrowRight":
          e.preventDefault();
          next();
          break;
        case "ArrowLeft":
          e.preventDefault();
          prev();
          break;
        case "Escape":
          e.preventDefault();
          close();
          break;
      }
    },
    [isOpen, next, prev, close]
  );

  useEffect(() => {
    window.addEventListener("keydown", handleNavigationKeys);
    return () => window.removeEventListener("keydown", handleNavigationKeys);
  }, [handleNavigationKeys]);

  // Mouse Controls Visibility
  useEffect(() => {
    let timeout: NodeJS.Timeout;
    const handleMouseMove = () => {
      setControlsVisible(true);
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        setControlsVisible(false);
      }, 2000);
    };

    if (isOpen) {
      window.addEventListener("mousemove", handleMouseMove);
      setControlsVisible(true);
      timeout = setTimeout(() => setControlsVisible(false), 2000);
    }

    return () => {
      window.removeEventListener("mousemove", handleMouseMove);
      clearTimeout(timeout);
    };
  }, [isOpen, setControlsVisible]);

  if (!post) return null;

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && close()}>
      <DialogContent
        className="
          fixed inset-0 left-0 top-0 translate-x-0 translate-y-0
          z-50 flex flex-col
          w-screen h-screen max-w-none
          p-0 m-0 gap-0
          border-none bg-transparent shadow-none outline-none
          sm:rounded-none
          [&>button]:hidden
        "
      >
        <DialogTitle className="sr-only">Image Viewer</DialogTitle>
        <DialogDescription className="sr-only">
          View and navigate through posts.
        </DialogDescription>

        <div className="absolute inset-0 backdrop-blur-md pointer-events-none bg-black/60" />

        <div className="flex relative z-10 flex-col justify-center items-center w-full h-full">
          <ViewerDialogPostScope
            key={post.id}
            post={post}
            queue={queue}
            close={close}
            next={next}
            prev={prev}
            controlsVisible={controlsVisible}
          />
        </div>
      </DialogContent>
    </Dialog>
  );
};
</file>

<file path="README.md">
# üíª RuleDesk

> A modern, secure desktop companion built on Electron and React/TypeScript for browsing and organizing booru-style imageboard content via its public API. Designed for performance and maintainability.

---

---

## ‚ö†Ô∏è Disclaimer & Risk Assessment

This project is **unofficial** and **not affiliated** with any external website or company.

- **Content Risk:** The application does **not** host, redistribute, or bundle any media. All content is loaded directly from the original website's API or CDN. Users are responsible for adhering to local laws regarding NSFW content and the target website‚Äôs API Terms of Service (ToS).
- **API Risk (Polling):** The Core Services are implemented with strict **Exponential Backoff** and **Rate Limiting** to minimize the risk of IP/key bans due to abusive polling behavior.
- **Security Posture:** The application is configured with mandatory Electron security hardening (Context Isolation, Preload Scripts) to prevent any potential Remote Code Execution (RCE) via the renderer process.

---

## ‚ú® Features

| Feature                           | Description                                                                                                                                                                                                                                                                                  |
| :-------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **üîê API Authentication**         | Secure onboarding flow for Rule34.xxx API credentials (User ID and API Key). Credentials encrypted using Electron's `safeStorage` API and stored securely. Decryption only happens in Main Process when needed for API calls.                                                                |
| **üë§ Artist Tracking**            | Track artists/uploaders by tag or username. Add, view, and delete tracked artists. Supports tag-based tracking with autocomplete search (local and remote Rule34.xxx API). Tag normalization automatically strips metadata like "(123)" from tag names.                                      |
| **üîÑ Background Synchronization** | Sync service fetches new posts from Rule34.xxx API with rate limiting (1.5s delay between artists, 0.5s between pages). Implements exponential backoff and proper error handling. Real-time sync progress updates via IPC events.                                                            |
| **üíæ Local Metadata Database**    | Uses **SQLite** via **Drizzle ORM** (TypeScript mandatory). Database operations run in a dedicated **Worker Thread** to prevent blocking the main process. Stores artists, posts metadata (tags, ratings, URLs, sample URLs), and settings. Thread-safe architecture ensures data integrity. |
| **üñºÔ∏è Artist Gallery**             | View cached posts for each tracked artist in a responsive grid layout. Shows preview images, ratings, and metadata. Click to open external link to Rule34.xxx. Supports pagination and artist repair/resync functionality. Mark posts as viewed for better organization.                     |
| **üé® Progressive Image Loading**  | 3-layer progressive image loading system: Preview (blurred/low-res) ‚Üí Sample (medium-res) ‚Üí Original (high-res). Provides instant visual feedback with smooth quality enhancement.                                                                                                           |
| **üìä Post Metadata**              | Cached posts include file URLs, preview URLs, sample URLs, tags, ratings, and publication timestamps. Enables offline browsing and fast filtering.                                                                                                                                           |
| **üîß Artist Repair**              | Repair/resync functionality to update low-quality previews or fix synchronization issues. Resets artist's last post ID and re-fetches initial pages.                                                                                                                                         |
| **üíæ Backup & Restore**           | Manual database backup and restore functionality. Create timestamped backups to protect your data. Restore from backup files with automatic application restart. Backup files are stored in the user data directory.                                                                         |
| **üîç Search Functionality**       | Search for artists locally and search for tags remotely via Rule34.xxx autocomplete API. Supports both local database search and remote tag suggestions.                                                                                                                                     |
| **‚≠ê Favorites System**           | Mark posts as favorites and manage your favorite collection. Toggle favorite status with keyboard shortcut (`F`) in viewer or via UI controls. Favorites are stored locally in the database.                                                                                                 |
| **‚¨áÔ∏è Download Manager**           | Download full-resolution media files to your local file system. Download individual posts or manage download queue. Files are saved to user-selected directory with progress tracking.                                                                                                       |
| **üñ•Ô∏è Full-Screen Viewer**         | Immersive viewer with keyboard shortcuts, download controls, favorite toggling, and tag management. Auto-hide controls, navigation between posts, and comprehensive media viewing experience.                                                                                                |
| **üß≠ Navigation & Layout**        | Sidebar navigation with dedicated pages: Updates, Browse, Favorites, Tracked, and Settings. Global Top Bar with search, filters, sort controls, and view toggles. Responsive layout with modern UI components.                                                                               |
| **üîÑ Auto-Updater**               | Built-in automatic update checker using `electron-updater`. Notifies users of available updates, supports manual download, and provides seamless installation on app restart.                                                                                                                |
| **üåê Clean English UI**           | Fully localized English interface using i18next. All UI components and logs use English language for consistency and maintainability.                                                                                                                                                        |
| **üîå Multi-Source Ready**         | Architecture designed for future multi-booru support. Provider pattern abstraction allows adding new sources (Danbooru, Gelbooru, etc.) without core database changes.                                                                                                                       |

---

## üèóÔ∏è Architecture Overview & Tech Stack

The application adheres to a strict **Separation of Concerns (SoC)** model:

### 1. Core Services (The Brain - Electron Main Process)

This is the secure Node.js environment. It handles all I/O, persistence, and secrets.

- **Desktop Runtime:** **Electron** (chosen for `BrowserView`/`Webview` control to support DOM injection).
- **Database:** **SQLite** (via `better-sqlite3` driver) running in a **dedicated Worker Thread** for non-blocking operations.
- **Data Layer:** **Drizzle ORM** (TypeScript type-safety for queries, raw SQL timestamps in milliseconds).
- **Security:** **Secure Storage** using Electron's `safeStorage` API for encrypting API credentials at rest.
- **API:** Custom wrapper based on `fetch`/`axios` with retry and backoff logic.
- **Background Jobs:** Node.js timers and asynchronous workers.

### 2. Renderer (The Face - UI Process)

This is the sandboxed browser environment. It handles presentation.

- **Frontend:** **React + TypeScript**
- **Styling:** **Tailwind CSS + shadcn/ui** (modern UI, good baseline A11y).
- **State Management:** **Zustand** (minimalistic state layer, aligned with KISS/YAGNI).
- **Data Fetching:** **TanStack Query (React Query)** (caching, loading states, API boundary).

### 3. Security Boundary (The Gatekeeper)

- **IPC Bridge:** Strictly typed TypeScript interface (`bridge.ts`) used by the Renderer to communicate with the Main Process.
- **Security:** **Context Isolation** enforced globally; no direct Node.js access from the Renderer.
- **Encryption:** API credentials encrypted using Electron's `safeStorage` API. Decryption only occurs in Main Process when needed for API calls.
- **Worker Thread Isolation:** Database operations run in a separate worker thread, providing additional isolation and preventing main process blocking.

## üìê Product Structure

The application is organized into the following main sections accessible via the Sidebar:

- **Updates (Subscriptions)** - View new posts from tracked artists and tag subscriptions
- **Browse (All posts)** - Browse all cached posts with advanced filtering and search
- **Favorites (Account favorites)** - Access your account favorites synced from the booru
- **Tracked (Artists/Tags management)** - Manage tracked artists, tags, and subscriptions
- **Settings** - Configure sync behavior, storage limits, security, and database maintenance

## üé® Core UX Principles

### Global Top Bar

A unified Top Bar appears on all content pages providing:

- **Search** - Quick search across posts, tags, and artists
- **Filters** - Rating, media type, tags, date range
- **Sort** - Sort by date added, posted date, rating, etc.
- **View Toggle** - Switch between grid, list, and masonry layouts
- **Sync Status** - Real-time sync progress indicator with last sync timestamp

### Viewer Experience

The full-screen viewer provides a polished media viewing experience:

- **Full-screen Mode** - Immersive viewing with auto-hide controls
- **Navigation** - Arrow keys (‚Üê/‚Üí) for previous/next post
- **Hotkeys:**
  - `Esc` - Close viewer
  - `‚Üê/‚Üí` - Navigate between posts
  - `F` - Toggle favorite
  - `V` - Mark as viewed
  - `T` - Toggle tags drawer
- **Auto-hide Bars** - Top and bottom bars automatically hide after inactivity
- **Tags Drawer** - Right-side sheet (Slide-over) with clickable tags:
  - Click tag to add filter (`+tag`)
  - Right-click or modifier key to exclude (`-tag`)
  - Visual indicators for active filters

### Progressive Image Loading

Optimized image loading strategy for performance:

- **Preview URL** - Low-resolution blurred preview (instant display)
- **Sample URL** - Medium-resolution sample (loaded in gallery)
- **File URL** - Full-resolution original (loaded only in viewer)

This ensures fast initial page loads while maintaining high-quality viewing experience.

### Gallery Cards

Post cards in gallery views include informative overlays:

- **Viewed Badge** - Indicator for already viewed posts
- **Favorite Badge** - Star icon for favorited posts
- **Rating Badge** - Visual indicator (Safe/Questionable/Explicit)
- **Media Type Badge** - Icon indicating image or video content

## üîÑ Sync & Background

### Auto-sync on Startup

Automatic synchronization when the application starts:

- **Toggle Setting** - Enable/disable auto-sync in Settings
- **Background Execution** - Sync runs in background without blocking UI
- **Progress Indicators** - Real-time sync status in Top Bar

### Periodic Sync

Continuous synchronization while the application is running:

- **Configurable Interval** - Set sync frequency in Settings (e.g., every 30 minutes)
- **Smart Rate Limiting** - Prevents API spam with intelligent backoff
- **Last Sync Status** - Display last successful sync timestamp
- **Respectful Polling** - Implements exponential backoff and respects API limits

## ‚öôÔ∏è Settings

### Sync Settings

- **Auto-sync on Startup** - Toggle automatic sync when app launches
- **Periodic Sync Interval** - Configure how often to check for new posts
- **Rate Limiting** - Adjust delays between API requests

### Storage & Cache

- **Cache Limit** - Set maximum cache size (preview/sample images)
- **Clear Cache** - Manual cache cleanup option
- **Storage Usage** - Display current cache size and database size

### Security

- **API Key Storage** - Secure storage using Electron's `safeStorage` API
  - API keys are **never** sent to Renderer process
  - Encrypted at rest using platform keychain (Windows Credential Manager, macOS Keychain, Linux libsecret)
  - Decryption only occurs in Main Process when needed for API calls
- **Threat Model** - Stolen database file does not reveal API key in plaintext

### Database Management

- **Backup & Restore** - Create timestamped backups and restore from backup files
- **Integrity Check** - Run database integrity verification (`PRAGMA integrity_check`)
- **Vacuum/Compact** - Optimize database file size and performance
- **Maintenance** - Automatic maintenance runs in worker thread (non-blocking)

## ‚úÖ Recent Fixes & Current Status

The application core has been successfully stabilized and enhanced with security improvements:

### Infrastructure & Build

- ‚úÖ Fixed `better-sqlite3` native build on Windows (resolved `node-gyp`, Python, and ABI version mismatches)
- ‚úÖ App runs successfully via `npm run dev` and communicates with SQLite database
- ‚úÖ **Database Worker Thread:** All database operations moved to a dedicated worker thread for non-blocking main process
- ‚ö†Ô∏è **HMR Status:** Renderer process has full HMR support. Main process requires manual restart (no auto-restart on file changes)

### Database & Schema

- ‚úÖ Replaced incompatible `unixepoch` and JS-dates with raw SQL timestamps (ms)
- ‚úÖ Added proper `UNIQUE` constraints to the `posts` table (`artistId` + `postId`) to enable correct UPSERT operations
- ‚úÖ Added `sampleUrl` column for progressive image loading
- ‚úÖ Migrations system (`drizzle-kit`) is fully functional
- ‚úÖ **Worker Thread Architecture:** Database operations isolated in worker thread with RPC pattern
- ‚è≥ **FTS5 Optimization:** Full-text search on tags planned (currently using standard indexes)

### Security & Reliability

- ‚úÖ **Secure Storage:** API credentials encrypted using Electron's `safeStorage` API. Credentials encrypted at rest, decryption only in Main Process
- ‚úÖ **Database Backup/Restore:** Manual backup and restore functionality implemented. Create timestamped backups and restore from files
- ‚úÖ **Thread Safety:** Database operations run in dedicated worker thread, preventing main process blocking
- ‚úÖ **Input Validation:** Zod validation implemented per IPC handler (decentralized, no centralized utility)
- ‚è≥ **Portable Mode:** Not implemented - uses absolute paths via `app.getPath("userData")`
- ‚è≥ **Age Gate:** Not implemented - only disclaimer text in README

### Data Integrity & Sync

- ‚úÖ Implemented Tag Normalization in `AddArtistModal`: Inputs like "tag (123)" are now stripped to "tag" before saving/syncing
- ‚úÖ SyncService correctly handles `ON CONFLICT` and populates the gallery
- ‚úÖ Fixed timestamp handling: `lastChecked` now uses `new Date()` with proper Drizzle timestamp mode
- ‚ö†Ô∏è **Anti-Bot Measures:** Static User-Agent strings used, fixed delays (1.5s/0.5s) but no randomization or rotation

### UI/UX

- ‚úÖ Fixed "Soapy/Blurred" Previews: Image rendering quality for previews has been corrected
- ‚úÖ Implemented Progressive Image Loading: 3-layer system (Preview ‚Üí Sample ‚Üí Original) for instant viewing
- ‚úÖ Basic Gallery grid is functional
- ‚úÖ **Virtualization:** `react-virtuoso` implemented for efficient large list rendering (`ArtistGallery.tsx`)
- ‚úÖ AsyncAutocomplete component for artist/tag search with free-text input support
- ‚úÖ **Search Functionality:** Local artist search and remote tag search via Rule34.xxx autocomplete API
- ‚úÖ **Backup Controls:** UI component for creating and restoring database backups
- ‚úÖ **Mark as Viewed:** Ability to mark posts as viewed for better organization
- ‚úÖ **Sidebar Navigation:** Persistent sidebar with main navigation sections (Updates, Browse, Favorites, Tracked, Settings)
- ‚úÖ **Global Top Bar:** Unified top bar with search, filters, sort controls, and view toggles
- ‚úÖ **Full-Screen Viewer:** Immersive viewer with keyboard shortcuts, download, favorites, and tag management
- ‚úÖ **Video Support:** `.mp4` and `.webm` video formats supported with native `<video>` element
- ‚úÖ **Download Manager:** Download full-resolution files with progress tracking and queue management
- ‚úÖ **Favorites System:** Mark and manage favorite posts with keyboard shortcuts and UI controls
- ‚úÖ **Credential Verification:** Verify API credentials before saving and during sync operations
- ‚è≥ **Safe Mode/NSFW Filter:** Not implemented - no blur logic or `safeMode` flag in settings

---

## üöÄ Quick Start

### First Launch

1. **Get API Credentials:**

   - Visit https://rule34.xxx/index.php?page=account&s=options
   - Copy your **User ID** and **API Key** from the API Access section

2. **Onboarding:**

   - Launch the application
   - Enter your User ID and API Key in the onboarding screen
   - Click "Save and Login"

3. **Add Artists:**

   - Click "Add Artist" button
   - Enter artist name and tag
   - Select type (tag or uploader)
   - Click "Add"

4. **Sync Posts:**
   - Click "Sync All" to fetch posts from Rule34.xxx
   - Wait for synchronization to complete (progress updates shown in real-time)
   - Click on an artist to view their gallery
   - Use "Repair" button in gallery to resync and update preview quality if needed

---

## üìö Documentation

Comprehensive documentation is available in the [`docs/`](./docs/) directory:

- **[API Documentation](./docs/api.md)** - IPC API reference and usage examples
- **[Architecture Documentation](./docs/architecture.md)** - System architecture and design patterns
- **[Roadmap](./docs/roadmap.md)** - Development roadmap and planned features
- **[Contributing Guide](./docs/contributing.md)** - Guidelines for contributors
- **[Database Documentation](./docs/database.md)** - Database schema and operations
- **[Development Guide](./docs/development.md)** - Development setup and workflows

## üöÄ Active Roadmap

We are moving to Feature Development. Priority tasks:

### A. Filters (Advanced Search) üöß In Progress

**Goal:** Allow users to refine the gallery view.

- ‚úÖ **Global Top Bar UI:** Search bar, filter button, sort dropdown, and view toggle implemented
- ‚è≥ Filter by **Rating** (Safe, Questionable, Explicit) - UI ready, backend filtering pending
- ‚è≥ Filter by **Media Type** (Image vs Video) - UI ready, backend filtering pending
- ‚è≥ Filter by **Tags** (Local search within downloaded posts) - UI ready, backend filtering pending
- ‚è≥ Sort by: Date Added (New/Old), Posted Date - UI ready, backend sorting pending

### B. Download Manager ‚úÖ Implemented

**Goal:** Allow saving full-resolution files to the local file system.

- ‚úÖ "Download Original" button on post view (implemented in ViewerDialog)
- ‚úÖ **Queue System:** Handle downloads in the background/main process with progress tracking
- ‚úÖ **Progress Events:** Real-time download progress via IPC events
- ‚è≥ "Download All" for current filter/artist (planned)
- ‚è≥ **Settings:** Allow choosing a default download directory (planned)

### C. Playlists / Collections ‚è≥ Not Started

**Goal:** Create curated collections of posts independent of Artists/Trackers.

**Phase 1: MVP**

- New table `playlists` (`id`, `name`, `created_at`)
- New table `playlist_posts` (`playlist_id`, `post_id`, `added_at`)
- "‚≠ê Add to playlist" button on Post Card
- New Page/Tab: "Playlists"
- View Playlist: Grid view with filtering and sorting

### üõ°Ô∏è Security & Reliability (Hardening)

- ‚úÖ **DB Worker Thread Migration** - ‚úÖ **COMPLETED:** All SQLite operations run in dedicated worker thread with RPC pattern. Database worker provides non-blocking operations and thread-safe access.
- ‚úÖ **Encrypt / Secure Storage for API Credentials** - ‚úÖ **COMPLETED:** Using Electron's `safeStorage` API for encryption. API keys encrypted at rest, never exposed to Renderer process.
- ‚úÖ **Database Backup / Restore System** - ‚úÖ **COMPLETED:** Manual backup and restore functionality implemented with timestamped backups.

See [Roadmap](./docs/roadmap.md) for detailed implementation status and requirements.

---

## ‚öôÔ∏è Development Setup

This project uses **Vite** as the build tool for both the Electron Main and Renderer processes, ensuring optimal build performance.

### Prerequisites

- Node.js (v18+)
- npm or yarn

### Installation

```bash
# Clone the repository
git clone https://github.com/KazeKaze93/ruledesk.git
cd ruledesk

# Install dependencies
npm install

# Start the application in development mode
# This runs the Vite dev server for the Renderer and starts the Electron Main process.
npm run dev
```

### Configuration

The application stores configuration in SQLite database:

- **API Credentials:** Stored securely with encryption using Electron's `safeStorage` API. API keys are encrypted at rest and only decrypted in Main Process when needed for API calls.
- **Database Location:** Electron user data directory (automatically managed)
- **Database Architecture:** All database operations run in a dedicated worker thread for non-blocking performance
- **No Environment Variables Required:** All configuration is handled through the UI

### Building the Binary

To package the application for distribution:

```bash
# Build for current platform
npm run build

# Package with electron-builder (after build)
npx electron-builder
```

The built binaries will be available in the `dist/` directory. The exact output location may vary depending on your Electron builder configuration.

### Quality Checks

Run the following commands to ensure code quality:

```bash
# Type checking
npm run typecheck

# Run linter to check code style and potential issues
npm run lint

# Run both (validation)
npm run validate
```

## üìú License

This project is licensed under the **Apache License 2.0**.

You may use, reproduce, modify, distribute, and sublicense the software under the terms of the Apache License 2.0. The license also includes an express patent grant and requires preservation of copyright and license notices.

The full license text is available in the `LICENSE` file in this repository.

---

## üßæ Legal Disclaimer

By using this software, you acknowledge and agree to the following:

**18+ Only:** This application is intended exclusively for adults (18+) in jurisdictions where viewing NSFW content is legal.

**No Content Hosting:** The application does not host, store, mirror, or redistribute any media content. All media is requested directly from the original website‚Äôs API/CDN at the user‚Äôs initiative.

**Use at Your Own Risk:** The authors and contributors of this project:

- Do not control the content provided by third-party services.
- Do not endorse, moderate, or curate any content accessed through this software.
- Are not responsible for how you use this software or which content you access with it.

**Compliance with Laws & ToS:** You are solely responsible for:

- Complying with the laws and regulations applicable in your country/region.
- Complying with the target website's Terms of Service, API rules, and any usage limitations (including rate limits and content policies).

**No Warranty / Limitation of Liability:** This software is provided ‚ÄúAS IS‚Äù, without warranties or conditions of any kind, either express or implied. To the fullest extent permitted by applicable law, in no event shall the authors or copyright holders be liable for any claim, damages, or other liability, whether in an action of contract, tort, or otherwise, arising from, out of, or in connection with the software or the use or other dealings in the software.

---

## ‚öôÔ∏è Database Management

### Migrations

If you modify the database schema (`src/main/db/schema.ts`):

```bash
# Generate migration from schema changes
npm run db:generate

# Run migrations
npm run db:migrate

# Open Drizzle Studio to inspect database
npm run db:studio
```

**Note:** Migrations run automatically on application startup.

---

## üõ°Ô∏è Code Quality Standards

This project adheres to strict development principles:

- **Architecture:** SOLID, DRY, KISS, YAGNI principles
- **TypeScript:** Strict typing, no `any` or unsafe casts
- **Error Handling:** Proper error handling with descriptive messages
- **Security:** Context Isolation, no direct Node.js access from Renderer
- **Database:** Type-safe queries via Drizzle ORM, no raw SQL
- **UI:** Tailwind CSS only, no inline styles, accessibility considerations

See [Contributing Guide](./docs/contributing.md) for detailed guidelines.
</file>

<file path="src/renderer/App.tsx">
import {
  HashRouter as Router,
  Routes,
  Route,
  Navigate,
} from "react-router-dom";
import { useEffect, useState } from "react";

// --- –ò–ú–ü–û–†–¢–´ –ö–û–ú–ü–û–ù–ï–ù–¢–û–í ---
import { AppLayout } from "./components/layout/AppLayout";
import { Settings } from "./components/pages/Settings";
import { Onboarding } from "./components/pages/Onboarding";
import { Tracked } from "./components/pages/Tracked";
import { ArtistDetails } from "./components/pages/ArtistDetails";
import { Browse } from "./components/pages/Browse";
import { ViewerDialog } from "./components/viewer/ViewerDialog";

// –ó–∞–≥–ª—É—à–∫–∏
const Updates = () => (
  <div className="p-8">
    <h1 className="text-2xl font-bold">Updates</h1>
  </div>
);
const Favorites = () => (
  <div className="p-8">
    <h1 className="text-2xl font-bold">Favorites</h1>
  </div>
);

function App() {
  const [isAuthenticated, setIsAuthenticated] = useState<boolean | null>(null);

  useEffect(() => {
    const checkAuth = async () => {
      try {
        const settings = await window.api.getSettings();
        // [FIX AUTH] –ë–æ–ª–µ–µ –º—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞.
        // –ï—Å–ª–∏ –µ—Å—Ç—å userId –ò–õ–ò –∫–ª—é—á, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—à–µ–ª –æ–Ω–±–æ—Ä–¥–∏–Ω–≥.
        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –ª–æ–≥–∞—É—Ç.
        const isAuth = !!(settings?.userId || settings?.encryptedApiKey);

        console.log(`[App] Auth check: ${isAuth} (ID: ${settings?.userId})`);
        setIsAuthenticated(isAuth);
      } catch (error) {
        console.error("Failed to check authentication:", error);
        setIsAuthenticated(false);
      }
    };
    checkAuth();
  }, []);

  if (isAuthenticated === null) {
    return (
      <div className="flex justify-center items-center h-screen">
        Loading...
      </div>
    );
  }

  if (!isAuthenticated) {
    return <Onboarding onLoginSuccess={() => setIsAuthenticated(true)} />;
  }

  return (
    <Router>
      <Routes>
        <Route path="/" element={<AppLayout />}>
          <Route index element={<Navigate to="/browse" replace />} />
          <Route path="browse" element={<Browse />} />
          <Route path="tracked" element={<Tracked />} />
          <Route path="artist/:id" element={<ArtistDetails />} />
          <Route path="updates" element={<Updates />} />
          <Route path="favorites" element={<Favorites />} />
          <Route path="settings" element={<Settings />} />
          <Route path="*" element={<div className="p-10">404 Not Found</div>} />
        </Route>
      </Routes>

      {/* [FIX CLICKABILITY] –î–∏–∞–ª–æ–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –í–ù–ï Routes, –Ω–æ –í–ù–£–¢–†–ò Router */}
      <ViewerDialog />
    </Router>
  );
}

export default App;
</file>

<file path="src/main/services/sync-service.ts">
import { BrowserWindow, safeStorage } from "electron";
import { logger } from "../lib/logger";
import axios from "axios";
import { URLSearchParams } from "url";
import { eq, sql } from "drizzle-orm";

// DB Access
import { getDatabase } from "../db";
import { posts, artists } from "../db/schema";
import type { Artist, NewPost } from "../db/schema";

// Services
import { SettingsService } from "./settings.service";
import { ArtistsService } from "./artists.service";

interface InternalDecryptedSettings {
  userId: string;
  apiKey: string;
}

interface R34Post {
  id: number;
  file_url: string;
  sample_url: string;
  preview_url: string;
  tags: string;
  rating: string;
  change: number;
}

const isVideo = (url?: string) => !!url && /\.(webm|mp4|mov)(\?|$)/i.test(url);
const pickPreviewUrl = (p: R34Post) => {
  if (p.sample_url && !isVideo(p.sample_url)) return p.sample_url;
  if (p.preview_url && !isVideo(p.preview_url)) return p.preview_url;
  if (p.file_url && !isVideo(p.file_url)) return p.file_url;
  return "";
};

export class SyncService {
  private window: BrowserWindow | null = null;
  private isSyncing = false;

  // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
  private settingsService: SettingsService | null = null;
  private artistsService: ArtistsService | null = null;

  // –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –ë–î –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  private get db() {
    return getDatabase();
  }

  public setWindow(window: BrowserWindow) {
    this.window = window;
  }

  public setServices(
    settingsService: SettingsService,
    artistsService: ArtistsService
  ) {
    this.settingsService = settingsService;
    this.artistsService = artistsService;
  }

  public sendEvent(channel: string, data?: unknown) {
    if (this.window && !this.window.isDestroyed()) {
      this.window.webContents.send(channel, data);
    }
  }

  private async getDecryptedSettings(): Promise<InternalDecryptedSettings | null> {
    if (!this.settingsService) {
      logger.error("SyncService: SettingsService is not initialized!");
      return null;
    }

    const settings = await this.settingsService.getSettings();
    let realApiKey = settings.encryptedApiKey || "";

    // –î–µ—à–∏—Ñ—Ä–æ–≤–∫–∞
    if (realApiKey && safeStorage.isEncryptionAvailable()) {
      try {
        const buff = Buffer.from(realApiKey, "base64");
        realApiKey = safeStorage.decryptString(buff);
      } catch (e) {
        logger.warn(
          "SyncService: Failed to decrypt API Key. Using raw value.",
          e
        );
      }
    }

    return {
      userId: settings.userId || "",
      apiKey: realApiKey,
    };
  }

  /**
   * üî• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–æ–≤
   */
  public async checkCredentials(): Promise<boolean> {
    try {
      const settings = await this.getDecryptedSettings();

      if (!settings?.userId || !settings?.apiKey) {
        return false;
      }

      const params = new URLSearchParams({
        page: "dapi",
        s: "post",
        q: "index",
        limit: "1",
        json: "1",
        user_id: settings.userId,
        api_key: settings.apiKey,
      });

      const { data } = await axios.get(
        `https://api.rule34.xxx/index.php?${params}`,
        { timeout: 10000 }
      );

      return Array.isArray(data);
    } catch (error) {
      logger.error("SyncService: Credentials check failed", error);
      return false;
    }
  }

  public async syncAllArtists() {
    if (this.isSyncing) return;
    if (!this.artistsService) return;

    this.isSyncing = true;
    logger.info("SyncService: Start Full Sync");
    this.sendEvent("sync:start");

    try {
      // 1. –ü–æ–ª—É—á–∞–µ–º –∞—Ä—Ç–∏—Å—Ç–æ–≤ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
      const allArtists = await this.artistsService.getAll();

      // 2. –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      const settings = await this.getDecryptedSettings();
      if (!settings?.userId) throw new Error("No API credentials");

      // 3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
      for (const artist of allArtists) {
        this.sendEvent("sync:progress", `Checking ${artist.name}...`);
        await this.syncArtist(artist, settings);
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –Ω–µ DDOS-–∏—Ç—å API
        await new Promise((r) => setTimeout(r, 1000));
      }
    } catch (error) {
      logger.error("Sync error", error);
      this.sendEvent(
        "sync:error",
        error instanceof Error ? error.message : "Error"
      );
    } finally {
      this.isSyncing = false;
      this.sendEvent("sync:end");
    }
  }

  public async repairArtist(artistId: number) {
    if (this.isSyncing || !this.artistsService) return;
    this.isSyncing = true;
    try {
      const artist = await this.artistsService.getById(artistId);
      const settings = await this.getDecryptedSettings();

      if (artist && settings) {
        this.sendEvent("sync:repair:start", artist.name);
        // Force download by using lastPostId: 0
        await this.syncArtist({ ...artist, lastPostId: 0 }, settings, 3);
      }
    } catch (e) {
      logger.error("Repair error", e);
    } finally {
      this.isSyncing = false;
      this.sendEvent("sync:repair:end");
    }
  }

  private async syncArtist(
    artist: Artist,
    settings: InternalDecryptedSettings,
    maxPages = Infinity
  ) {
    let page = 0;
    let hasMore = true;
    let totalAddedForArtist = 0;
    let currentHighestId = artist.lastPostId;

    while (hasMore && page < maxPages) {
      try {
        const idFilter =
          artist.lastPostId > 0 ? ` id:>${artist.lastPostId}` : "";
        const tagsQuery = `${artist.type === "uploader" ? "user:" : ""}${
          artist.tag
        }${idFilter}`;

        const params = new URLSearchParams({
          page: "dapi",
          s: "post",
          q: "index",
          limit: "100",
          pid: page.toString(),
          tags: tagsQuery,
          json: "1",
        });

        if (settings.apiKey && settings.userId) {
          params.append("user_id", settings.userId);
          params.append("api_key", settings.apiKey);
        }

        const { data: postsData } = await axios.get<R34Post[]>(
          `https://api.rule34.xxx/index.php?${params.toString()}`,
          { timeout: 15000 }
        );

        // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–°: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø—Ä–∏—à–µ–ª –º–∞—Å—Å–∏–≤
        if (!postsData || !Array.isArray(postsData) || postsData.length === 0) {
          hasMore = false;
          break;
        }

        // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π ID –≤ —ç—Ç–æ–π –ø–∞—á–∫–µ
        const batchMaxId = Math.max(...postsData.map((p) => Number(p.id)));
        if (batchMaxId > currentHighestId) currentHighestId = batchMaxId;

        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö —É –Ω–∞—Å —Ä–µ–∞–ª—å–Ω–æ –Ω–µ—Ç
        const newPostsFromBatch = postsData.filter(
          (p) => Number(p.id) > artist.lastPostId
        );

        if (newPostsFromBatch.length > 0) {
          const postsToSave: NewPost[] = newPostsFromBatch.map((p) => ({
            postId: Number(p.id),
            artistId: artist.id,
            fileUrl: p.file_url,
            previewUrl: pickPreviewUrl(p),
            sampleUrl: p.sample_url || p.file_url,
            title: "",
            rating: p.rating,
            tags: p.tags,
            publishedAt: new Date(
              (p.change || Math.floor(Date.now() / 1000)) * 1000
            ),
            isViewed: false,
            isFavorited: false,
          }));

          await this.db.transaction(async (tx) => {
            await tx.insert(posts).values(postsToSave).onConflictDoNothing();

            await tx
              .update(artists)
              .set({
                lastPostId: currentHighestId,
                newPostsCount: sql`${artists.newPostsCount} + ${postsToSave.length}`,
                lastChecked: new Date(),
              })
              .where(eq(artists.id, artist.id));
          });

          totalAddedForArtist += postsToSave.length;
        }

        if (postsData.length < 100) {
          hasMore = false;
        } else {
          page++;
          await new Promise((r) => setTimeout(r, 500));
        }
      } catch (e) {
        logger.error(`Sync error for ${artist.name}:`, e);
        hasMore = false;
      }
    }

    if (totalAddedForArtist === 0) {
      await this.db
        .update(artists)
        .set({ lastChecked: new Date() })
        .where(eq(artists.id, artist.id));
    }

    logger.info(
      `Sync finished for ${artist.name}. Added: ${totalAddedForArtist}`
    );
  }
}

export const syncService = new SyncService();
</file>

<file path="src/main/bridge.ts">
import { contextBridge, ipcRenderer, IpcRendererEvent } from "electron";
import type { Artist, NewArtist, Post, Settings } from "./db/schema";
import { IPC_CHANNELS } from "./ipc/channels";

export type UpdateStatusData = {
  status: string;
  message?: string;
  version?: string;
  isPortable?: boolean;
};

export type UpdateStatusCallback = (data: UpdateStatusData) => void;
export type UpdateProgressCallback = (percent: number) => void;
export type SyncErrorCallback = (message: string) => void;

export type BackupResponse = {
  success: boolean;
  path?: string;
  error?: string;
};

export type DownloadProgressData = {
  id: string;
  percent: number;
};
export type DownloadProgressCallback = (data: DownloadProgressData) => void;

export interface PostQueryFilters {
  rating?: "s" | "q" | "e";
  tags?: string;
  sortBy?: "date" | "id" | "rating";
  isViewed?: boolean;
}

export interface GetPostsParams {
  artistId?: number;
  page?: number;
  filters?: PostQueryFilters;
}

export interface IpcBridge {
  // App
  getAppVersion: () => Promise<string>;

  writeToClipboard: (text: string) => Promise<boolean>;

  // Settings
  getSettings: () => Promise<Settings | undefined>;
  saveSettings: (creds: { userId: string; apiKey: string }) => Promise<boolean>;
  logout: () => Promise<void>;

  // Artists
  getTrackedArtists: () => Promise<Artist[]>;
  addArtist: (artist: NewArtist) => Promise<Artist | undefined>;
  deleteArtist: (id: number) => Promise<void>;

  // --- SEARCH ---
  searchArtists: (query: string) => Promise<{ id: number; label: string }[]>;

  // Posts
  getArtistPosts: (params: {
    artistId: number;
    page?: number;
    filters?: { tags?: string; rating?: string; isFavorited?: boolean };
  }) => Promise<Post[]>;
  getArtistPostsCount: (artistId?: number) => Promise<number>;
  updatePost: (id: number, changes: Partial<Post>) => Promise<void>;
  getRecentPostsRemote: (page: number, tags?: string) => Promise<Post[]>;
  togglePostViewed: (postId: number) => Promise<boolean>;

  resetPostCache: (postId: number) => Promise<boolean>;

  // External
  openExternal: (url: string) => Promise<void>;

  // Sync
  syncAll: () => Promise<boolean>;
  repairArtist: (artistId: number) => Promise<boolean>;

  // Updater
  checkForUpdates: () => Promise<void>;
  quitAndInstall: () => Promise<void>;
  startDownload: () => Promise<void>;

  onUpdateStatus: (callback: UpdateStatusCallback) => () => void;
  onUpdateProgress: (callback: UpdateProgressCallback) => () => void;

  onSyncStart: (callback: () => void) => () => void;
  onSyncEnd: (callback: () => void) => () => void;
  onSyncProgress: (callback: (message: string) => void) => () => void;
  onSyncError: (callback: SyncErrorCallback) => () => void;

  markPostAsViewed: (postId: number) => Promise<boolean>;

  togglePostFavorite: (postId: number) => Promise<boolean>;

  // Downloads
  downloadFile: (
    url: string,
    filename: string
  ) => Promise<{
    success: boolean;
    path?: string;
    error?: string;
    canceled?: boolean;
  }>;
  openFileInFolder: (path: string) => Promise<boolean>;

  onDownloadProgress: (callback: DownloadProgressCallback) => () => void;

  searchRemoteTags: (query: string) => Promise<{ id: string; label: string }[]>;

  createBackup: () => Promise<BackupResponse>;
  restoreBackup: () => Promise<BackupResponse>;

  verifyCredentials: () => Promise<boolean>;
}

const ipcBridge: IpcBridge = {
  getAppVersion: () => ipcRenderer.invoke("app:get-version"),

  writeToClipboard: (text) =>
    ipcRenderer.invoke("app:write-to-clipboard", text),

  searchRemoteTags: (query) =>
    ipcRenderer.invoke("api:search-remote-tags", query),

  verifyCredentials: () => ipcRenderer.invoke("app:verify-creds"),

  getSettings: () => ipcRenderer.invoke(IPC_CHANNELS.SETTINGS.GET),
  saveSettings: (creds) =>
    ipcRenderer.invoke(IPC_CHANNELS.SETTINGS.SAVE, creds),
  logout: () => ipcRenderer.invoke("app:logout"),

  getTrackedArtists: () => ipcRenderer.invoke("db:get-artists"),
  addArtist: (artist) => ipcRenderer.invoke("db:add-artist", artist),
  deleteArtist: (id) => ipcRenderer.invoke("db:delete-artist", id),

  searchArtists: (query) => ipcRenderer.invoke("db:search-tags", query),

  getArtistPosts: (params) =>
    ipcRenderer.invoke(IPC_CHANNELS.DB.GET_POSTS, params),
  getArtistPostsCount: (artistId?: number) =>
    ipcRenderer.invoke("db:get-posts-count", artistId),
  getRecentPostsRemote: (page, tags) =>
    ipcRenderer.invoke(IPC_CHANNELS.API.GET_RECENT_POSTS, { page, tags }),

  updatePost: (id, changes) =>
    ipcRenderer.invoke(IPC_CHANNELS.DB.UPDATE_POST, { id, changes }),

  openExternal: (url) => ipcRenderer.invoke("app:open-external", url),

  syncAll: () => ipcRenderer.invoke("db:sync-all"),

  markPostAsViewed: (postId) =>
    ipcRenderer.invoke("db:mark-post-viewed", postId),

  togglePostFavorite: (postId) =>
    ipcRenderer.invoke("db:toggle-post-favorite", postId),

  togglePostViewed: (postId) =>
    ipcRenderer.invoke("db:toggle-post-viewed", postId),

  resetPostCache: (postId) => ipcRenderer.invoke("db:reset-post-cache", postId),

  downloadFile: (url: string, filename: string) => {
    return ipcRenderer.invoke("files:download", url, filename);
  },

  openFileInFolder: (path: string) =>
    ipcRenderer.invoke("files:open-folder", path),

  onDownloadProgress: (callback) => {
    const channel = "files:download-progress";
    const subscription = (_: IpcRendererEvent, data: DownloadProgressData) =>
      callback(data);

    ipcRenderer.on(channel, subscription);
    return () => {
      ipcRenderer.removeListener(channel, subscription);
    };
  },

  repairArtist: (artistId) =>
    ipcRenderer.invoke("sync:repair-artist", artistId),

  checkForUpdates: () => ipcRenderer.invoke("app:check-for-updates"),
  quitAndInstall: () => ipcRenderer.invoke("app:quit-and-install"),
  startDownload: () => ipcRenderer.invoke("app:start-download"),

  onUpdateStatus: (callback) => {
    const subscription = (_: IpcRendererEvent, data: UpdateStatusData) =>
      callback(data);
    ipcRenderer.on("updater:status", subscription);
    return () => {
      ipcRenderer.removeListener("updater:status", subscription);
    };
  },

  onUpdateProgress: (callback) => {
    const subscription = (_: IpcRendererEvent, percent: number) =>
      callback(percent);
    ipcRenderer.on("updater:progress", subscription);
    return () => {
      ipcRenderer.removeListener("updater:progress", subscription);
    };
  },

  onSyncStart: (callback) => {
    const sub = () => callback();
    ipcRenderer.on("sync:start", sub);
    return () => ipcRenderer.removeListener("sync:start", sub);
  },

  onSyncEnd: (callback) => {
    const sub = () => callback();
    ipcRenderer.on("sync:end", sub);
    return () => ipcRenderer.removeListener("sync:end", sub);
  },

  onSyncError: (callback) => {
    const subscription = (_: IpcRendererEvent, msg: string) => callback(msg);
    ipcRenderer.on("sync:error", subscription);
    return () => {
      ipcRenderer.removeListener("sync:error", subscription);
    };
  },

  onSyncProgress: (callback) => {
    const sub = (_: IpcRendererEvent, msg: string) => callback(msg);
    ipcRenderer.on("sync:progress", sub);
    return () => ipcRenderer.removeListener("sync:progress", sub);
  },

  createBackup: () => ipcRenderer.invoke("db:create-backup"),
  restoreBackup: () => ipcRenderer.invoke("db:restore-backup"),
};

contextBridge.exposeInMainWorld("api", ipcBridge);
</file>

<file path="src/main/main.ts">
import { app, BrowserWindow } from "electron";
import path from "path";
import { mkdirSync, promises as fs } from "fs";
import { registerAllHandlers } from "./ipc/index";
import { initializeDatabase } from "./db"; // –¢–æ–ª—å–∫–æ –ø—Ä—è–º–∞—è –±–∞–∑–∞
import { logger } from "./lib/logger";
import { updaterService } from "./services/updater-service";
import { syncService } from "./services/sync-service";

// === PORTABLE MODE LOGIC ===
if (app.isPackaged) {
  const portableDataPath = path.join(path.dirname(process.execPath), "data");
  try {
    mkdirSync(portableDataPath, { recursive: true });
    app.setPath("userData", portableDataPath);
  } catch (e) {
    console.error("PORTABLE MODE: Failed to init data folder.", e);
  }
}

logger.info("üöÄ Application starting...");

// Migration Logic
async function migrateUserData() {
  try {
    const oldUserDataPath = path.join(
      app.getPath("appData"),
      "NSFW Booru Client"
    );
    const newUserDataPath = path.join(app.getPath("appData"), "RuleDesk");
    try {
      await fs.access(oldUserDataPath);
      await fs.mkdir(newUserDataPath, { recursive: true });
      await fs.copyFile(
        path.join(oldUserDataPath, "metadata.db"),
        path.join(newUserDataPath, "metadata.db")
      );
    } catch {
      // New folder doesn't exist, which is what we want.
    }
  } catch (err) {
    logger.error("Migration error:", err);
  }
}
migrateUserData();

let mainWindow: BrowserWindow | null = null;
let DB_PATH: string;
let areHandlersRegistered = false;

const gotTheLock = app.requestSingleInstanceLock();

if (!gotTheLock) {
  app.quit();
} else {
  app.on("second-instance", () => {
    if (mainWindow) {
      if (mainWindow.isMinimized()) mainWindow.restore();
      mainWindow.focus();
    }
  });
  app.on("ready", initializeAppAndWindow);
}

async function initializeAppAndWindow() {
  try {
    DB_PATH = path.join(app.getPath("userData"), "metadata.db");

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–û–õ–¨–ö–û –ü–†–Ø–ú–û–ô –ë–î ===
    initializeDatabase(DB_PATH);
    logger.info("‚úÖ Main: Direct DB instance initialized.");

    mainWindow = new BrowserWindow({
      width: 1200,
      height: 800,
      minWidth: 800,
      minHeight: 600,
      show: false,
      title: "RuleDesk",
      webPreferences: {
        contextIsolation: true,
        nodeIntegration: false,
        preload: path.join(__dirname, "../preload/bridge.cjs"),
        sandbox: true,
      },
    });

    updaterService.setWindow(mainWindow);
    syncService.setWindow(mainWindow);

    if (!areHandlersRegistered) {
      registerAllHandlers(syncService, updaterService, mainWindow);
      areHandlersRegistered = true;
      logger.info("IPC: Handlers registered.");
    } else {
      logger.info("IPC: Handlers already registered, skipping.");
    }

    if (process.env["ELECTRON_RENDERER_URL"]) {
      mainWindow.loadURL(process.env["ELECTRON_RENDERER_URL"]);
    } else {
      mainWindow.loadFile(path.join(__dirname, "../renderer/index.html"));
    }

    if (process.env.NODE_ENV === "development") {
      mainWindow.webContents.openDevTools();
    }

    mainWindow.once("ready-to-show", () => {
      if (mainWindow) {
        mainWindow.show();
        updaterService.checkForUpdates();
        setTimeout(() => {
          logger.info("Main: App Ready.");
        }, 3000);
      }
    });

    mainWindow.on("closed", () => {
      mainWindow = null;
    });
  } catch (e) {
    logger.error("FATAL: Init failed", e);
    app.exit(1);
  }
}

app.on("window-all-closed", () => {
  if (process.platform !== "darwin") app.quit();
});

app.on("activate", () => {
  if (BrowserWindow.getAllWindows().length === 0) initializeAppAndWindow();
});
</file>

<file path="package.json">
{
  "name": "ruledesk",
  "productName": "RuleDesk",
  "version": "1.4.1",
  "description": "A modern desktop client for Rule34 imageboard content",
  "main": "out/main/main.cjs",
  "type": "module",
  "repository": {
    "type": "git",
    "url": "https://github.com/KazeKaze93/ruledesk.git"
  },
  "scripts": {
    "dev": "chcp 65001 && electron-vite dev",
    "build": "electron-vite build",
    "preview": "electron-vite preview",
    "db:migrate": "ts-node src/main/db/migrate.ts",
    "db:generate": "drizzle-kit generate:sqlite",
    "db:studio": "drizzle-kit studio",
    "typecheck": "tsc --noEmit",
    "postinstall": "electron-builder install-app-deps",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "validate": "npm run typecheck && npm run lint",
    "dist": "npm run build && electron-builder",
    "release:minor": "npm version minor && git push --follow-tags",
    "release:patch": "npm version patch && git push --follow-tags",
    "release:major": "npm version major && git push --follow-tags",
    "ctx:update": "npx ts-node scripts/generate-tree.ts",
    "ctx:gen": "npm run ctx:update && npx ts-node scripts/gen-gemini-prompt.ts"
  },
  "keywords": [
    "electron",
    "react",
    "typescript",
    "booru",
    "desktop"
  ],
  "author": "",
  "license": "MIT",
  "devDependencies": {
    "@electron/rebuild": "^4.0.2",
    "@eslint/js": "^9.39.1",
    "@types/better-sqlite3": "^7.6.13",
    "@types/node": "^20.10.0",
    "@types/react": "^18.2.45",
    "@types/react-dom": "^18.2.18",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "drizzle-kit": "^0.20.6",
    "electron": "^28.0.0",
    "electron-builder": "^24.13.3",
    "electron-vite": "^2.0.0",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.4.32",
    "tailwindcss": "^3.4.0",
    "tailwindcss-animate": "^1.0.7",
    "typescript": "^5.3.3",
    "typescript-eslint": "^8.49.0",
    "vite": "^5.0.8"
  },
  "dependencies": {
    "@headlessui/react": "^2.2.9",
    "@heroicons/react": "^2.2.0",
    "@hookform/resolvers": "^5.2.2",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-icons": "^1.3.2",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-progress": "^1.1.8",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-tabs": "^1.1.13",
    "@tanstack/react-query": "^5.17.0",
    "axios": "^1.13.2",
    "better-sqlite3": "^9.2.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "drizzle-orm": "^0.29.3",
    "electron-log": "^5.4.3",
    "electron-updater": "^6.6.2",
    "i18next": "^25.7.2",
    "i18next-browser-languagedetector": "^8.2.0",
    "lucide-react": "^0.560.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-hook-form": "^7.68.0",
    "react-i18next": "^16.5.0",
    "react-router-dom": "^7.10.1",
    "react-virtuoso": "^4.17.0",
    "repomix": "^1.10.2",
    "tailwind-merge": "^2.6.0",
    "zod": "^3.25.76",
    "zustand": "^4.5.7"
  },
  "build": {
    "appId": "com.kaze.ruledesk",
    "productName": "RuleDesk",
    "directories": {
      "output": "release"
    },
    "files": [
      "out/**/*",
      "!**/.env",
      "package.json",
      "!**/settings.json",
      "!**/*.log",
      "!**/*.db",
      "!**/*.db-journal",
      "!**/*.map",
      "!**/scripts/**",
      "!**/.github/**",
      "!**/*.ts",
      "!**/*.tsx",
      "!vite.config.ts",
      "!electron.vite.config.ts",
      "!tailwind.config.js",
      "!postcss.config.js",
      "!drizzle.config.ts",
      "!**/tsconfig.json",
      "!**/.eslintrc*",
      "!**/.vscode",
      "drizzle/**",
      "!**/.gitattributes",
      "!.cursorrules",
      "!**/.ai/**",
      "!**/scripts/**",
      "!**/repomix.config.json",
      "!**/.cursorrules",
      "!**/repomix-output.*"
    ],
    "extraFiles": [],
    "extraResources": [
      {
        "from": "drizzle",
        "to": "drizzle"
      }
    ],
    "asar": true,
    "publish": {
      "provider": "github",
      "owner": "KazeKaze93",
      "repo": "ruledesk",
      "releaseType": "draft"
    },
    "win": {
      "target": [
        {
          "target": "nsis",
          "arch": [
            "x64"
          ]
        },
        {
          "target": "portable",
          "arch": [
            "x64"
          ]
        }
      ],
      "artifactName": "RuleDesk-Setup-${version}.${ext}",
      "icon": "resources/icon.ico"
    },
    "portable": {
      "artifactName": "RuleDesk-Portable-${version}.exe",
      "requestExecutionLevel": "user"
    },
    "mac": {
      "target": "dmg"
    },
    "linux": {
      "target": "AppImage"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "perMachine": false,
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "deleteAppDataOnUninstall": false
    },
    "asarUnpack": [
      "**/node_modules/better-sqlite3/**"
    ]
  }
}
</file>

</files>
